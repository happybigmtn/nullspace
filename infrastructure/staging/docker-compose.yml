# Nullspace Testnet Staging Infrastructure
# Domain: testnet.regenesis.dev
#
# Usage:
#   docker-compose up -d
#
# Prerequisites:
#   - Docker and Docker Compose installed
#   - DNS records pointing to this server (see DNS_RECORDS.md)
#   - Environment files in /etc/nullspace/

version: "3.8"

services:
  # Caddy reverse proxy with automatic HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: nullspace-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - /var/log/caddy:/var/log/caddy
    networks:
      - nullspace
    depends_on:
      - website
      - gateway
      - auth
      - simulator

  # Simulator/Indexer
  simulator:
    image: ghcr.io/happybigmtn/nullspace-simulator:latest
    container_name: nullspace-simulator
    restart: unless-stopped
    env_file:
      - /etc/nullspace/simulator.env
    volumes:
      - simulator_data:/data
    networks:
      - nullspace
    expose:
      - "8080"

  # Validator nodes (can be scaled or run on separate hosts)
  node1:
    image: ghcr.io/happybigmtn/nullspace-node:latest
    container_name: nullspace-node-1
    restart: unless-stopped
    env_file:
      - /etc/nullspace/node.env
    environment:
      - NODE_ID=1
    volumes:
      - node1_data:/data
    networks:
      - nullspace
    expose:
      - "9001"
      - "9100"

  node2:
    image: ghcr.io/happybigmtn/nullspace-node:latest
    container_name: nullspace-node-2
    restart: unless-stopped
    env_file:
      - /etc/nullspace/node.env
    environment:
      - NODE_ID=2
    volumes:
      - node2_data:/data
    networks:
      - nullspace
    expose:
      - "9001"
      - "9100"

  node3:
    image: ghcr.io/happybigmtn/nullspace-node:latest
    container_name: nullspace-node-3
    restart: unless-stopped
    env_file:
      - /etc/nullspace/node.env
    environment:
      - NODE_ID=3
    volumes:
      - node3_data:/data
    networks:
      - nullspace
    expose:
      - "9001"
      - "9100"

  # Gateway (WebSocket + API)
  gateway:
    image: ghcr.io/happybigmtn/nullspace-gateway:latest
    container_name: nullspace-gateway
    restart: unless-stopped
    env_file:
      - /etc/nullspace/gateway.env
    volumes:
      - gateway_data:/data
    networks:
      - nullspace
    expose:
      - "9010"
    depends_on:
      - simulator
      - node1
      - node2
      - node3

  # Auth service
  auth:
    image: ghcr.io/happybigmtn/nullspace-auth:latest
    container_name: nullspace-auth
    restart: unless-stopped
    env_file:
      - /etc/nullspace/auth.env
    networks:
      - nullspace
    expose:
      - "4000"

  # Website
  website:
    image: ghcr.io/happybigmtn/nullspace-website:latest
    container_name: nullspace-website
    restart: unless-stopped
    networks:
      - nullspace
    expose:
      - "80"

networks:
  nullspace:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  simulator_data:
  node1_data:
  node2_data:
  node3_data:
  gateway_data:
