# Nullspace Testnet Staging - Caddy Reverse Proxy
# Domain: regenesis.dev
# Automatic HTTPS via Let's Encrypt

# Main website
testnet.regenesis.dev {
    reverse_proxy nullspace-website:80

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    log {
        output file /var/log/caddy/website.log
        format json
    }
}

# Auth service
# NOTE: CORS headers are handled by the upstream auth service.
# The auth service sets Access-Control-Allow-Origin to the specific origin
# and Access-Control-Allow-Credentials: true, which is required for
# cookie-based authentication. Do NOT override with Access-Control-Allow-Origin "*"
# as browsers reject credentials with wildcard origins.
auth.testnet.regenesis.dev {
    reverse_proxy nullspace-auth:4000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
    }

    log {
        output file /var/log/caddy/auth.log
        format json
    }
}

# Gateway (WebSocket + HTTP API)
# NOTE: CORS headers are handled by the upstream gateway service.
# The gateway validates origins against GATEWAY_ALLOWED_ORIGINS and sets
# Access-Control-Allow-Origin to the specific origin. Do NOT override
# with wildcard as it would break origin validation.
api.testnet.regenesis.dev {
    reverse_proxy nullspace-gateway:9010

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
    }

    log {
        output file /var/log/caddy/gateway.log
        format json
    }
}

# Indexer/Simulator API
# NOTE: CORS headers are handled by the upstream simulator service via
# ALLOWED_HTTP_ORIGINS. Do NOT override as it would bypass origin validation.
indexer.testnet.regenesis.dev {
    reverse_proxy nullspace-simulator:8080

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
    }

    log {
        output file /var/log/caddy/indexer.log
        format json
    }
}

# Health check endpoint (internal)
:8080 {
    respond /health "OK" 200
}
