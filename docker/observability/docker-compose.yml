version: "3.9"

services:
  prometheus:
    image: prom/prometheus:v2.51.2
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver"  # Enable remote write for Tempo metrics
    environment:
      METRICS_AUTH_TOKEN: ${METRICS_AUTH_TOKEN:-}
      SIMULATOR_METRICS_TARGET: ${SIMULATOR_METRICS_TARGET:-host.docker.internal:8080}
      AUTH_METRICS_TARGET: ${AUTH_METRICS_TARGET:-host.docker.internal:4000}
      GATEWAY_METRICS_TARGET: ${GATEWAY_METRICS_TARGET:-host.docker.internal:9010}
      NODE_METRICS_TARGET_0: ${NODE_METRICS_TARGET_0:-host.docker.internal:9100}
      NODE_METRICS_TARGET_1: ${NODE_METRICS_TARGET_1:-host.docker.internal:9101}
      NODE_METRICS_TARGET_2: ${NODE_METRICS_TARGET_2:-host.docker.internal:9102}
      NODE_METRICS_TARGET_3: ${NODE_METRICS_TARGET_3:-host.docker.internal:9103}
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./metrics_auth_token:/etc/prometheus/metrics_auth_token:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"

  alertmanager:
    image: prom/alertmanager:v0.27.0
    environment:
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      PAGERDUTY_SERVICE_KEY: ${PAGERDUTY_SERVICE_KEY:-}
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

  # Tempo - Distributed tracing backend
  tempo:
    image: grafana/tempo:2.4.1
    command: ["-config.file=/etc/tempo/tempo.yml"]
    ports:
      - "3200:3200"   # Tempo HTTP API
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    volumes:
      - ./tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo-data:/tmp/tempo
    depends_on:
      - prometheus

  loki:
    image: grafana/loki:2.9.4
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./loki.yml:/etc/loki/config.yml:ro

  promtail:
    image: grafana/promtail:2.9.4
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./promtail.yml:/etc/promtail/config.yml:ro
      - ../..:/var/log/nullspace:ro
    depends_on:
      - loki

  grafana:
    image: grafana/grafana-oss:10.4.2
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      # Enable trace to logs correlation
      - GF_FEATURE_TOGGLES_ENABLE=traceToLogs,traceToMetrics
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - loki
      - tempo

volumes:
  tempo-data:
