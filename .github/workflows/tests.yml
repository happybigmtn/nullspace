name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  CARGO_TERM_COLOR: always
  UDEPS_VERSION: 0.1.57
  NIGHTLY_VERSION: nightly-2025-08-10
  NODE_VERSION: 20
  PNPM_VERSION: 9.15.0

jobs:
  All:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Lint
      run: cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee /tmp/rust-clippy.log
    - name: Check for panics/unwraps
      run: ./scripts/check-no-panics.sh 2>&1 | tee /tmp/rust-panics.log
    - name: Fmt
      run: cargo fmt --all -- --check 2>&1 | tee /tmp/rust-fmt.log
    - name: Check docs
      run: cargo doc --no-deps --document-private-items
      env:
        RUSTDOCFLAGS: "-D warnings"
    - name: Run tests (retry once)
      run: |
        set -e
        if cargo test --verbose 2>&1 | tee /tmp/rust-tests.log; then
          exit 0
        fi
        echo "first_attempt_failed=true" >> /tmp/rust-tests.meta
        cargo test --verbose 2>&1 | tee -a /tmp/rust-tests.log
    - name: Upload rust logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rust-all-logs
        path: |
          /tmp/rust-*.log
          /tmp/rust-*.meta

  Javascript:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Run JS/TS tests (retry once)
      run: |
        set -e
        if pnpm test 2>&1 | tee /tmp/js-tests.log; then
          exit 0
        fi
        echo "first_attempt_failed=true" >> /tmp/js-tests.meta
        pnpm test 2>&1 | tee -a /tmp/js-tests.log

    - name: Enforce coverage threshold
      run: node scripts/coverage-all.mjs --skip-rust --fail-under=70

    - name: Upload JS test logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: js-tests-logs
        path: /tmp/js-tests.log
    - name: Upload JS flake marker
      if: success() && hashFiles('/tmp/js-tests.meta') != ''
      uses: actions/upload-artifact@v4
      with:
        name: js-tests-flaky
        path: /tmp/js-tests.meta

  GatewayIntegration:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Build simulator/node binaries
      run: cargo build --release -p nullspace-simulator -p nullspace-node
    - name: Start local network
      run: |
        ./scripts/start-local-network.sh configs/local 1 --no-build > /tmp/localnet.log 2>&1 &
        echo $! > /tmp/localnet.pid
        for i in {1..60}; do
          if curl -sf http://localhost:8080/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Simulator failed to start" >&2
        cat /tmp/localnet.log || true
        exit 1
    - name: Start gateway
      run: |
        pnpm -C gateway start > /tmp/gateway.log 2>&1 &
        echo $! > /tmp/gateway.pid
        for i in {1..30}; do
          if curl -sf http://localhost:9010/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Gateway failed to start" >&2
        cat /tmp/gateway.log || true
        exit 1
    - name: Run gateway integration tests
      run: |
        set -e
        if pnpm -C gateway test:integration 2>&1 | tee /tmp/gateway-integration.log; then
          exit 0
        fi
        echo "first_attempt_failed=true" >> /tmp/gateway-integration.meta
        pnpm -C gateway test:integration 2>&1 | tee -a /tmp/gateway-integration.log
    - name: Stop services
      if: always()
      run: |
        if [ -f /tmp/gateway.pid ]; then
          kill $(cat /tmp/gateway.pid) 2>/dev/null || true
        fi
        if [ -f /tmp/localnet.pid ]; then
          kill $(cat /tmp/localnet.pid) 2>/dev/null || true
        fi

    - name: Upload integration logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: gateway-integration-logs
        path: |
          /tmp/gateway-integration.log
          /tmp/gateway.log
          /tmp/localnet.log
    - name: Upload integration flake marker
      if: success() && hashFiles('/tmp/gateway-integration.meta') != ''
      uses: actions/upload-artifact@v4
      with:
        name: gateway-integration-flaky
        path: /tmp/gateway-integration.meta

  GatewayStress:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Start gateway (mock mode)
      run: |
        # Create minimal mock backend for stress test
        cat > /tmp/mock-backend.mjs << 'EOF'
        import { createServer } from 'http';
        const http = createServer((req, res) => {
          if (req.url === '/healthz') { res.writeHead(200); res.end('OK'); }
          else { res.writeHead(404); res.end(); }
        });
        http.listen(8080, () => console.log('Mock backend on :8080'));
        EOF
        node /tmp/mock-backend.mjs &
        echo $! > /tmp/mock.pid
        sleep 2
    - name: Start gateway
      run: |
        pnpm -C gateway start > /tmp/gateway.log 2>&1 &
        echo $! > /tmp/gateway.pid
        for i in {1..30}; do
          if curl -sf http://localhost:9010/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Gateway failed to start" >&2
        cat /tmp/gateway.log || true
        exit 1
    - name: Run stress tests (CI mode - 100 connections)
      run: |
        set -e
        if pnpm -C gateway test:stress:ci 2>&1 | tee /tmp/gateway-stress.log; then
          exit 0
        fi
        echo "first_attempt_failed=true" >> /tmp/gateway-stress.meta
        pnpm -C gateway test:stress:ci 2>&1 | tee -a /tmp/gateway-stress.log
    - name: Stop services
      if: always()
      run: |
        if [ -f /tmp/gateway.pid ]; then kill $(cat /tmp/gateway.pid) 2>/dev/null || true; fi
        if [ -f /tmp/mock.pid ]; then kill $(cat /tmp/mock.pid) 2>/dev/null || true; fi

    - name: Upload stress logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: gateway-stress-logs
        path: |
          /tmp/gateway-stress.log
          /tmp/gateway.log
          /tmp/mock.pid
    - name: Upload stress flake marker
      if: success() && hashFiles('/tmp/gateway-stress.meta') != ''
      uses: actions/upload-artifact@v4
      with:
        name: gateway-stress-flaky
        path: /tmp/gateway-stress.meta

  Dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install nightly Rust toolchain
      run: rustup toolchain install ${{ env.NIGHTLY_VERSION }}
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc +${{ env.NIGHTLY_VERSION }} --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Cache cargo-udeps
      id: cargo-udeps-cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-udeps
        key: ${{ runner.os }}-${{ env.UDEPS_VERSION }}-cargo-udeps-${{ steps.rust-version.outputs.rust_version }}
    - name: Install cargo-udeps
      if: steps.cargo-udeps-cache.outputs.cache-hit != 'true'
      run: cargo +${{ env.NIGHTLY_VERSION }} install cargo-udeps --version ${{ env.UDEPS_VERSION }}
    - name: Check for unused dependencies
      run: cargo +${{ env.NIGHTLY_VERSION }} udeps --all-targets

  Security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Cache cargo-audit
      id: cargo-audit-cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-audit
        key: ${{ runner.os }}-cargo-audit-0.21
    - name: Install cargo-audit
      if: steps.cargo-audit-cache.outputs.cache-hit != 'true'
      run: cargo install cargo-audit --version 0.21.0
    - name: Run security audit (fail on vulnerabilities)
      run: cargo audit

  SecurityNode:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          services/auth/package-lock.json
          website/package-lock.json
    - name: Install auth dependencies
      run: cd services/auth && npm ci
    - name: Audit auth dependencies (fail on high/critical)
      run: cd services/auth && npm audit --omit=dev --audit-level=high
    - name: Install website dependencies
      run: cd website && npm ci
    - name: Audit website dependencies (fail on high/critical)
      run: cd website && npm audit --omit=dev --audit-level=high

  SecretScanning:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_ENABLE_COMMENTS: false

  SAST:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run Semgrep (auto)
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/ci
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  ContainerScan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Trivy filesystem scan
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: fs
        ignore-unfixed: true
        severity: HIGH,CRITICAL
        exit-code: 0

  React:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: website/package-lock.json
    - name: Install dependencies
      run: cd website && npm ci
    - name: Install Chromium
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser
        echo "PW_CHROMIUM_PATH=/usr/bin/chromium-browser" >> $GITHUB_ENV
    - name: Test compilation
      run: cd website && npm run build
    - name: Check bundle sizes (US-145)
      run: cd website && node scripts/check-bundle-sizes.mjs
    - name: Perf budget (Lighthouse-lite)
      env:
        PW_CHROMIUM_PATH: /usr/bin/chromium-browser
      run: cd website && npm run perf:budget
    - name: Test website (retry once)
      run: |
        set -e
        cd website
        if npm run test 2>&1 | tee /tmp/website-tests.log; then
          exit 0
        fi
        echo "first_attempt_failed=true" >> /tmp/website-tests.meta
        npm run test 2>&1 | tee -a /tmp/website-tests.log

    - name: Upload website test logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: website-tests-logs
        path: /tmp/website-tests.log
    - name: Upload website flake marker
      if: success() && hashFiles('/tmp/website-tests.meta') != ''
      uses: actions/upload-artifact@v4
      with:
        name: website-tests-flaky
        path: /tmp/website-tests.meta

  FlakeReport:
    runs-on: ubuntu-latest
    needs:
      - All
      - Javascript
      - GatewayIntegration
      - GatewayStress
      - React
      - ProtocolFuzz
    if: always()
    steps:
      - name: Download flake markers
        uses: actions/download-artifact@v4
        with:
          pattern: "*-flaky"
          merge-multiple: true
        continue-on-error: true

      - name: Summarize flakes
        run: |
          set -e
          if ls *.meta >/dev/null 2>&1; then
            echo "### Flaky tests detected (retry passed)" >> $GITHUB_STEP_SUMMARY
            for f in *.meta; do
              echo "- ${f%.meta}" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No flaky markers found" >> $GITHUB_STEP_SUMMARY
          fi

  ProtocolFuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Run protocol fuzz tests (CI mode - 1000 iterations)
      run: CI=true pnpm -C packages/protocol test fuzz.test.ts 2>&1 | tee /tmp/protocol-fuzz.log

    - name: Upload fuzz logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: protocol-fuzz-logs
        path: /tmp/protocol-fuzz.log

  Lock:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Build entire workspace
      run: cargo build --workspace --all-targets
    - name: Check Cargo.lock unchanged
      run: |
        if ! git diff --exit-code Cargo.lock; then
          echo "ERROR: Cargo.lock was modified during build!"
          echo "This suggests that the Cargo.lock file in the repository is not up to date."
          echo "Please run 'cargo build' locally and commit the updated Cargo.lock."
          exit 1
        fi
        echo "âœ“ Cargo.lock remained unchanged after building everything"
