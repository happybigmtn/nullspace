name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  CARGO_TERM_COLOR: always
  UDEPS_VERSION: 0.1.57
  NIGHTLY_VERSION: nightly-2025-08-10
  NODE_VERSION: 20
  PNPM_VERSION: 9.15.0

jobs:
  All:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Lint
      run: cargo clippy --all-targets --all-features -- -D warnings
    - name: Check for panics/unwraps
      run: ./scripts/check-no-panics.sh
    - name: Fmt
      run: cargo fmt --all -- --check
    - name: Check docs
      run: cargo doc --no-deps --document-private-items
      env:
        RUSTDOCFLAGS: "-D warnings"
    - name: Run tests
      run: cargo test --verbose

  Javascript:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Run JS/TS tests
      run: pnpm test

  GatewayIntegration:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Build simulator/node binaries
      run: cargo build --release -p nullspace-simulator -p nullspace-node
    - name: Start local network
      run: |
        ./scripts/start-local-network.sh configs/local 1 --no-build > /tmp/localnet.log 2>&1 &
        echo $! > /tmp/localnet.pid
        for i in {1..60}; do
          if curl -sf http://localhost:8080/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Simulator failed to start" >&2
        cat /tmp/localnet.log || true
        exit 1
    - name: Start gateway
      run: |
        pnpm -C gateway start > /tmp/gateway.log 2>&1 &
        echo $! > /tmp/gateway.pid
        for i in {1..30}; do
          if curl -sf http://localhost:9010/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Gateway failed to start" >&2
        cat /tmp/gateway.log || true
        exit 1
    - name: Run gateway integration tests
      run: pnpm -C gateway test:integration
    - name: Stop services
      if: always()
      run: |
        if [ -f /tmp/gateway.pid ]; then
          kill $(cat /tmp/gateway.pid) 2>/dev/null || true
        fi
        if [ -f /tmp/localnet.pid ]; then
          kill $(cat /tmp/localnet.pid) 2>/dev/null || true
        fi

  GatewayStress:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Start gateway (mock mode)
      run: |
        # Create minimal mock backend for stress test
        cat > /tmp/mock-backend.mjs << 'EOF'
        import { createServer } from 'http';
        const http = createServer((req, res) => {
          if (req.url === '/healthz') { res.writeHead(200); res.end('OK'); }
          else { res.writeHead(404); res.end(); }
        });
        http.listen(8080, () => console.log('Mock backend on :8080'));
        EOF
        node /tmp/mock-backend.mjs &
        echo $! > /tmp/mock.pid
        sleep 2
    - name: Start gateway
      run: |
        pnpm -C gateway start > /tmp/gateway.log 2>&1 &
        echo $! > /tmp/gateway.pid
        for i in {1..30}; do
          if curl -sf http://localhost:9010/healthz > /dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Gateway failed to start" >&2
        cat /tmp/gateway.log || true
        exit 1
    - name: Run stress tests (CI mode - 100 connections)
      run: pnpm -C gateway test:stress:ci
    - name: Stop services
      if: always()
      run: |
        if [ -f /tmp/gateway.pid ]; then kill $(cat /tmp/gateway.pid) 2>/dev/null || true; fi
        if [ -f /tmp/mock.pid ]; then kill $(cat /tmp/mock.pid) 2>/dev/null || true; fi

  Dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install nightly Rust toolchain
      run: rustup toolchain install ${{ env.NIGHTLY_VERSION }}
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc +${{ env.NIGHTLY_VERSION }} --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Cache cargo-udeps
      id: cargo-udeps-cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-udeps
        key: ${{ runner.os }}-${{ env.UDEPS_VERSION }}-cargo-udeps-${{ steps.rust-version.outputs.rust_version }}
    - name: Install cargo-udeps
      if: steps.cargo-udeps-cache.outputs.cache-hit != 'true'
      run: cargo +${{ env.NIGHTLY_VERSION }} install cargo-udeps --version ${{ env.UDEPS_VERSION }}
    - name: Check for unused dependencies
      run: cargo +${{ env.NIGHTLY_VERSION }} udeps --all-targets

  Security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Cache cargo-audit
      id: cargo-audit-cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-audit
        key: ${{ runner.os }}-cargo-audit-0.21
    - name: Install cargo-audit
      if: steps.cargo-audit-cache.outputs.cache-hit != 'true'
      run: cargo install cargo-audit --version 0.21.0
    - name: Run security audit
      run: cargo audit

  SecurityNode:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          services/auth/package-lock.json
          website/package-lock.json
    - name: Install auth dependencies
      run: cd services/auth && npm ci
    - name: Audit auth dependencies
      run: cd services/auth && npm audit --omit=dev --audit-level=high
      continue-on-error: true
    - name: Install website dependencies
      run: cd website && npm ci
    - name: Audit website dependencies
      run: cd website && npm audit --omit=dev --audit-level=high
      continue-on-error: true

  SecretScanning:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_ENABLE_COMMENTS: false

  SAST:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run Semgrep (auto)
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/ci
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  ContainerScan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Trivy filesystem scan
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: fs
        ignore-unfixed: true
        severity: HIGH,CRITICAL
        exit-code: 0

  React:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Get Rust version
      id: rust-version
      run: echo "rust_version=$(rustc --version)" >> "$GITHUB_OUTPUT"
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: website/package-lock.json
    - name: Install dependencies
      run: cd website && npm ci
    - name: Test compilation
      run: cd website && npm run build
    - name: Check bundle sizes (US-145)
      run: cd website && node scripts/check-bundle-sizes.mjs
    - name: Test website
      run: cd website && npm run test

  ProtocolFuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        run_install: false
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Run protocol fuzz tests (CI mode - 1000 iterations)
      run: CI=true pnpm -C packages/protocol test fuzz.test.ts

  Lock:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Run setup
      uses: ./.github/actions/setup
    - name: Build entire workspace
      run: cargo build --workspace --all-targets
    - name: Check Cargo.lock unchanged
      run: |
        if ! git diff --exit-code Cargo.lock; then
          echo "ERROR: Cargo.lock was modified during build!"
          echo "This suggests that the Cargo.lock file in the repository is not up to date."
          echo "Please run 'cargo build' locally and commit the updated Cargo.lock."
          exit 1
        fi
        echo "âœ“ Cargo.lock remained unchanged after building everything"
