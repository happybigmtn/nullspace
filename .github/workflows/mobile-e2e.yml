name: Mobile E2E Tests

on:
  pull_request:
    paths:
      - 'mobile/**'
      - 'packages/**'
      - 'gateway/**'
      - '.github/workflows/mobile-e2e.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test (ios, android, or both)'
        required: false
        default: 'both'

env:
  NODE_VERSION: 20
  PNPM_VERSION: 9.15.0
  JAVA_VERSION: 17

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build and test on iOS simulator
  ios:
    name: iOS E2E Tests
    runs-on: macos-14
    if: github.event.inputs.platform != 'android'
    timeout-minutes: 60
    env:
      DETOX_CONFIGURATION: ios.sim.debug

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        working-directory: mobile
        run: |
          npx expo prebuild --platform ios --clean
          cd ios && pod install

      - name: Cache Detox build
        uses: actions/cache@v4
        with:
          path: mobile/ios/build
          key: ${{ runner.os }}-detox-ios-${{ hashFiles('mobile/ios/**/*.m', 'mobile/ios/**/*.swift', 'mobile/src/**/*.ts', 'mobile/src/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-detox-ios-

      - name: Build iOS app for Detox
        working-directory: mobile
        run: npx detox build --configuration ${{ env.DETOX_CONFIGURATION }}

      - name: Boot iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices available
          # Boot iPhone 15 simulator
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
          if [ -z "$DEVICE_ID" ]; then
            # Create iPhone 15 if not available
            DEVICE_ID=$(xcrun simctl create "iPhone 15" "com.apple.CoreSimulator.SimDeviceType.iPhone-15" "com.apple.CoreSimulator.SimRuntime.iOS-17-5")
          fi
          xcrun simctl boot "$DEVICE_ID" || true
          echo "SIMULATOR_DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV

      - name: Start mock backend
        run: |
          # Create minimal mock server for E2E tests
          cat > /tmp/mock-server.mjs << 'EOF'
          import { WebSocketServer } from 'ws';
          import { createServer } from 'http';

          const http = createServer((req, res) => {
            if (req.url === '/healthz') {
              res.writeHead(200);
              res.end('OK');
            } else {
              res.writeHead(404);
              res.end();
            }
          });

          const wss = new WebSocketServer({ server: http });

          // Mock balance for E2E tests
          const MOCK_BALANCE = 10000n;

          wss.on('connection', (ws) => {
            console.log('E2E client connected');

            // Send initial balance
            ws.send(JSON.stringify({
              type: 'balance',
              balance: MOCK_BALANCE.toString()
            }));

            ws.on('message', (data) => {
              try {
                const msg = JSON.parse(data);
                console.log('Received:', msg.type);

                // Mock responses for E2E tests
                if (msg.type === 'authenticate') {
                  ws.send(JSON.stringify({
                    type: 'authenticated',
                    balance: MOCK_BALANCE.toString()
                  }));
                } else if (msg.type === 'join_game') {
                  ws.send(JSON.stringify({
                    type: 'game_joined',
                    gameId: msg.gameId,
                    state: null
                  }));
                } else if (msg.type === 'place_bet') {
                  // Mock game result
                  ws.send(JSON.stringify({
                    type: 'game_result',
                    won: Math.random() > 0.5,
                    payout: msg.amount * 2,
                    newBalance: (MOCK_BALANCE - BigInt(msg.amount) + BigInt(msg.amount * 2)).toString()
                  }));
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            });
          });

          http.listen(9010, () => {
            console.log('Mock backend running on :9010');
          });
          EOF
          node /tmp/mock-server.mjs &
          echo $! > /tmp/mock-server.pid
          # Wait for server to start
          for i in {1..10}; do
            if curl -sf http://localhost:9010/healthz > /dev/null; then
              echo "Mock server ready"
              exit 0
            fi
            sleep 1
          done
          echo "Mock server failed to start"
          exit 1

      - name: Run Detox tests
        id: detox-test
        working-directory: mobile
        run: |
          npx detox test --configuration ${{ env.DETOX_CONFIGURATION }} \
            --headless \
            --record-logs all \
            --record-videos failing \
            --cleanup 2>&1 | tee /tmp/detox-output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detox-ios-artifacts
          path: |
            mobile/artifacts/
            /tmp/detox-output.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/mock-server.pid ]; then
            kill $(cat /tmp/mock-server.pid) 2>/dev/null || true
          fi
          xcrun simctl shutdown all || true

      - name: Create test summary
        if: always()
        run: |
          echo "### iOS E2E Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detox-test.outcome }}" == "success" ]; then
            echo "‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 /tmp/detox-output.txt >> $GITHUB_STEP_SUMMARY || echo "No output captured"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: steps.detox-test.outcome == 'failure'
        run: exit 1

  # Build and test on Android emulator
  android:
    name: Android E2E Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.platform != 'ios'
    timeout-minutes: 60
    env:
      DETOX_CONFIGURATION: android.emu.debug

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache AVD
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-api34-${{ runner.os }}

      - name: Create AVD
        if: steps.avd-cache.outputs.cache-hit != 'true'
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-34;google_apis;x86_64"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            --force \
            --name Pixel_7_API_34 \
            --package "system-images;android-34;google_apis;x86_64" \
            --device "pixel_7"

      - name: Expo prebuild for Android
        working-directory: mobile
        run: npx expo prebuild --platform android --clean

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            mobile/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android app for Detox
        working-directory: mobile
        run: npx detox build --configuration ${{ env.DETOX_CONFIGURATION }}

      - name: Start mock backend
        run: |
          # Same mock server as iOS
          cat > /tmp/mock-server.mjs << 'EOF'
          import { WebSocketServer } from 'ws';
          import { createServer } from 'http';

          const http = createServer((req, res) => {
            if (req.url === '/healthz') {
              res.writeHead(200);
              res.end('OK');
            } else {
              res.writeHead(404);
              res.end();
            }
          });

          const wss = new WebSocketServer({ server: http });

          const MOCK_BALANCE = 10000n;

          wss.on('connection', (ws) => {
            console.log('E2E client connected');

            ws.send(JSON.stringify({
              type: 'balance',
              balance: MOCK_BALANCE.toString()
            }));

            ws.on('message', (data) => {
              try {
                const msg = JSON.parse(data);
                console.log('Received:', msg.type);

                if (msg.type === 'authenticate') {
                  ws.send(JSON.stringify({
                    type: 'authenticated',
                    balance: MOCK_BALANCE.toString()
                  }));
                } else if (msg.type === 'join_game') {
                  ws.send(JSON.stringify({
                    type: 'game_joined',
                    gameId: msg.gameId,
                    state: null
                  }));
                } else if (msg.type === 'place_bet') {
                  ws.send(JSON.stringify({
                    type: 'game_result',
                    won: Math.random() > 0.5,
                    payout: msg.amount * 2,
                    newBalance: (MOCK_BALANCE - BigInt(msg.amount) + BigInt(msg.amount * 2)).toString()
                  }));
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            });
          });

          http.listen(9010, () => {
            console.log('Mock backend running on :9010');
          });
          EOF
          node /tmp/mock-server.mjs &
          echo $! > /tmp/mock-server.pid
          for i in {1..10}; do
            if curl -sf http://localhost:9010/healthz > /dev/null; then
              echo "Mock server ready"
              exit 0
            fi
            sleep 1
          done
          echo "Mock server failed to start"
          exit 1

      - name: Run Detox tests
        id: detox-test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          avd-name: Pixel_7_API_34
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            cd mobile
            adb reverse tcp:9010 tcp:9010
            npx detox test --configuration ${{ env.DETOX_CONFIGURATION }} \
              --headless \
              --record-logs all \
              --record-videos failing \
              --cleanup 2>&1 | tee /tmp/detox-output.txt
        continue-on-error: true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detox-android-artifacts
          path: |
            mobile/artifacts/
            /tmp/detox-output.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/mock-server.pid ]; then
            kill $(cat /tmp/mock-server.pid) 2>/dev/null || true
          fi

      - name: Create test summary
        if: always()
        run: |
          echo "### Android E2E Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detox-test.outcome }}" == "success" ]; then
            echo "‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 /tmp/detox-output.txt >> $GITHUB_STEP_SUMMARY || echo "No output captured"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: steps.detox-test.outcome == 'failure'
        run: exit 1

  # Post results to PR
  report:
    name: Report Results
    runs-on: ubuntu-latest
    needs: [ios, android]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: detox-ios-artifacts
          path: ios-artifacts
        continue-on-error: true

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: detox-android-artifacts
          path: android-artifacts
        continue-on-error: true

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const iosStatus = '${{ needs.ios.result }}';
            const androidStatus = '${{ needs.android.result }}';

            const iosEmoji = iosStatus === 'success' ? '‚úÖ' : iosStatus === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
            const androidEmoji = androidStatus === 'success' ? '‚úÖ' : androidStatus === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';

            let body = `## üì± Mobile E2E Test Results\n\n`;
            body += `| Platform | Status |\n`;
            body += `|----------|--------|\n`;
            body += `| iOS | ${iosEmoji} ${iosStatus} |\n`;
            body += `| Android | ${androidEmoji} ${androidStatus} |\n\n`;

            // Read iOS output if available
            try {
              const iosOutput = fs.readFileSync('ios-artifacts/detox-output.txt', 'utf8');
              const iosLines = iosOutput.split('\n').slice(-50).join('\n');
              body += `<details>\n<summary>iOS Test Output (last 50 lines)</summary>\n\n\`\`\`\n${iosLines}\n\`\`\`\n</details>\n\n`;
            } catch (e) {
              body += `> iOS test output not available\n\n`;
            }

            // Read Android output if available
            try {
              const androidOutput = fs.readFileSync('android-artifacts/detox-output.txt', 'utf8');
              const androidLines = androidOutput.split('\n').slice(-50).join('\n');
              body += `<details>\n<summary>Android Test Output (last 50 lines)</summary>\n\n\`\`\`\n${androidLines}\n\`\`\`\n</details>\n\n`;
            } catch (e) {
              body += `> Android test output not available\n\n`;
            }

            body += `\n---\n*Tests run by [mobile-e2e.yml](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/workflows/mobile-e2e.yml)*`;

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('üì± Mobile E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
