name: Mobile Integration Tests

on:
  # Nightly run at 3 AM UTC
  schedule:
    - cron: '0 3 * * *'
  # Manual trigger with gateway selection
  workflow_dispatch:
    inputs:
      gateway:
        description: 'Gateway environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
          - custom
      custom_gateway_url:
        description: 'Custom gateway URL (only used if gateway=custom)'
        required: false
        type: string

env:
  NODE_VERSION: 20
  PNPM_VERSION: 9.15.0
  # Gateway URLs
  STAGING_GATEWAY_URL: wss://staging-api.nullspace.casino/ws
  PRODUCTION_GATEWAY_URL: wss://api.nullspace.casino/ws

# Only one integration test run at a time
concurrency:
  group: mobile-integration-${{ github.ref }}
  cancel-in-progress: false

jobs:
  integration-tests:
    name: WebSocket Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine gateway URL
        id: gateway
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # Nightly runs use staging
            echo "url=${{ env.STAGING_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.gateway }}" == "production" ]; then
            echo "url=${{ env.PRODUCTION_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.gateway }}" == "custom" ] && [ -n "${{ inputs.custom_gateway_url }}" ]; then
            echo "url=${{ inputs.custom_gateway_url }}" >> $GITHUB_OUTPUT
            echo "env=custom" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.STAGING_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Run integration tests
        id: tests
        working-directory: mobile
        env:
          GATEWAY_URL: ${{ steps.gateway.outputs.url }}
        run: |
          echo "ðŸŽ° Running mobile integration tests against ${{ steps.gateway.outputs.env }} gateway"
          echo "Gateway URL: $GATEWAY_URL"
          echo ""

          # Run tests and capture output
          npx tsx tests/integration/runTests.ts 2>&1 | tee /tmp/integration-output.txt
          exit_code=${PIPESTATUS[0]}

          # Extract summary for job output
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Parse results for summary
          if grep -q "ALL TESTS PASSED" /tmp/integration-output.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

          # Extract stats
          passed=$(grep "âœ“ Passed:" /tmp/integration-output.txt | grep -oE '[0-9]+' || echo "0")
          failed=$(grep "âœ— Failed:" /tmp/integration-output.txt | grep -oE '[0-9]+' || echo "0")
          total_games=$(grep "Total Games Played:" /tmp/integration-output.txt | grep -oE '[0-9]+' || echo "0")
          rtp=$(grep "RTP:" /tmp/integration-output.txt | grep -oE '[0-9]+\.[0-9]+' || echo "0")

          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "total_games=$total_games" >> $GITHUB_OUTPUT
          echo "rtp=$rtp" >> $GITHUB_OUTPUT

          exit $exit_code
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ steps.gateway.outputs.env }}
          path: |
            mobile/tests/integration/results/
            /tmp/integration-output.txt
          retention-days: 30

      - name: Create test summary
        if: always()
        run: |
          echo "## ðŸŽ° Mobile Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.gateway.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Gateway:** \`${{ steps.gateway.outputs.url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.tests.outputs.status }}" == "success" ]; then
            echo "### âœ… All Tests Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Passed | ${{ steps.tests.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Failed | ${{ steps.tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Games Played | ${{ steps.tests.outputs.total_games }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RTP | ${{ steps.tests.outputs.rtp }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Full Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/integration-output.txt >> $GITHUB_STEP_SUMMARY || echo "Output not available"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Fail workflow if tests failed
        if: steps.tests.outputs.status == 'failure'
        run: |
          echo "âŒ Integration tests failed"
          exit 1

  # Run reconnection tests separately (longer timeout)
  reconnection-tests:
    name: Reconnection Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: integration-tests
    # Only run reconnection tests if main integration passed or on manual trigger
    if: always() && (needs.integration-tests.result == 'success' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine gateway URL
        id: gateway
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "url=${{ env.STAGING_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.gateway }}" == "production" ]; then
            echo "url=${{ env.PRODUCTION_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.gateway }}" == "custom" ] && [ -n "${{ inputs.custom_gateway_url }}" ]; then
            echo "url=${{ inputs.custom_gateway_url }}" >> $GITHUB_OUTPUT
            echo "env=custom" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.STAGING_GATEWAY_URL }}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Run reconnection tests
        id: reconnection
        working-directory: mobile
        env:
          GATEWAY_URL: ${{ steps.gateway.outputs.url }}
        run: |
          echo "ðŸ”„ Running reconnection tests against ${{ steps.gateway.outputs.env }} gateway"
          npx tsx tests/integration/runReconnectionTests.ts 2>&1 | tee /tmp/reconnection-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        continue-on-error: true

      - name: Upload reconnection results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reconnection-test-results-${{ steps.gateway.outputs.env }}
          path: |
            mobile/tests/integration/results/
            /tmp/reconnection-output.txt
          retention-days: 30

      - name: Add to summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”„ Reconnection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.reconnection.outputs.exit_code }}" == "0" ]; then
            echo "### âœ… Reconnection Tests Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Reconnection Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Reconnection Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/reconnection-output.txt >> $GITHUB_STEP_SUMMARY || echo "Output not available"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Notify on failure (nightly only)
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [integration-tests, reconnection-tests]
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Nightly Mobile Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Mobile Integration Test Failure

            The nightly mobile integration tests have failed.

            **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### What to check:
            1. Is the staging gateway healthy?
            2. Are there any recent protocol changes?
            3. Check the test artifacts for detailed logs

            ### Quick commands:
            \`\`\`bash
            # Run locally against staging
            cd mobile && GATEWAY_URL=wss://staging-api.nullspace.casino/ws npx tsx tests/integration/runTests.ts
            \`\`\`

            ---
            *This issue was automatically created by the nightly integration test workflow.*
            `;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-failure',
              per_page: 1
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['integration-failure', 'automated']
              });
            } else {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `### Another failure on ${new Date().toISOString().split('T')[0]}\n\n**Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            }
