{
	"branchName": "ralph/testnet-production",
	"userStories": [
		{
			"id": "US-010",
			"title": "Execute soak test",
			"acceptanceCriteria": [
				"./scripts/soak-test.sh configs/testnet 4",
				"DURATION_SECONDS=600 (10 minutes)",
				"No crashes or deadlocks",
				"Memory usage stable"
			],
			"priority": 1,
			"passes": false,
			"notes": "MANUAL: Script exists at scripts/soak-test.sh, needs staging deployment"
		},
		{
			"id": "US-011",
			"title": "Execute bot load test",
			"acceptanceCriteria": [
				"./scripts/run-bots.sh configs/testnet http://<HOST>:8080",
				"NUM_BOTS=300 DURATION_SECONDS=300",
				"No sustained errors",
				"Response times acceptable"
			],
			"priority": 2,
			"passes": false,
			"notes": "MANUAL: Script exists at scripts/run-bots.sh, needs staging deployment"
		},
		{
			"id": "US-012",
			"title": "Execute global table fanout test",
			"acceptanceCriteria": [
				"node scripts/load-test-global-table.mjs",
				"URL=ws://<GATEWAY>:9010 TOTAL=5000 DURATION=300",
				"Events broadcast to all clients",
				"No message loss"
			],
			"priority": 3,
			"passes": false,
			"notes": "MANUAL: Script exists at scripts/load-test-global-table.mjs, needs staging"
		},
		{
			"id": "US-013",
			"title": "Verify health endpoints",
			"acceptanceCriteria": [
				"GET http://<INDEXER>:8080/healthz returns 200",
				"GET http://<GATEWAY>:9010/healthz returns 200",
				"All services respond within 5s"
			],
			"priority": 4,
			"passes": false,
			"notes": "MANUAL: Basic smoke check per runbook, needs staging deployment"
		},
		{
			"id": "US-014",
			"title": "Test faucet flow end-to-end",
			"acceptanceCriteria": [
				"Register new user via mobile app",
				"Claim faucet credits",
				"Balance updates correctly",
				"Can place and resolve bet"
			],
			"priority": 5,
			"passes": false,
			"notes": "MANUAL: Core testnet user journey on staging"
		},
		{
			"id": "US-015",
			"title": "Test vault-only login on iOS",
			"acceptanceCriteria": [
				"Set VITE_ALLOW_LEGACY_KEYS=0",
				"Create new account with vault password",
				"Export recovery key",
				"Reimport on fresh install"
			],
			"priority": 6,
			"passes": false,
			"notes": "MANUAL: Go/No-Go criteria per runbook Section 10"
		},
		{
			"id": "US-016",
			"title": "Test vault-only login on Android",
			"acceptanceCriteria": [
				"Set VITE_ALLOW_LEGACY_KEYS=0",
				"Create new account with vault password",
				"Export recovery key",
				"Reimport on fresh install"
			],
			"priority": 7,
			"passes": false,
			"notes": "MANUAL: Go/No-Go criteria per runbook Section 10"
		},
		{
			"id": "US-017",
			"title": "Test validator restart recovery",
			"acceptanceCriteria": [
				"Stop one validator node",
				"Restart after 30 seconds",
				"Node rejoins consensus",
				"No transaction loss"
			],
			"priority": 8,
			"passes": false,
			"notes": "MANUAL: Recovery drill per runbook Section 7"
		},
		{
			"id": "US-018",
			"title": "Test gateway restart recovery",
			"acceptanceCriteria": [
				"Stop gateway service",
				"Restart after 10 seconds",
				"Sessions re-register",
				"Nonces persist correctly"
			],
			"priority": 9,
			"passes": false,
			"notes": "MANUAL: Recovery drill per runbook Section 7"
		},
		{
			"id": "US-019",
			"title": "Build production mobile APK",
			"acceptanceCriteria": [
				"Configure EAS secrets for production endpoints",
				"eas build -p android --profile production",
				"Install on real device",
				"Verify WSS connection works"
			],
			"priority": 10,
			"passes": false,
			"notes": "MANUAL: Final production Android build"
		},
		{
			"id": "US-020",
			"title": "Build production mobile IPA",
			"acceptanceCriteria": [
				"Configure EAS secrets for production endpoints",
				"eas build -p ios --profile production",
				"Install via TestFlight",
				"Verify WSS connection works"
			],
			"priority": 11,
			"passes": false,
			"notes": "MANUAL: Final production iOS build"
		},
		{
			"id": "US-088",
			"title": "Add reconnection with in-flight game state test",
			"acceptanceCriteria": [
				"Test disconnect during game preserves game state",
				"Test reconnect resumes game with same sessionId",
				"Test balance consistent after reconnect mid-game",
				"Test nonce sequence maintained across reconnection"
			],
			"priority": 12,
			"passes": true,
			"notes": "ARCHITECTURE DOCUMENTED: Created InFlightGameStateTest.ts with 6 tests documenting current behavior: (1) Game state NOT preserved on disconnect (by design), (2) Reconnect creates NEW sessionId, (3) Balance consistent (on-chain persistence), (4) Nonce sequence maintained (server-side), (5) activeGameId null after reconnect, (6) New game can start after reconnect. Run via: npx tsx tests/integration/runInFlightGameStateTests.ts"
		},
		{
			"id": "US-089",
			"title": "Add out-of-order balance update handling test",
			"acceptanceCriteria": [
				"Test balance messages arriving out of order use latest value",
				"Test faucet response after get_balance response shows correct final",
				"Add timestamp or sequence number to balance messages",
				"Verify last-write-wins doesn't cause balance regression"
			],
			"priority": 13,
			"passes": false,
			"notes": "HIGH GAP: useGatewaySession updates balance from any message. If old balance message arrives after new one, balance regresses."
		},
		{
			"id": "US-090",
			"title": "Add concurrent bet validation lock test",
			"acceptanceCriteria": [
				"Test placeChip() locks during validation to prevent race",
				"Test balance update arriving mid-validation is handled",
				"Test bet rejected if balance changes between validation and submission",
				"Verify no bet exceeds actual balance due to race"
			],
			"priority": 14,
			"passes": false,
			"notes": "CRITICAL GAP: useChipBetting.placeChip() uses getState() but doesn't lock. Concurrent setBalance() can cause bet > balance."
		},
		{
			"id": "US-091",
			"title": "Add atomic batch payload boundary test",
			"acceptanceCriteria": [
				"Test batch with N bets but N-0.5 bytes worth of data",
				"Test bet type field swapped (Roulette format to Craps handler)",
				"Test amount field endianness consistency",
				"Verify truncated payloads return ERROR_INVALID_PAYLOAD, not crash"
			],
			"priority": 15,
			"passes": false,
			"notes": "HIGH GAP: Different games expect different payload formats (Craps: 10 bytes/bet, Baccarat: 9 bytes/bet). No cross-format validation."
		},
		{
			"id": "US-092",
			"title": "Add game result message format validation test",
			"acceptanceCriteria": [
				"Define TypeScript interface for game_result message",
				"Test 'blackjack' field distinguishes natural 21 from regular win",
				"Test all required fields present: won, push, hands, dealer",
				"Create canonical GameMessage union type in /types/messages.ts"
			],
			"priority": 16,
			"passes": false,
			"notes": "HIGH GAP: No defined format for how GameResult enum maps to JSON fields. Mobile can't distinguish blackjack vs regular win."
		},
		{
			"id": "US-093",
			"title": "Rotate and externalize hardcoded secrets from .env files",
			"acceptanceCriteria": [
				"Remove hardcoded secrets from services/auth/.env and docker/convex/.env",
				"Migrate secrets to environment variables or secret manager (e.g., HashiCorp Vault)",
				"Rotate all exposed secrets: AUTH_SECRET, CONVEX_SERVICE_TOKEN, CASINO_ADMIN_PRIVATE_KEY_HEX",
				"Add .env to .gitignore and create .env.example templates",
				"Document secret management process in RUNBOOK.md"
			],
			"priority": 17,
			"passes": false,
			"notes": "SECURITY-CRITICAL (agent-verified): Hardcoded secrets in version control. AUTH_SECRET, STRIPE_SECRET_KEY, CASINO_ADMIN_PRIVATE_KEY_HEX exposed. Immediate rotation required."
		},
		{
			"id": "US-094",
			"title": "Increase vault password minimum length to 12 characters",
			"acceptanceCriteria": [
				"Update PASSWORD_MIN_LENGTH from 8 to 12 in vault.ts",
				"Update password validation UI with new minimum",
				"Test password length enforcement",
				"Add password strength indicator showing entropy"
			],
			"priority": 18,
			"passes": false,
			"notes": "SECURITY-HIGH (agent-verified): vault.ts:11 has PASSWORD_MIN_LENGTH=8, below NIST 2024 recommendations of 12+ characters."
		},
		{
			"id": "US-095",
			"title": "Add encrypted fallback for web vault storage",
			"acceptanceCriteria": [
				"Replace unencrypted localStorage fallback with IndexedDB + subtle.crypto encryption",
				"Test fallback activates when SecureStore unavailable",
				"Test encrypted storage read/write operations",
				"Warn user when using fallback storage mode"
			],
			"priority": 19,
			"passes": false,
			"notes": "SECURITY-HIGH (agent-verified): vault.ts:19-29 WebSecureStore fallback uses unencrypted localStorage for private keys."
		},
		{
			"id": "US-096",
			"title": "Fix animation recreation on every render",
			"acceptanceCriteria": [
				"Memoize animation values using useRef or useMemo where appropriate",
				"Move Animated.Value creation outside render in CardFan, ChipStack",
				"Test animations don't flicker on re-render",
				"Measure FPS improvement after fix"
			],
			"priority": 20,
			"passes": false,
			"notes": "PERFORMANCE-HIGH (agent-verified): CardFan.tsx, ChipStack.tsx recreate Animated.Value objects on every render causing memory pressure and animation jank."
		},
		{
			"id": "US-097",
			"title": "Fix session counter mutation side effect in isNextSession",
			"acceptanceCriteria": [
				"Refactor isNextSession to not mutate state during validation",
				"Move counter increment to explicit mutation function",
				"Test boolean-returning functions don't have side effects",
				"Add code review guideline for function purity"
			],
			"priority": 21,
			"passes": false,
			"notes": "ARCHITECTURE-HIGH (agent-verified): Session manager isNextSession() increments counter as side effect. Could increment without using result."
		},
		{
			"id": "US-098",
			"title": "Add message queue idempotency guarantees",
			"acceptanceCriteria": [
				"Add message ID to all queued messages",
				"Track sent message IDs to prevent duplicate processing",
				"Test duplicate message after reconnect is deduplicated",
				"Document idempotency behavior in WebSocket API"
			],
			"priority": 22,
			"passes": false,
			"notes": "DATA-INTEGRITY-HIGH (agent-verified): websocket.ts:246-268 flushQueue has no idempotency. Duplicates possible on reconnect race."
		},
		{
			"id": "US-099",
			"title": "Fix queue send() returning true despite message being dropped",
			"acceptanceCriteria": [
				"Change send() to return false when message dropped from queue overflow",
				"Notify user when message cannot be delivered",
				"Test send() return value reflects actual delivery status",
				"Add onMessageDropped callback for critical messages"
			],
			"priority": 23,
			"passes": false,
			"notes": "DATA-INTEGRITY-CRITICAL (agent-verified): websocket.ts:225-232 returns success when oldest message dropped. Callers think bet succeeded but it's lost."
		},
		{
			"id": "US-100",
			"title": "Extract duplicated binary reading utilities",
			"acceptanceCriteria": [
				"Create shared BinaryReader class used by both gateway and protocol package",
				"Migrate StateReader pattern to shared utility",
				"Test binary reading consistency across packages",
				"Remove duplicated readU8, readU32BE, readBigInt implementations"
			],
			"priority": 24,
			"passes": false,
			"notes": "CODE-QUALITY (agent-verified): Binary reading code duplicated between gateway/src/backend/events.ts and packages/protocol/src/codec.ts."
		},
		{
			"id": "US-101",
			"title": "Consolidate duplicated stylesheet definitions",
			"acceptanceCriteria": [
				"Extract shared styles to theme.ts (colors, spacing, typography)",
				"Remove duplicated StyleSheet.create calls across game screens",
				"Create reusable style primitives (gameContainer, betArea, etc.)",
				"Test theme changes propagate to all screens"
			],
			"priority": 25,
			"passes": false,
			"notes": "CODE-QUALITY (agent-verified): ~175 LOC duplication across 10 game screen stylesheets. Same colors, dimensions repeated."
		},
		{
			"id": "US-103",
			"title": "Add type-safe message parsing with validation",
			"acceptanceCriteria": [
				"Replace unsafe type assertions (as GameState) with validation",
				"Add runtime type checking for WebSocket messages",
				"Test malformed messages don't cause runtime crashes",
				"Use zod or io-ts for message schema validation"
			],
			"priority": 26,
			"passes": false,
			"notes": "CODE-QUALITY (agent-verified): Multiple unsafe 'as' casts without validation. Runtime type errors possible on malformed server messages."
		}
	]
}
