{
  "branchName": "ralph/testnet-production",
  "lastVerified": "2026-01-08",
  "completedWork": {
    "designSystem": {
      "stories": 56,
      "description": "Design tokens, animations, accessibility"
    },
    "luxuryRedesign": {
      "stories": 25,
      "description": "Premium typography, decluttered UX"
    },
    "qaBaseline": {
      "stories": 6,
      "description": "Hi-Lo, lobby, deposit, session tests"
    },
    "testnetProduction": {
      "stories": 48,
      "description": "Infrastructure, deployment, observability"
    }
  },
  "stories": [
    {
      "id": "US-229",
      "category": "infrastructure",
      "description": "Generate production SOPS Age keys",
      "steps": [
        "Run ./scripts/setup-secrets.sh production",
        "Verify .sops.yaml has real production key (not placeholder)",
        "Test encryption/decryption roundtrip"
      ],
      "passes": false,
      "notes": "Staging key exists, production is placeholder. PRODUCTION-CRITICAL."
    },
    {
      "id": "US-230",
      "category": "infrastructure",
      "description": "Add Docker resource limits to production compose",
      "steps": [
        "Create infrastructure/production/docker-compose.yml",
        "Add memory limits to all services",
        "Add CPU limits to all services",
        "Verify compose file validates"
      ],
      "passes": false,
      "notes": "No resource limits in any docker-compose. PRODUCTION-CRITICAL."
    },
    {
      "id": "US-017",
      "category": "operations",
      "description": "Test validator restart recovery",
      "steps": [
        "Stop a validator node",
        "Verify other validators continue",
        "Restart stopped validator",
        "Verify it rejoins consensus",
        "Document recovery time"
      ],
      "passes": false,
      "notes": "Procedures in RUNBOOK.md 5.6, needs execution proof."
    },
    {
      "id": "US-018",
      "category": "operations",
      "description": "Test gateway restart recovery",
      "steps": [
        "Stop gateway with active sessions",
        "Verify clients receive SESSION_EXPIRED",
        "Restart gateway",
        "Verify new connections work",
        "Document recovery time"
      ],
      "passes": false,
      "notes": "Procedures in RUNBOOK.md 5.6, needs execution proof."
    },
    {
      "id": "US-243",
      "category": "operations",
      "description": "Execute and document recovery drills",
      "steps": [
        "Complete US-017 and US-018 first",
        "Document recovery times in RUNBOOK.md",
        "Add drill schedule to ops procedures"
      ],
      "passes": false,
      "notes": "Depends on US-017, US-018."
    },
    {
      "id": "US-227",
      "category": "api",
      "description": "Standardize API error response format (RFC 7807)",
      "steps": [
        "Define RFC 7807 Problem Details schema",
        "Update gateway error responses",
        "Update auth service error responses",
        "Add error response tests"
      ],
      "passes": false,
      "notes": "Gateway has structured errors but not RFC 7807. Auth uses simple JSON."
    },
    {
      "id": "US-228",
      "category": "api",
      "description": "Fix incorrect HTTP status codes in auth service",
      "steps": [
        "Fix 502 at line 896 to appropriate code",
        "Fix 502 at line 961 to appropriate code",
        "Fix 502 at line 977 to appropriate code",
        "Fix 502 at line 1036 to appropriate code",
        "Fix 502 at line 1083 to appropriate code",
        "Add tests for error status codes"
      ],
      "passes": true,
      "notes": "502 should be 500/503 depending on error type."
    },
    {
      "id": "US-234",
      "category": "security",
      "description": "Add CSRF protection for cookie-authenticated endpoints",
      "steps": [
        "Add CSRF middleware to auth service",
        "Add CSRF middleware to gateway",
        "Generate CSRF tokens for sessions",
        "Verify protection with tests"
      ],
      "passes": true,
      "notes": "CSRF middleware added using double-submit cookie pattern. 8 endpoints protected."
    },
    {
      "id": "US-235",
      "category": "documentation",
      "description": "Create OpenAPI/Swagger specifications",
      "steps": [
        "Create openapi.yaml for gateway",
        "Create openapi.yaml for auth service",
        "Add API documentation generation to build"
      ],
      "passes": false,
      "notes": "No openapi.yaml or swagger files found."
    },
    {
      "id": "US-236",
      "category": "architecture",
      "description": "Design horizontal scaling strategy for game engine",
      "steps": [
        "Document partitioning strategy",
        "Define session affinity approach",
        "Create scaling runbook",
        "Add to docs/architecture/"
      ],
      "passes": false,
      "notes": "General scaling docs exist, need dedicated strategy doc."
    },
    {
      "id": "US-238",
      "category": "documentation",
      "description": "Document Convex self-hosting runbook",
      "steps": [
        "Create docs/convex-migration.md",
        "Document data export process",
        "Document self-hosting setup",
        "Add rollback procedures"
      ],
      "passes": false,
      "notes": "References exist in golive.md, need dedicated runbook."
    },
    {
      "id": "US-014",
      "category": "testing",
      "description": "Test faucet flow end-to-end",
      "steps": [
        "Enable skipped faucet test in session.test.ts",
        "Verify faucet request succeeds",
        "Verify balance updates",
        "Document any manual steps needed"
      ],
      "passes": false,
      "notes": "Automated test currently skipped."
    },
    {
      "id": "US-015",
      "category": "testing",
      "description": "Test vault-only login on iOS",
      "steps": [
        "Run E2E test on iOS simulator",
        "Verify vault unlock flow",
        "Verify session creation",
        "Screenshot proof of execution"
      ],
      "passes": false,
      "notes": "MANUAL: Requires iOS device/simulator."
    },
    {
      "id": "US-016",
      "category": "testing",
      "description": "Test vault-only login on Android",
      "steps": [
        "Run E2E test on Android emulator",
        "Verify vault unlock flow",
        "Verify session creation",
        "Screenshot proof of execution"
      ],
      "passes": false,
      "notes": "MANUAL: Requires Android device/emulator."
    },
    {
      "id": "US-019",
      "category": "release",
      "description": "Build production mobile APK",
      "steps": [
        "Configure EAS credentials",
        "Run eas build --platform android",
        "Verify APK installs and runs"
      ],
      "passes": false,
      "notes": "MANUAL: Requires EAS account."
    },
    {
      "id": "US-020",
      "category": "release",
      "description": "Build production mobile IPA",
      "steps": [
        "Configure Apple Developer credentials",
        "Run eas build --platform ios",
        "Verify IPA installs and runs"
      ],
      "passes": false,
      "notes": "MANUAL: Requires Apple Developer account."
    },
    {
      "id": "US-242",
      "category": "testing",
      "description": "Verify mobile vault recovery flow E2E",
      "steps": [
        "Create vault with test wallet",
        "Simulate app uninstall/reinstall",
        "Verify vault recovery works",
        "Add E2E test for flow"
      ],
      "passes": false,
      "notes": "Vault implementation exists, no recovery E2E test."
    },
    {
      "id": "US-244",
      "category": "performance",
      "description": "Audit mobile noble cryptography performance",
      "steps": [
        "Benchmark PBKDF2 iterations on low-end device",
        "Benchmark Ed25519 signing",
        "Document performance characteristics",
        "Recommend optimizations if needed"
      ],
      "passes": false,
      "notes": "500k PBKDF2 iterations, no benchmarks documented."
    },
    {
      "id": "US-218",
      "category": "infrastructure",
      "description": "Configure and verify CDN",
      "steps": [
        "Configure Cloudflare CDN rules",
        "Verify static assets cached",
        "Verify cache headers correct",
        "Document CDN configuration"
      ],
      "passes": false,
      "notes": "Cache headers in nginx, no dedicated CDN setup."
    },
    {
      "id": "US-246",
      "category": "observability",
      "description": "Validate KPIs for testnet launch",
      "steps": [
        "Run check-slo.mjs against staging",
        "Document baseline metrics",
        "Verify all SLO targets defined in observability.md",
        "Create KPI dashboard"
      ],
      "passes": false,
      "notes": "SLO targets defined, no baseline run."
    },
    {
      "id": "QA-007",
      "category": "qa-game",
      "description": "Test Blackjack hit/stand flow",
      "steps": [
        "Add Detox test for hit action",
        "Add Detox test for stand action",
        "Verify win/loss outcomes correct"
      ],
      "passes": false,
      "notes": "Integration tests exist, Detox partial."
    },
    {
      "id": "QA-008",
      "category": "qa-game",
      "description": "Test Blackjack double/split",
      "steps": [
        "Add Detox test for double down",
        "Add Detox test for split",
        "Verify bet amounts correct"
      ],
      "passes": false,
      "notes": "No Detox coverage."
    },
    {
      "id": "QA-009",
      "category": "qa-game",
      "description": "Test Roulette all bet categories",
      "steps": [
        "Test inside bets (straight, split, street)",
        "Test outside bets (red/black, odd/even)",
        "Verify payouts correct"
      ],
      "passes": false,
      "notes": "Chip drag tested, specific bets missing."
    },
    {
      "id": "QA-010",
      "category": "qa-game",
      "description": "Test Baccarat main bets",
      "steps": [
        "Test player bet",
        "Test banker bet",
        "Test tie bet",
        "Verify commission on banker win"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-011",
      "category": "qa-game",
      "description": "Test Baccarat side bets",
      "steps": [
        "Test player pair",
        "Test banker pair",
        "Test perfect pair",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-012",
      "category": "qa-game",
      "description": "Test Casino War",
      "steps": [
        "Test basic war flow",
        "Test tie scenario",
        "Test surrender option",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-013",
      "category": "qa-game",
      "description": "Test Video Poker deal/hold",
      "steps": [
        "Test initial deal",
        "Test hold card selection",
        "Test draw",
        "Verify hand rankings"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-014",
      "category": "qa-game",
      "description": "Test Sic Bo all bets",
      "steps": [
        "Test big/small bets",
        "Test specific triples",
        "Test totals",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-015",
      "category": "qa-game",
      "description": "Test Three Card Poker",
      "steps": [
        "Test ante/play flow",
        "Test pair plus bet",
        "Verify hand rankings",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-016",
      "category": "qa-game",
      "description": "Test Ultimate Texas Holdem",
      "steps": [
        "Test blind/ante bets",
        "Test check/bet on each street",
        "Test trips bet",
        "Verify showdown logic"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-017",
      "category": "qa-game",
      "description": "Test Craps pass/come bets",
      "steps": [
        "Test pass line bet",
        "Test come bet",
        "Test point establishment",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-018",
      "category": "qa-game",
      "description": "Test Craps odds/props",
      "steps": [
        "Test odds bets",
        "Test proposition bets",
        "Test field bet",
        "Verify payouts"
      ],
      "passes": false,
      "notes": "Integration test only."
    },
    {
      "id": "QA-022",
      "category": "qa-ui",
      "description": "Test insufficient balance handling",
      "steps": [
        "Attempt bet larger than balance",
        "Verify UI shows error",
        "Verify bet is rejected",
        "Test recovery flow"
      ],
      "passes": false,
      "notes": "Backend tested, UI feedback not tested."
    },
    {
      "id": "QA-023",
      "category": "qa-ui",
      "description": "Test rapid bet submission",
      "steps": [
        "Submit bets rapidly",
        "Verify no double-betting",
        "Verify UI debouncing works"
      ],
      "passes": false,
      "notes": "No double-tap prevention test."
    },
    {
      "id": "QA-026",
      "category": "qa-ui",
      "description": "Create visual regression baseline",
      "steps": [
        "Set up screenshot testing",
        "Capture baseline for all game screens",
        "Add to CI pipeline"
      ],
      "passes": false,
      "notes": "No screenshots/snapshot tests."
    },
    {
      "id": "QA-N01",
      "category": "qa-native",
      "description": "Test SecureStore wallet persistence",
      "steps": [
        "Create wallet on native",
        "Kill app completely",
        "Reopen and verify wallet loaded"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N02",
      "category": "qa-native",
      "description": "Test vault password enforcement",
      "steps": [
        "Try password < 12 chars",
        "Verify rejection",
        "Try valid password",
        "Verify acceptance"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N03",
      "category": "qa-native",
      "description": "Test biometric auth for vault",
      "steps": [
        "Enable biometrics",
        "Lock vault",
        "Unlock with biometrics",
        "Verify wallet accessible"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N04",
      "category": "qa-native",
      "description": "Test haptic feedback",
      "steps": [
        "Place bet",
        "Verify haptic on bet placement",
        "Win/lose game",
        "Verify haptic on outcome"
      ],
      "passes": false,
      "platform": "native-device"
    },
    {
      "id": "QA-N05",
      "category": "qa-native",
      "description": "Test app backgrounding",
      "steps": [
        "Start game",
        "Background app",
        "Foreground app",
        "Verify state preserved"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N06",
      "category": "qa-native",
      "description": "Test airplane mode recovery",
      "steps": [
        "Enable airplane mode mid-session",
        "Verify graceful disconnection",
        "Disable airplane mode",
        "Verify reconnection"
      ],
      "passes": false,
      "platform": "native-device"
    },
    {
      "id": "QA-N07",
      "category": "qa-native",
      "description": "Test push notifications",
      "steps": [
        "Enable notifications",
        "Trigger big win",
        "Verify notification received",
        "Tap notification, verify navigation"
      ],
      "passes": false,
      "platform": "native-device"
    },
    {
      "id": "QA-N08",
      "category": "qa-native",
      "description": "Test card animation smoothness",
      "steps": [
        "Play Blackjack",
        "Observe card dealing animation",
        "Verify 60fps, no jank",
        "Test on low-end device"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N09",
      "category": "qa-native",
      "description": "Test chip drag gesture",
      "steps": [
        "Select chip",
        "Drag to betting area",
        "Verify bet placed",
        "Test multi-touch"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "QA-N10",
      "category": "qa-native",
      "description": "Test iOS full game flow",
      "steps": [
        "Launch on iOS simulator",
        "Create/unlock vault",
        "Play complete game",
        "Verify payout"
      ],
      "passes": false,
      "platform": "ios"
    },
    {
      "id": "QA-N11",
      "category": "qa-native",
      "description": "Test Android full game flow",
      "steps": [
        "Launch on Android emulator",
        "Create/unlock vault",
        "Play complete game",
        "Verify payout"
      ],
      "passes": false,
      "platform": "android"
    },
    {
      "id": "QA-N12",
      "category": "qa-native",
      "description": "Test memory stability",
      "steps": [
        "Play 50+ consecutive games",
        "Monitor memory usage",
        "Verify no memory leaks",
        "Document baseline memory"
      ],
      "passes": false,
      "platform": "native"
    },
    {
      "id": "US-248",
      "category": "infrastructure",
      "description": "Honor X-Forwarded-For for gateway IP-based limits and metrics",
      "steps": [
        "Add trusted proxy IP extraction (X-Forwarded-For/X-Real-IP) with an allowlist or CIDR config",
        "Use derived client IP for connection limiter, session rate limits, and metrics logging",
        "Add tests covering forwarded headers and fallback to socket remoteAddress",
        "Document proxy header expectations in runbooks/Caddy config"
      ],
      "passes": false,
      "notes": "Gateway runs behind Caddy in staging; current IP handling collapses all clients to proxy IP, breaking per-IP limits and metrics."
    },
    {
      "id": "US-249",
      "category": "security",
      "description": "Fix Caddy CORS headers so auth cookie flows and origin allowlists work",
      "steps": [
        "Remove Access-Control-Allow-* overrides from infrastructure/staging/Caddyfile or scope them to match allowed origins",
        "Ensure auth responses include Access-Control-Allow-Credentials and a specific origin",
        "Validate browser auth flow and preflight behavior on staging"
      ],
      "passes": false,
      "notes": "Caddy currently forces Access-Control-Allow-Origin=* on auth/gateway/indexer, which can override upstream CORS and break credentialed cookies."
    },
    {
      "id": "US-250",
      "category": "release",
      "description": "Fail website image builds when required VITE_* args are missing",
      "steps": [
        "Add a validation step in build-images.yml to require VITE_URL, VITE_AUTH_URL, VITE_AUTH_PROXY_URL, and VITE_IDENTITY for website builds",
        "Make the build fail fast if any required var is empty",
        "Document required GitHub vars in docs/release.md or runbooks"
      ],
      "passes": false,
      "notes": "If build args are unset, the website falls back to localhost endpoints and ships a broken testnet UI."
    },
    {
      "id": "US-251",
      "category": "api",
      "description": "Make Stripe billing optional in auth service",
      "steps": [
        "Introduce AUTH_BILLING_ENABLED (or similar) flag",
        "Only require STRIPE_PRICE_TIERS when billing is enabled",
        "Guard billing endpoints to return a clear 403/503 when disabled",
        "Update env examples and runbooks",
        "Add tests for billing-disabled startup"
      ],
      "passes": false,
      "notes": "Auth currently throws if STRIPE_PRICE_TIERS is missing, conflicting with runbook guidance that Stripe is optional for testnet."
    },
    {
      "id": "US-252",
      "category": "observability",
      "description": "Accept x-metrics-token for gateway metrics (parity with simulator/auth)",
      "steps": [
        "Allow x-metrics-token in gateway metrics auth",
        "Update observability docs to note accepted headers",
        "Add a unit test for the alternate header"
      ],
      "passes": false,
      "notes": "Simulator/auth accept Bearer or x-metrics-token; gateway currently only accepts Bearer."
    },
    {
      "id": "US-253",
      "category": "performance",
      "description": "Log and alert on super-mode payout saturation",
      "steps": [
        "Emit a warning/metric when payout clamps to u64::MAX",
        "Add a test to verify saturation logging/metric",
        "Update observability or runbook guidance for monitoring"
      ],
      "passes": false,
      "notes": "Silent saturation can mask payout calculation issues in super-mode scenarios."
    },
    {
      "id": "US-254",
      "category": "documentation",
      "description": "Fix Ralph prompt commands to match repo scripts",
      "steps": [
        "Update scripts/ralph/prompt.md to use pnpm type-check (not typecheck)",
        "Update test command to match turbo (pnpm test) or documented package-specific tests",
        "Verify instructions run cleanly in repo"
      ],
      "passes": false,
      "notes": "Current prompt uses pnpm typecheck and pnpm test --run, which do not exist in package.json."
    }
  ],
  "verifiedComplete": [
    {
      "id": "US-223",
      "title": "Fix React memory leaks",
      "evidence": "useMemo, useEffect cleanup"
    },
    {
      "id": "US-224",
      "title": "Code splitting",
      "evidence": "React.lazy, vite manualChunks"
    },
    {
      "id": "US-225",
      "title": "Merkle proof caching",
      "evidence": "Arc<ProofStore> in state.rs"
    },
    {
      "id": "US-226",
      "title": "Database indexes",
      "evidence": "CREATE INDEX in explorer"
    },
    {
      "id": "US-240",
      "title": "Overflow-checks benchmark",
      "evidence": "Cargo.toml configured"
    },
    {
      "id": "US-216",
      "title": "DNS configuration",
      "evidence": "DNS_RECORDS.md, Caddyfile"
    },
    {
      "id": "US-217",
      "title": "SSL/TLS config",
      "evidence": "nginx.ssl.conf, Caddyfile"
    },
    {
      "id": "US-219",
      "title": "Rate limiting",
      "evidence": "gateway/src/session/limiter.ts"
    },
    {
      "id": "US-220",
      "title": "DDoS protection",
      "evidence": "terraform firewall rules"
    },
    {
      "id": "US-221",
      "title": "Backup procedures",
      "evidence": "RUNBOOK.md Section 3.7"
    },
    {
      "id": "US-222",
      "title": "Rollback procedures",
      "evidence": "RUNBOOK.md"
    },
    {
      "id": "US-231",
      "title": "OTEL in auth",
      "evidence": "auth/src/telemetry.ts"
    },
    {
      "id": "US-232",
      "title": "Terraform backend",
      "evidence": "S3 backend configured"
    },
    {
      "id": "US-233",
      "title": "Secret rotation docs",
      "evidence": "RUNBOOK.md Section 4.6"
    },
    {
      "id": "US-237",
      "title": "On-chain batching",
      "evidence": "batch config in craps.ts"
    },
    {
      "id": "US-239",
      "title": "Version numbers",
      "evidence": "All npm versions valid"
    },
    {
      "id": "US-247",
      "title": "Commonware version",
      "evidence": "0.0.64 is latest"
    },
    {
      "id": "US-010",
      "title": "Soak test",
      "evidence": "soak-test.sh executed"
    },
    {
      "id": "US-011",
      "title": "Bot load test",
      "evidence": "run-bots.sh exists"
    },
    {
      "id": "US-012",
      "title": "Global table test",
      "evidence": "load-test-global-table.mjs"
    },
    {
      "id": "US-241",
      "title": "Soak test docs",
      "evidence": "Script executed"
    },
    {
      "id": "US-245",
      "title": "NAT mitigation docs",
      "evidence": "RUNBOOK rate limit docs"
    }
  ],
  "bugTracker": {
    "fixed": [
      {
        "id": "BUG-003",
        "title": "SafeAreaProvider missing",
        "resolution": "mobile/App.tsx line 72"
      },
      {
        "id": "BUG-002",
        "title": "Session not persisted",
        "resolution": "IndexedDB persistence, expected WS behavior"
      }
    ],
    "open": [
      {
        "id": "BUG-001",
        "title": "Chip tap only selects, drag required",
        "notes": "Needs tutorial hint or tap-to-place"
      }
    ]
  },
  "summary": {
    "complete": 22,
    "pending": 54,
    "byCategory": {
      "api": 3,
      "architecture": 1,
      "documentation": 3,
      "infrastructure": 4,
      "observability": 2,
      "operations": 3,
      "performance": 2,
      "qa-game": 12,
      "qa-native": 12,
      "qa-ui": 3,
      "release": 3,
      "security": 2,
      "testing": 4
    }
  }
}
