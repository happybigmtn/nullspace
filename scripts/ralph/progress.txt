# Ralph Progress Log
Started: 2026-01-06
Target: Testnet Production

## Codebase Patterns

### Execution Layer (Rust)
- All casino games implement `CasinoGame` trait
- State blob versioning: v2 → v3 → v4 migrations supported
- Deterministic RNG: SHA256 hash-chain from consensus seed
- Event logging: MMR-based append-only with crash recovery
- Tests: 379/379 passing, run with `cargo test`

### Gateway (TypeScript)
- Config validation: `gateway/src/config/validation.ts` rejects placeholders
- CORS: defense-in-depth via `initializeCors()`
- Rate limits: `MAX_CONNECTIONS_PER_IP=200`, `MAX_TOTAL_SESSIONS=20000`
- Metrics: Bearer token auth required on `/metrics`
- Global table: `GATEWAY_LIVE_TABLE_CRAPS=1` enables Craps coordinator

### Mobile (React Native)
- Crypto: Ed25519 signing, PBKDF2 key derivation, AES-GCM storage
- WebSocket: Exponential backoff 1s → 30s, max 10 attempts
- 12 race conditions identified (see US-005 through US-009, US-021-022)
- Tests: 222/222 unit tests, run with `npm test`

### Configuration
- Production configs: `configs/production/*.env.example`
- Staging configs: `configs/staging/*.env.example`
- Preflight validation: `scripts/preflight-management.mjs`
- Bootstrap: `./scripts/bootstrap-testnet.sh` generates node YAML

### Testing Scripts
- Bet coverage: `RUN_INTEGRATION=true pnpm -C gateway exec vitest run tests/all-bet-types.test.ts`
- Soak test: `./scripts/soak-test.sh configs/testnet 4`
- Bot load: `./scripts/run-bots.sh configs/testnet http://<HOST>:8080`
- Global table: `node scripts/load-test-global-table.mjs`

## Key Files
- docs/testnet-readiness-runbook.md - Full deployment checklist
- docs/limits.md - All configurable rate limits
- execution/src/casino/mod.rs - Game dispatch
- gateway/src/config/validation.ts - Config validation
- mobile/src/services/crypto.ts - Crypto implementation

---

## 2026-01-06 - Initial PRD Setup

- Created prd.json with 40 user stories for testnet production
- Stories organized by priority:
  - Priority 1-4: Blocking infrastructure inputs
  - Priority 5-11: Critical mobile race conditions + security
  - Priority 12-15: Integration and load testing
  - Priority 16-20: Monitoring and smoke checks
  - Priority 21-30: Additional fixes and recovery drills
  - Priority 31-40: Documentation, optimization, production build
- **Learnings:**
  - Execution layer is 95% ready (379/379 tests pass)
  - Gateway/Node production-ready with config validation
  - Mobile has 12 race conditions needing fixes
  - Go/No-Go criteria in runbook Section 10

---

## 2026-01-06 - US-002: Generate metrics auth token

- What was implemented:
  - Verified `METRICS_AUTH_TOKEN=SLNmUmUHvNzc+wUagF9aOPGaQBb1DNp8jSG75+Cq5uI=` already set in all 3 production configs (gateway, node, simulator)
  - Generated new secure tokens for remaining placeholders
  - Updated `GATEWAY_LIVE_TABLE_PRESENCE_TOKEN` in gateway.env.example
  - Updated `GLOBAL_TABLE_PRESENCE_TOKEN` in simulator.env.example (same value as gateway for coordination)
  - Updated `SIMULATOR_IDENTITY` in simulator.env.example
- Files changed:
  - `configs/production/gateway.env.example` - line 33: presence token
  - `configs/production/simulator.env.example` - lines 8 (identity) and 44 (presence token)
- **Learnings:**
  - `METRICS_AUTH_TOKEN` must be shared across all services for Prometheus scraping
  - Presence tokens (`GATEWAY_LIVE_TABLE_PRESENCE_TOKEN` / `GLOBAL_TABLE_PRESENCE_TOKEN`) must match for live table coordination
  - `SIMULATOR_IDENTITY` is unique per instance for P2P identification
  - Preflight script validates additional configs beyond just tokens (CORS, admin keys)

---

## 2026-01-06 - US-001: Remove committed .env secrets from website

- What was implemented:
  - VERIFIED FALSE POSITIVE: .env, .env.local, .env.network were never committed to git
  - Root `.gitignore` lines 18-19 already exclude `.env` and `.env.*` (with exceptions for `.example`)
  - `git check-ignore -v website/.env*` confirms all 3 files are being ignored
  - `git log --all -- website/.env*` shows no commit history for these files
- Files changed:
  - None - existing configuration was already correct
- **Learnings:**
  - Always verify findings with `git ls-files` and `git log --all` before taking action
  - Root `.gitignore` in nullspace properly covers all subpackages (website, mobile, gateway)
  - `git check-ignore -v <file>` shows which `.gitignore` rule is matching a file
  - `VITE_IDENTITY` is a 192-char hex keypair used by `WasmWrapper` for crypto operations

---

## 2026-01-06 - US-004: Add security headers to website nginx.conf

- What was implemented:
  - Added Content-Security-Policy to both nginx.conf (dev) and nginx.ssl.conf (prod)
  - CSP allows: 'self', 'wasm-unsafe-eval', Google Fonts, WebSocket connections
  - Added X-Content-Type-Options: nosniff, X-Frame-Options: DENY, Referrer-Policy
  - HSTS was already in nginx.ssl.conf (max-age=31536000; includeSubDomains; preload)
  - Added Cache-Control headers for static assets with "immutable" for fingerprinted files
- Files changed:
  - `website/nginx.conf` - Added all security headers + cache control
  - `website/nginx.ssl.conf` - Added CSP header + cache control sections
- **Learnings:**
  - `'wasm-unsafe-eval'` is the modern CSP directive for WebAssembly (replaces `'unsafe-eval'`)
  - Vite fingerprints JS/CSS in `/assets/` dir, enabling `immutable` caching (1 year)
  - Dev nginx.conf uses `ws:` in connect-src while prod uses only `wss:` for security
  - nginx `add_header` in location blocks doesn't inherit from parent - must repeat X-Content-Type-Options
  - Google Fonts requires whitelisting both fonts.googleapis.com (CSS) and fonts.gstatic.com (WOFF2 files)

---

## 2026-01-06 - US-005: Fix mobile setState after unmount race

- What was implemented:
  - Added `isMounted` useRef flag to 6 game screens that use InteractionManager.runAfterInteractions
  - Cleanup effect sets `isMounted.current = false` on unmount
  - Guard `if (!isMounted.current) return;` added before setState in InteractionManager callbacks
  - Verified other 4 screens (Baccarat, Craps, Roulette, SicBo) don't have the issue
- Files changed:
  - `mobile/src/screens/games/BlackjackScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/HiLoScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/VideoPokerScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/CasinoWarScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/ThreeCardPokerScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/UltimateTXHoldemScreen.tsx` - Added isMounted ref + guard
- **Learnings:**
  - `InteractionManager.runAfterInteractions()` defers work until animations complete - can fire after unmount
  - Pattern: `const isMounted = useRef(true); useEffect(() => () => { isMounted.current = false }, []);`
  - Check `isMounted.current` before any setState in deferred callbacks
  - React Native useRef doesn't cause re-renders - ideal for tracking mount state
  - Only 6 of 10 game screens used InteractionManager - the others process messages synchronously

---

## 2026-01-06 - US-006: Fix double WebSocket reconnect race

- What was implemented:
  - Added `isReconnectingRef` useRef to websocket.ts to track in-flight connections
  - Guard at start of `connect()` checks ref, logs skip in DEV, returns early if already connecting
  - Clear flag in onopen, onclose, and catch blocks
  - Exposed `isReconnecting` in WebSocketManager interface
  - Updated useWebSocketReconnectOnForeground to check isReconnecting before calling reconnect()
- Files changed:
  - `mobile/src/services/websocket.ts` - Added isReconnectingRef + guards
  - `mobile/src/hooks/useWebSocketReconnectOnForeground.ts` - Check isReconnecting before reconnect
- **Learnings:**
  - Race occurs when: background→foreground trigger + auto-reconnect timeout fire simultaneously
  - Solution: Use ref (not state) to track connection in progress - refs update synchronously
  - Clear flag on both success (onopen) and failure (onclose, catch) paths
  - Expose flag in interface so consumers can check before triggering reconnect
  - Changed console.warn to console.log with __DEV__ guard for cleaner prod logs

---

## 2026-01-06 - US-007: Fix stale balance in useChipBetting hook

- What was implemented:
  - Changed placeChip callback to use `useGameStore.getState().balance`
  - Removed `balance` from useCallback dependency array since it's read synchronously inside
  - This ensures balance check uses current server value, not stale closure
- Files changed:
  - `mobile/src/hooks/useChipBetting.ts` - Fixed balance read in placeChip
- **Learnings:**
  - Zustand's `getState()` returns current store state synchronously (no re-render needed)
  - Using `useStore()` in hook body + closure capture = stale if rapid updates
  - Pattern: For values that must be fresh inside callbacks, use `store.getState().value`
  - This is especially important for financial values like balance where stale checks = overdrafts

---

## 2026-01-06 - US-008: Add bet submission debouncing

- What was implemented:
  - Created new `useBetSubmission` hook to centralize submission debouncing
  - Hook provides: `isSubmitting`, `submitBet(message)`, `clearSubmission()`
  - 5-second timeout fallback re-enables buttons if server doesn't respond
  - Integrated into all 10 game screens (Blackjack, HiLo, VideoPoker, CasinoWar, ThreeCardPoker, UltimateTXHoldem, Baccarat, Roulette, SicBo, Craps)
  - Also fixed websocket.test.tsx to expect console.log instead of console.warn (from US-006 change)
- Files changed:
  - `mobile/src/hooks/useBetSubmission.ts` - New hook created
  - `mobile/src/hooks/index.ts` - Export new hook
  - `mobile/src/screens/games/*.tsx` - All 10 game screens updated
  - `mobile/src/services/__tests__/websocket.test.tsx` - Fixed test expectation
- **Learnings:**
  - Centralized hooks > per-screen state for cross-cutting concerns like submission tracking
  - Pattern: `submitBet()` returns boolean so caller knows if submission was accepted
  - `clearSubmission()` should be called in useEffect when server responds (game_started, game_move, game_result)
  - Timeout fallback is safety net - don't rely on it, but it prevents permanent button disable on network issues
  - Tests matter: the console.log/warn change from US-006 broke a test, caught immediately by running test suite

---

## 2026-01-06 - US-009: Add DEV guards to console statements

- What was implemented:
  - Added `if (__DEV__)` guards to all debug/info console statements in mobile services
  - websocket.ts: 12 console statements wrapped (logs, warns, errors)
  - storage.ts: 2 console.warn statements wrapped (SecureStore auth fallback info)
  - useAppState.ts: 3 console.warn statements wrapped (storage init/persist/restore failures)
  - crypto.ts: 2 console statements wrapped (decryption failure, vault requirement)
  - errorReporter.ts: Left UNCHANGED - the console.error/warn wrapping is intentional telemetry infrastructure
- Files changed:
  - `mobile/src/services/websocket.ts` - 12 __DEV__ guards added
  - `mobile/src/services/storage.ts` - 2 __DEV__ guards added
  - `mobile/src/hooks/useAppState.ts` - 3 __DEV__ guards added
  - `mobile/src/services/crypto.ts` - 2 __DEV__ guards added
- **Learnings:**
  - `__DEV__` is a React Native global that's `true` in development, `false` in production
  - Guards completely remove console calls from production bundle (dead code elimination)
  - Distinguish between debug logging (guard it) vs. error telemetry infrastructure (don't guard it)
  - The pattern `if (__DEV__) { console.x(...) }` is idiomatic in React Native
  - errorReporter.ts wraps console.error/warn to intercept and report - this is infrastructure, not debug logging

---

## 2026-01-06 - US-001: Configure production CORS and backend URLs

- What was implemented:
  - Replaced ambiguous `example.com` placeholder URLs with clearly-named `REPLACE_WITH_YOUR_*` placeholders
  - Added missing `GATEWAY_ORIGIN` config (required for nonce signing)
  - Added `GATEWAY_LIVE_TABLE_CRAPS=1` and admin key file configuration
  - Updated all three production config files (gateway, simulator, ops)
  - Verified all configs pass `scripts/preflight-management.mjs` validation
- Files changed:
  - `configs/production/gateway.env.example` - Added GATEWAY_ORIGIN, replaced BACKEND_URL/ALLOWED_ORIGINS placeholders, added live table config
  - `configs/production/simulator.env.example` - Replaced db/redis/CORS placeholders
  - `configs/production/ops.env.example` - Replaced OPS_ALLOWED_ORIGINS placeholder
- **Learnings:**
  - `.env.example` files should use obviously-fake placeholders that operators MUST replace
  - `GATEWAY_ORIGIN` is the gateway's public URL, used for nonce signing - distinct from `GATEWAY_ALLOWED_ORIGINS`
  - `GATEWAY_LIVE_TABLE_ADMIN_KEY_FILE` must point to hex-encoded Ed25519 key for global table bet signing
  - Preflight script (`scripts/preflight-management.mjs`) validates required keys but not placeholder content
  - Runtime validation in `gateway/src/config/validation.ts` rejects values containing 'example' in production

---

## 2026-01-06 - US-002: Add timeout to website API fetch calls

- What was implemented:
  - Added 10-second AbortController timeout to `explorerClient.ts` getJson() function
  - Created `FetchTimeoutError` custom error class for typed timeout handling
  - Added JSON parsing error handling with user-friendly message
  - Added timeout to `client.js` in 4 locations:
    - `submitTransaction()` - POST transaction submissions
    - `queryState()` - State queries (inside retry loop)
    - `querySeed()` - Seed queries by view (inside retry loop)
    - `queryLatestSeed()` - Latest seed queries
  - All timeouts use consistent `FETCH_TIMEOUT_MS = 10000` constant
- Files changed:
  - `website/src/api/explorerClient.ts` - Added AbortController + FetchTimeoutError + JSON try-catch
  - `website/src/api/client.js` - Added FETCH_TIMEOUT_MS constant, AbortController to 4 fetch calls
- **Learnings:**
  - `AbortController` + `signal` is the standard browser way to timeout fetch requests
  - Always `clearTimeout()` on both success AND error paths to avoid memory leaks
  - In retry loops, create new AbortController per iteration (can't reuse aborted controller)
  - Check `error.name === 'AbortError'` to distinguish timeout from network failure
  - `queryLatestSeed` returns `{ found: false }` on timeout (graceful degradation) while critical paths throw

---

## 2026-01-06 - US-003: Add JSON validation to explorer API responses

- What was implemented:
  - Created `ResponseValidationError` custom error class for typed error handling
  - Implemented 5 type guard functions:
    - `isExplorerBlock()` - validates block fields (height, view, block_digest, tx_hashes, tx_count, indexed_at_ms)
    - `isExplorerTransaction()` - validates tx fields (hash, block_height, position, public_key, nonce, instruction)
    - `isAccountActivity()` - validates account fields (public_key, txs, events)
    - `isBlocksResponse()` - validates paginated blocks list with .every() check
    - `isSearchResponse()` - validates discriminated union by type field
  - Updated all 5 public functions to validate response before returning
  - Each validation failure logs raw response with console.error for debugging
- Files changed:
  - `website/src/api/explorerClient.ts` - Added 94 lines of validation code
- **Learnings:**
  - Type guards (`(data: unknown): data is T`) provide both runtime safety AND TypeScript narrowing
  - For lightweight validation, type guards are preferable to adding Zod/Yup dependencies
  - Pattern: Cast to `Record<string, unknown>` after null/object check for type-safe property access
  - `Array.isArray(obj.blocks) && obj.blocks.every(isExplorerBlock)` validates array contents efficiently
  - Export the error class so consumers can catch `ResponseValidationError` specifically vs other errors

---

## 2026-01-06 - US-004: Add mobile session expiration

- What was implemented:
  - Added `SESSION_CREATED_AT` storage key for persisting session timestamp
  - Added `sessionExpired` state to AuthContext interface
  - Implemented `isSessionExpired()` helper (24-hour threshold via `SESSION_MAX_AGE_MS`)
  - Implemented `clearSessionStorage()` to clean both session keys
  - Added `checkSessionValidity()` callback that validates and clears expired sessions
  - Added AppState listener for foreground detection (checks expiration on resume)
  - Modified `authenticate()` to store timestamp via `setNumber()`
  - Modified `logout()` to use `clearSessionStorage()` instead of single deleteKey
  - Added 3 tests: login stores timestamp, 25h session expires, 12h session stays valid
- Files changed:
  - `mobile/src/services/storage.ts` - Added SESSION_CREATED_AT storage key
  - `mobile/src/context/AuthContext.tsx` - Session expiration logic
  - `mobile/src/context/__tests__/AuthContext.test.tsx` - Added mock functions and expiration tests
- **Learnings:**
  - AppState pattern: `useRef` for previous state + `addEventListener('change')` for transitions
  - `getNumber(..., 0)` returning 0 means "no timestamp" - treat as legacy session, don't expire
  - `useCallback` with no deps for `checkSessionValidity` since it only uses module-level helpers
  - Mock reset in beforeEach needs default return values set AFTER reset

---

## 2026-01-06 - US-005: Setup Sentry error tracking for mobile

- What was implemented:
  - Installed `@sentry/react-native` v7.8.0 via pnpm
  - Added Sentry.init() in App.tsx with conditional prod-only activation
  - Created ErrorFallback component for Sentry.ErrorBoundary
  - Wrapped app content with Sentry.ErrorBoundary (showDialog enabled)
  - Added EXPO_PUBLIC_SENTRY_DSN and EXPO_PUBLIC_ENVIRONMENT to .env.example
  - Configured 10% tracesSampleRate for performance monitoring
- Files changed:
  - `mobile/App.tsx` - Sentry init + ErrorBoundary + fallback UI
  - `mobile/package.json` - Added @sentry/react-native dependency
  - `mobile/.env.example` - Added Sentry env vars
  - `pnpm-lock.yaml` - Updated lockfile
- **Learnings:**
  - `if (SENTRY_DSN && !__DEV__)` pattern ensures no Sentry overhead in development
  - ErrorBoundary `showDialog` prop shows native Sentry crash dialog on error
  - ErrorFallback receives `{ resetError }` prop to allow user retry
  - Sentry requires native linking via `npx pod-install` on iOS (handled by Expo)
  - `environment` tag helps filter prod vs staging errors in Sentry dashboard

---

## 2026-01-06 - US-006: Add bearer auth to Prometheus scrape config

- What was implemented:
  - Added `authorization` block with `credentials_file` to all 4 scrape jobs
  - Added missing `gateway` job targeting port 9010 with `/metrics` path
  - Updated docker-compose to mount `metrics_auth_token` file
  - Added `GATEWAY_METRICS_TARGET` env var for host override
  - Created `metrics_auth_token.example` with generation instructions
  - Added `docker/observability/metrics_auth_token` to `.gitignore`
- Files changed:
  - `docker/observability/prometheus.yml` - Added auth + gateway job
  - `docker/observability/docker-compose.yml` - Added volume mount + env var
  - `docker/observability/metrics_auth_token.example` - Setup instructions
  - `.gitignore` - Exclude secret token file
- **Learnings:**
  - Prometheus uses `credentials_file` not `bearer_token` when token is in a file
  - Token file should contain just the raw token value, no formatting
  - `authorization.type: Bearer` + `credentials_file` is the modern Prometheus auth pattern
  - File-based secrets are more secure than env vars in docker-compose (no shell expansion)
  - All services must share the same METRICS_AUTH_TOKEN value for auth to work

---

## 2026-01-06 - US-007: Add auth service failure alert rules

- What was implemented:
  - Added `auth_health` alert group with 2 new rules
  - AuthServiceFailures: rate of failure/error counters > 0.05 for 5m (severity: critical)
  - AuthSyncFailures: rate of freeroll.sync.failure > 0.05 for 5m (severity: warning)
  - Alerts use regex matching on counter keys: `{key=~".*\\.failure|.*\\.error"}`
- Files changed:
  - `docker/observability/alerts.yml` - Added auth_health group with 2 alert rules
- **Learnings:**
  - Auth service uses counter-based metrics, not HTTP status codes
  - Prometheus regex label matching: `{key=~"pattern"}` not `{key~="pattern"}`
  - Escape dots in regex: `\\.failure` not `.failure` (dot is "any char" in regex)
  - Alert naming convention: `<Service><Problem>` e.g., `AuthServiceFailures`
  - Severity: "critical" for service-level issues, "warning" for degraded functionality

---

## 2026-01-06 - US-008: Fix mobile integration test message type expectations

- What was implemented:
  - Updated 9 game integration tests to use `waitForGameOutcome()` instead of `assertMessageReceived('game_result')`
  - `waitForGameOutcome()` correctly handles both `game_move` and `game_result` message types
  - HiLoTest and RouletteTest were already using correct pattern (passed before fix)
  - CasinoWarTest refactored to use `outcome.type === 'move'` for tie detection instead of try/catch
- Files changed:
  - `mobile/tests/integration/games/BlackjackTest.ts` - 3 methods fixed
  - `mobile/tests/integration/games/CrapsTest.ts` - 4 methods fixed
  - `mobile/tests/integration/games/BaccaratTest.ts` - 4 methods fixed
  - `mobile/tests/integration/games/SicBoTest.ts` - 4 methods fixed
  - `mobile/tests/integration/games/VideoPokerTest.ts` - 4 methods fixed
  - `mobile/tests/integration/games/CasinoWarTest.ts` - 4 methods refactored (tie detection)
  - `mobile/tests/integration/games/ThreeCardTest.ts` - 4 methods fixed
  - `mobile/tests/integration/games/UltimateHoldemTest.ts` - 4 methods fixed (kept game_move for intermediate states)
  - `mobile/tests/integration/.gitignore` - Added to exclude test results
- **Learnings:**
  - Gateway sends `game_move` for atomic games that resolve immediately with state
  - Gateway sends `game_result` for games with explicit end (like fold)
  - `waitForGameOutcome()` uses `Promise.race()` to await either type - already existed in BaseGameTest
  - CasinoWar tie detection: use `outcome.type === 'move'` instead of try/catch timeout pattern
  - Integration tests run via `ts-node tests/integration/runTests.ts` against live gateway

---
