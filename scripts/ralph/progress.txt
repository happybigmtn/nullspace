## Codebase Patterns

- Migrations: Use IF NOT EXISTS
- React: useRef<Timeout | null>(null)
- WebSocket cleanup: useEffect return function
- Code splitting: React.lazy() for routes
- Rust caching: Arc<T> for shared state
- Error handling: ProtocolError subclasses only
- State management: Zustand getState() in callbacks
- Database: CREATE INDEX IF NOT EXISTS
- Rate limiting: gateway/src/session/limiter.ts
- Secrets: SOPS + Age via decrypt-secrets.sh
- Feedback loops: pnpm typecheck && pnpm test && pnpm lint

---

## Progress Log

### 2026-01-08 - Verification Sweep
- Files: scripts/ralph/prd.json
- Decisions: Restructured PRD to use category/description/steps format per Ralph Wiggum best practices
- Blockers: None

Verified 22 stories COMPLETE with codebase evidence. 47 stories remain with `passes: false`.

Priority order for next iterations:
1. US-234 (security) - CSRF protection, security-critical
2. US-229 (infrastructure) - SOPS keys, production-critical
3. US-230 (infrastructure) - Docker limits, production-critical
4. US-228 (api) - Fix HTTP status codes, small focused change
5. US-227 (api) - RFC 7807 errors, architectural decision

Categories by count:
- qa-game: 12
- qa-native: 12
- infrastructure: 3
- operations: 3
- testing: 4
- api: 2
- documentation: 2
- release: 2
- performance: 2
- security: 1
- architecture: 1
- observability: 1

### 2026-01-08 - US-228: Fix incorrect HTTP status codes in auth service
- Files: services/auth/src/server.ts
- Decisions: Changed 502 (Bad Gateway) to appropriate codes:
  - AI endpoints (lines 961, 977): 503 Service Unavailable (upstream AI service unavailable)
  - Internal failures (freeroll sync, checkout, portal, reconcile): 500 Internal Server Error
- Blockers: None. Fixed 6 occurrences (1 more than documented in PRD).

### 2026-01-08 - US-234: Add CSRF protection for cookie-authenticated endpoints
- Files: services/auth/src/server.ts, services/auth/tests/csrf.test.ts, website/src/services/authClient.ts
- Decisions:
  - Used double-submit cookie pattern compatible with @auth/express token format
  - Cookie stores token|SHA256(token+secret), body submits token for verification
  - Applied requireCsrfToken middleware to 8 state-changing endpoints
  - Client helper authFetchWithCsrf auto-fetches and includes CSRF token
  - Used timing-safe comparison to prevent timing attacks on token verification
- Protected endpoints:
  - /profile/link-public-key, /profile/evm-challenge, /profile/link-evm
  - /profile/unlink-evm, /profile/sync-freeroll
  - /billing/checkout, /billing/portal, /billing/reconcile
- Blockers: None. Gateway doesn't need CSRF as it uses WebSocket auth, not cookies.

### 2026-01-08 - US-248: Honor X-Forwarded-For for gateway IP-based limits and metrics
- Files: gateway/src/utils/client-ip.ts, gateway/src/index.ts, gateway/src/middleware/security.ts, gateway/tests/unit/client-ip.test.ts, configs/staging/gateway.env.example, docs/RUNBOOK.md
- Decisions:
  - Created getClientIp() utility with CIDR-based trusted proxy configuration
  - TRUSTED_PROXY_CIDRS env var supports individual IPs, CIDR notation, and shorthands (docker, private, loopback)
  - X-Forwarded-For (standard) checked first, then X-Real-IP (nginx convention)
  - Only IPs matching TRUSTED_PROXY_CIDRS have forwarded headers trusted (prevents spoofing)
  - Falls back to socket.remoteAddress when not behind trusted proxy
- Impact: Connection limiter, session rate limits, and metrics now use real client IP
- Tests: 28 unit tests covering CIDR matching, header extraction, normalization
- Blockers: None. Caddy already sends X-Forwarded-For headers by default.

### 2026-01-08 - US-254: Fix Ralph prompt commands to match repo scripts
- Files: scripts/ralph/prompt.md
- Decisions:
  - Changed `pnpm typecheck` to `pnpm type-check` (matches root package.json)
  - Changed `pnpm test --run` to `pnpm test` (--run flag doesn't exist)
  - Commands appear in both "Startup Sequence" and "Feedback Loops" sections
- Blockers: None. Pre-existing lint/test failures in mobile package unrelated to this change.

### 2026-01-08 - US-251: Make Stripe billing optional in auth service
- Files: services/auth/src/server.ts, services/auth/tests/billing.test.ts, services/auth/.env.example, services/auth/.env.staging.example, services/auth/.env.production.example, docs/RUNBOOK.md
- Decisions:
  - Added AUTH_BILLING_ENABLED flag (defaults to true for backward compatibility)
  - Only require STRIPE_PRICE_TIERS when billing is enabled
  - Added requireBillingEnabled middleware that returns 503 with "billing_disabled" error
  - All three billing endpoints (/billing/checkout, /billing/portal, /billing/reconcile) now guarded
  - Updated all env examples with AUTH_BILLING_ENABLED=1 and documentation
  - Added new section §4.12 to RUNBOOK.md documenting billing configuration
- Tests: 20 unit tests covering isBillingEnabled, parseStripeTierMap, and validateBillingConfig
- Blockers: None. Backward compatible - existing deployments with billing continue to work unchanged.

### 2026-01-08 - US-252: Accept x-metrics-token for gateway metrics (parity with simulator/auth)
- Files: gateway/src/metrics/index.ts, gateway/tests/unit/metrics-auth.test.ts, docs/RUNBOOK.md
- Decisions:
  - Modified requireMetricsAuth() to check both Authorization: Bearer and x-metrics-token headers
  - Simplified auth logic: check both tokens first, then reject only if neither matches
  - Uses timing-safe comparison for both headers (consistent with US-139)
  - Error message updated to mention both auth methods
- Tests: 18 unit tests covering Bearer auth, x-metrics-token auth, parity scenarios, dev/production modes
- Docs: Updated RUNBOOK.md §5.2 (added gateway metrics + header comment) and §7.6 (added x-metrics-token example)
- Blockers: None. Pre-existing mobile lint/test issues unrelated.

### 2026-01-08 - US-249: Fix Caddy CORS headers for auth cookie flows
- Files: infrastructure/staging/Caddyfile, docs/RUNBOOK.md
- Decisions:
  - Removed Access-Control-Allow-Origin: "*" from Caddy for auth, gateway, and indexer services
  - Each upstream service handles its own CORS with specific origin allowlists:
    - Auth: AUTH_ALLOWED_ORIGINS with credentials: true
    - Gateway: GATEWAY_ALLOWED_ORIGINS
    - Simulator: ALLOWED_HTTP_ORIGINS
  - Wildcard origin was breaking credentialed cookie requests (browsers reject credentials with "*")
  - Added detailed comments in Caddyfile explaining why CORS headers must not be overridden
- Docs: Updated RUNBOOK.md §4.2 with reverse proxy CORS guidance
- Blockers: None. Browser auth flow should now work correctly on staging.

### 2026-01-08 - US-230: Add Docker resource limits to production compose
- Files: infrastructure/production/docker-compose.yml (new)
- Decisions:
  - Created production docker-compose based on staging template
  - Resource limits derived from RUNBOOK.md §2.1 Hetzner CPX specs:
    - Simulator: 8 CPU / 14G memory (CPX41)
    - Gateway, Validators: 4 CPU / 7G each (CPX31)
    - Auth: 2 CPU / 3G (CPX21)
    - Website, Caddy: 1 CPU / 256-512M (static serving)
  - Reservations set at ~25% of limits for scheduling guarantees
  - Used 80% of spec memory to leave headroom for OS/overhead
- Blockers: None. File validates with docker compose config.

### 2026-01-08 - US-253: Log warning on super-mode payout saturation
- Files: execution/src/casino/super_mode.rs, docs/RUNBOOK.md
- Decisions:
  - Added `tracing::warn!` to three payout functions when saturation occurs:
    - apply_super_multiplier_cards: Card-based games (Blackjack, Baccarat, Poker)
    - apply_super_multiplier_number: Number-based games (Roulette)
    - apply_super_multiplier_total: Total-based games (Sic Bo, Craps)
  - Warning includes base_payout, total_multiplier, and relevant context
  - Detection tracks intermediate saturation during multiplier stacking
  - Updated test_super_stacking_logs_warning_on_saturation to document new behavior
  - Added RUNBOOK.md §4.13 with alert configuration guidance
- Blockers: None. All 406 execution tests pass.

### 2026-01-08 - US-250: Fail website builds when required VITE_* args missing
- Files: .github/workflows/build-images.yml, docs/RUNBOOK.md
- Decisions:
  - Added validation step in build-images.yml for website builds only
  - Checks VITE_URL, VITE_AUTH_URL, VITE_AUTH_PROXY_URL, VITE_IDENTITY
  - Validation runs on push/tag (not PRs where vars may not be available)
  - Uses `::error::` annotation for clear GitHub Actions error display
  - Documented required variables in RUNBOOK.md §7.3.1 with table format
  - Stripe vars (VITE_STRIPE_*) remain optional
- Rationale: Prevents shipping UIs with localhost defaults that can't connect to real services
- Blockers: None.

### 2026-01-08 - US-255: Align cross-service integration stack with current deployment envs and origin rules
- Files: tests/integration/docker-compose.cross-service.yml, tests/integration/helpers/client.ts, tests/integration/helpers/services.ts, tests/integration/cross-service.test.ts, docs/RUNBOOK.md
- Decisions:
  - Updated docker-compose to use current env vars:
    - GATEWAY_ALLOWED_ORIGINS (replaces deprecated CORS_ORIGINS)
    - GATEWAY_ALLOW_NO_ORIGIN=1 for mobile/native clients
    - AUTH_ALLOWED_ORIGINS for auth service CORS
    - METRICS_AUTH_TOKEN for metrics endpoint auth (parity across services)
    - AUTH_BILLING_ENABLED=0 to disable Stripe in tests
  - Added ClientMode type to CrossServiceClient:
    - 'web' mode: Sends Origin header (browser behavior)
    - 'mobile' mode: No Origin header (native app behavior)
  - Fixed auth endpoint paths: /auth/challenge and /auth/callback/credentials (was incorrect /api/auth/*)
  - Added Origin header tests covering both web and mobile client scenarios
  - Documented in RUNBOOK.md §5.4.1 with required env vars table
- Blockers: None. Pre-existing mobile lint issues unrelated to this change.

### 2026-01-08 - US-258: Fix and validate auth E2E flow (endpoints + CSRF/cookie behavior)
- Files: tests/integration/helpers/client.ts, tests/integration/cross-service.test.ts
- Decisions:
  - Added CookieJar class to CrossServiceClient for managing cookies across requests
  - Added CSRF token fetching via /auth/csrf endpoint (Auth.js standard)
  - Updated authenticate() to:
    - First fetch CSRF token (which also sets CSRF cookie)
    - Use application/x-www-form-urlencoded for Auth.js callback (per convention)
    - Handle redirect responses (302) as success
    - Verify session creation after authentication
  - Added authFetchWithCsrf() helper for CSRF-protected POST requests
  - Added authFetchWithoutCsrf() for testing CSRF rejection
  - Added getSession() to verify session state
  - Created new 'Auth E2E Flow (US-258)' test suite with:
    - CSRF token retrieval tests
    - Full auth flow with CSRF token tests
    - CSRF protection validation (reject without token, accept with token, reject invalid)
    - Session management tests (persistence, clear)
- Tests: 8 new integration tests covering auth flow + CSRF behavior
- Blockers: None. Tests gracefully skip if Convex not available.

