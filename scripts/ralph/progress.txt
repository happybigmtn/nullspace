# Ralph Progress Log
Started: 2026-01-06
Target: Testnet Production

## Codebase Patterns

### Execution Layer (Rust)
- All casino games implement `CasinoGame` trait
- State blob versioning: v2 → v3 → v4 migrations supported
- Deterministic RNG: SHA256 hash-chain from consensus seed
- Event logging: MMR-based append-only with crash recovery
- Tests: 379/379 passing, run with `cargo test`

### Gateway (TypeScript)
- Config validation: `gateway/src/config/validation.ts` rejects placeholders
- CORS: defense-in-depth via `initializeCors()`
- Rate limits: `MAX_CONNECTIONS_PER_IP=200`, `MAX_TOTAL_SESSIONS=20000`
- Metrics: Bearer token auth required on `/metrics`
- Global table: `GATEWAY_LIVE_TABLE_CRAPS=1` enables Craps coordinator

### Mobile (React Native)
- Crypto: Ed25519 signing, PBKDF2 key derivation, AES-GCM storage
- WebSocket: Exponential backoff 1s → 30s, max 10 attempts
- 12 race conditions identified (see US-005 through US-009, US-021-022)
- Tests: 222/222 unit tests, run with `npm test`

### Configuration
- Production configs: `configs/production/*.env.example`
- Staging configs: `configs/staging/*.env.example`
- Preflight validation: `scripts/preflight-management.mjs`
- Bootstrap: `./scripts/bootstrap-testnet.sh` generates node YAML

### Testing Scripts
- Bet coverage: `RUN_INTEGRATION=true pnpm -C gateway exec vitest run tests/all-bet-types.test.ts`
- Soak test: `./scripts/soak-test.sh configs/testnet 4`
- Bot load: `./scripts/run-bots.sh configs/testnet http://<HOST>:8080`
- Global table: `node scripts/load-test-global-table.mjs`

## Key Files
- docs/testnet-readiness-runbook.md - Full deployment checklist
- docs/limits.md - All configurable rate limits
- execution/src/casino/mod.rs - Game dispatch
- gateway/src/config/validation.ts - Config validation
- mobile/src/services/crypto.ts - Crypto implementation

---

## 2026-01-06 - Initial PRD Setup

- Created prd.json with 40 user stories for testnet production
- Stories organized by priority:
  - Priority 1-4: Blocking infrastructure inputs
  - Priority 5-11: Critical mobile race conditions + security
  - Priority 12-15: Integration and load testing
  - Priority 16-20: Monitoring and smoke checks
  - Priority 21-30: Additional fixes and recovery drills
  - Priority 31-40: Documentation, optimization, production build
- **Learnings:**
  - Execution layer is 95% ready (379/379 tests pass)
  - Gateway/Node production-ready with config validation
  - Mobile has 12 race conditions needing fixes
  - Go/No-Go criteria in runbook Section 10

---

## 2026-01-06 - US-002: Generate metrics auth token

- What was implemented:
  - Verified `METRICS_AUTH_TOKEN=SLNmUmUHvNzc+wUagF9aOPGaQBb1DNp8jSG75+Cq5uI=` already set in all 3 production configs (gateway, node, simulator)
  - Generated new secure tokens for remaining placeholders
  - Updated `GATEWAY_LIVE_TABLE_PRESENCE_TOKEN` in gateway.env.example
  - Updated `GLOBAL_TABLE_PRESENCE_TOKEN` in simulator.env.example (same value as gateway for coordination)
  - Updated `SIMULATOR_IDENTITY` in simulator.env.example
- Files changed:
  - `configs/production/gateway.env.example` - line 33: presence token
  - `configs/production/simulator.env.example` - lines 8 (identity) and 44 (presence token)
- **Learnings:**
  - `METRICS_AUTH_TOKEN` must be shared across all services for Prometheus scraping
  - Presence tokens (`GATEWAY_LIVE_TABLE_PRESENCE_TOKEN` / `GLOBAL_TABLE_PRESENCE_TOKEN`) must match for live table coordination
  - `SIMULATOR_IDENTITY` is unique per instance for P2P identification
  - Preflight script validates additional configs beyond just tokens (CORS, admin keys)

---

## 2026-01-06 - US-001: Remove committed .env secrets from website

- What was implemented:
  - VERIFIED FALSE POSITIVE: .env, .env.local, .env.network were never committed to git
  - Root `.gitignore` lines 18-19 already exclude `.env` and `.env.*` (with exceptions for `.example`)
  - `git check-ignore -v website/.env*` confirms all 3 files are being ignored
  - `git log --all -- website/.env*` shows no commit history for these files
- Files changed:
  - None - existing configuration was already correct
- **Learnings:**
  - Always verify findings with `git ls-files` and `git log --all` before taking action
  - Root `.gitignore` in nullspace properly covers all subpackages (website, mobile, gateway)
  - `git check-ignore -v <file>` shows which `.gitignore` rule is matching a file
  - `VITE_IDENTITY` is a 192-char hex keypair used by `WasmWrapper` for crypto operations

---

## 2026-01-06 - US-004: Add security headers to website nginx.conf

- What was implemented:
  - Added Content-Security-Policy to both nginx.conf (dev) and nginx.ssl.conf (prod)
  - CSP allows: 'self', 'wasm-unsafe-eval', Google Fonts, WebSocket connections
  - Added X-Content-Type-Options: nosniff, X-Frame-Options: DENY, Referrer-Policy
  - HSTS was already in nginx.ssl.conf (max-age=31536000; includeSubDomains; preload)
  - Added Cache-Control headers for static assets with "immutable" for fingerprinted files
- Files changed:
  - `website/nginx.conf` - Added all security headers + cache control
  - `website/nginx.ssl.conf` - Added CSP header + cache control sections
- **Learnings:**
  - `'wasm-unsafe-eval'` is the modern CSP directive for WebAssembly (replaces `'unsafe-eval'`)
  - Vite fingerprints JS/CSS in `/assets/` dir, enabling `immutable` caching (1 year)
  - Dev nginx.conf uses `ws:` in connect-src while prod uses only `wss:` for security
  - nginx `add_header` in location blocks doesn't inherit from parent - must repeat X-Content-Type-Options
  - Google Fonts requires whitelisting both fonts.googleapis.com (CSS) and fonts.gstatic.com (WOFF2 files)

---

## 2026-01-06 - US-005: Fix mobile setState after unmount race

- What was implemented:
  - Added `isMounted` useRef flag to 6 game screens that use InteractionManager.runAfterInteractions
  - Cleanup effect sets `isMounted.current = false` on unmount
  - Guard `if (!isMounted.current) return;` added before setState in InteractionManager callbacks
  - Verified other 4 screens (Baccarat, Craps, Roulette, SicBo) don't have the issue
- Files changed:
  - `mobile/src/screens/games/BlackjackScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/HiLoScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/VideoPokerScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/CasinoWarScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/ThreeCardPokerScreen.tsx` - Added isMounted ref + guard
  - `mobile/src/screens/games/UltimateTXHoldemScreen.tsx` - Added isMounted ref + guard
- **Learnings:**
  - `InteractionManager.runAfterInteractions()` defers work until animations complete - can fire after unmount
  - Pattern: `const isMounted = useRef(true); useEffect(() => () => { isMounted.current = false }, []);`
  - Check `isMounted.current` before any setState in deferred callbacks
  - React Native useRef doesn't cause re-renders - ideal for tracking mount state
  - Only 6 of 10 game screens used InteractionManager - the others process messages synchronously

---

## 2026-01-06 - US-006: Fix double WebSocket reconnect race

- What was implemented:
  - Added `isReconnectingRef` useRef to websocket.ts to track in-flight connections
  - Guard at start of `connect()` checks ref, logs skip in DEV, returns early if already connecting
  - Clear flag in onopen, onclose, and catch blocks
  - Exposed `isReconnecting` in WebSocketManager interface
  - Updated useWebSocketReconnectOnForeground to check isReconnecting before calling reconnect()
- Files changed:
  - `mobile/src/services/websocket.ts` - Added isReconnectingRef + guards
  - `mobile/src/hooks/useWebSocketReconnectOnForeground.ts` - Check isReconnecting before reconnect
- **Learnings:**
  - Race occurs when: background→foreground trigger + auto-reconnect timeout fire simultaneously
  - Solution: Use ref (not state) to track connection in progress - refs update synchronously
  - Clear flag on both success (onopen) and failure (onclose, catch) paths
  - Expose flag in interface so consumers can check before triggering reconnect
  - Changed console.warn to console.log with __DEV__ guard for cleaner prod logs

---

## 2026-01-06 - US-007: Fix stale balance in useChipBetting hook

- What was implemented:
  - Changed placeChip callback to use `useGameStore.getState().balance`
  - Removed `balance` from useCallback dependency array since it's read synchronously inside
  - This ensures balance check uses current server value, not stale closure
- Files changed:
  - `mobile/src/hooks/useChipBetting.ts` - Fixed balance read in placeChip
- **Learnings:**
  - Zustand's `getState()` returns current store state synchronously (no re-render needed)
  - Using `useStore()` in hook body + closure capture = stale if rapid updates
  - Pattern: For values that must be fresh inside callbacks, use `store.getState().value`
  - This is especially important for financial values like balance where stale checks = overdrafts

---

## 2026-01-06 - US-008: Add bet submission debouncing

- What was implemented:
  - Created new `useBetSubmission` hook to centralize submission debouncing
  - Hook provides: `isSubmitting`, `submitBet(message)`, `clearSubmission()`
  - 5-second timeout fallback re-enables buttons if server doesn't respond
  - Integrated into all 10 game screens (Blackjack, HiLo, VideoPoker, CasinoWar, ThreeCardPoker, UltimateTXHoldem, Baccarat, Roulette, SicBo, Craps)
  - Also fixed websocket.test.tsx to expect console.log instead of console.warn (from US-006 change)
- Files changed:
  - `mobile/src/hooks/useBetSubmission.ts` - New hook created
  - `mobile/src/hooks/index.ts` - Export new hook
  - `mobile/src/screens/games/*.tsx` - All 10 game screens updated
  - `mobile/src/services/__tests__/websocket.test.tsx` - Fixed test expectation
- **Learnings:**
  - Centralized hooks > per-screen state for cross-cutting concerns like submission tracking
  - Pattern: `submitBet()` returns boolean so caller knows if submission was accepted
  - `clearSubmission()` should be called in useEffect when server responds (game_started, game_move, game_result)
  - Timeout fallback is safety net - don't rely on it, but it prevents permanent button disable on network issues
  - Tests matter: the console.log/warn change from US-006 broke a test, caught immediately by running test suite

---
