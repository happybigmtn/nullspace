## Codebase Patterns

- Migrations: Use IF NOT EXISTS
- React: useRef<Timeout | null>(null)
- WebSocket cleanup: useEffect return function
- Code splitting: React.lazy() for routes
- Rust caching: Arc<T> for shared state
- Error handling: ProtocolError subclasses only
- State management: Zustand getState() in callbacks
- Database: CREATE INDEX IF NOT EXISTS
- Rate limiting: gateway/src/session/limiter.ts
- Secrets: SOPS + Age via decrypt-secrets.sh
- Feedback loops: pnpm typecheck && pnpm test && pnpm lint

---

## Progress Log

### 2026-01-08 - Verification Sweep
- Files: scripts/ralph/prd.json
- Decisions: Restructured PRD to use category/description/steps format per Ralph Wiggum best practices
- Blockers: None

Verified 22 stories COMPLETE with codebase evidence. 47 stories remain with `passes: false`.

Priority order for next iterations:
1. US-234 (security) - CSRF protection, security-critical
2. US-229 (infrastructure) - SOPS keys, production-critical
3. US-230 (infrastructure) - Docker limits, production-critical
4. US-228 (api) - Fix HTTP status codes, small focused change
5. US-227 (api) - RFC 7807 errors, architectural decision

Categories by count:
- qa-game: 12
- qa-native: 12
- infrastructure: 3
- operations: 3
- testing: 4
- api: 2
- documentation: 2
- release: 2
- performance: 2
- security: 1
- architecture: 1
- observability: 1

### 2026-01-08 - US-228: Fix incorrect HTTP status codes in auth service
- Files: services/auth/src/server.ts
- Decisions: Changed 502 (Bad Gateway) to appropriate codes:
  - AI endpoints (lines 961, 977): 503 Service Unavailable (upstream AI service unavailable)
  - Internal failures (freeroll sync, checkout, portal, reconcile): 500 Internal Server Error
- Blockers: None. Fixed 6 occurrences (1 more than documented in PRD).

### 2026-01-08 - US-234: Add CSRF protection for cookie-authenticated endpoints
- Files: services/auth/src/server.ts, services/auth/tests/csrf.test.ts, website/src/services/authClient.ts
- Decisions:
  - Used double-submit cookie pattern compatible with @auth/express token format
  - Cookie stores token|SHA256(token+secret), body submits token for verification
  - Applied requireCsrfToken middleware to 8 state-changing endpoints
  - Client helper authFetchWithCsrf auto-fetches and includes CSRF token
  - Used timing-safe comparison to prevent timing attacks on token verification
- Protected endpoints:
  - /profile/link-public-key, /profile/evm-challenge, /profile/link-evm
  - /profile/unlink-evm, /profile/sync-freeroll
  - /billing/checkout, /billing/portal, /billing/reconcile
- Blockers: None. Gateway doesn't need CSRF as it uses WebSocket auth, not cookies.

### 2026-01-08 - US-248: Honor X-Forwarded-For for gateway IP-based limits and metrics
- Files: gateway/src/utils/client-ip.ts, gateway/src/index.ts, gateway/src/middleware/security.ts, gateway/tests/unit/client-ip.test.ts, configs/staging/gateway.env.example, docs/RUNBOOK.md
- Decisions:
  - Created getClientIp() utility with CIDR-based trusted proxy configuration
  - TRUSTED_PROXY_CIDRS env var supports individual IPs, CIDR notation, and shorthands (docker, private, loopback)
  - X-Forwarded-For (standard) checked first, then X-Real-IP (nginx convention)
  - Only IPs matching TRUSTED_PROXY_CIDRS have forwarded headers trusted (prevents spoofing)
  - Falls back to socket.remoteAddress when not behind trusted proxy
- Impact: Connection limiter, session rate limits, and metrics now use real client IP
- Tests: 28 unit tests covering CIDR matching, header extraction, normalization
- Blockers: None. Caddy already sends X-Forwarded-For headers by default.

### 2026-01-08 - US-254: Fix Ralph prompt commands to match repo scripts
- Files: scripts/ralph/prompt.md
- Decisions:
  - Changed `pnpm typecheck` to `pnpm type-check` (matches root package.json)
  - Changed `pnpm test --run` to `pnpm test` (--run flag doesn't exist)
  - Commands appear in both "Startup Sequence" and "Feedback Loops" sections
- Blockers: None. Pre-existing lint/test failures in mobile package unrelated to this change.

### 2026-01-08 - US-251: Make Stripe billing optional in auth service
- Files: services/auth/src/server.ts, services/auth/tests/billing.test.ts, services/auth/.env.example, services/auth/.env.staging.example, services/auth/.env.production.example, docs/RUNBOOK.md
- Decisions:
  - Added AUTH_BILLING_ENABLED flag (defaults to true for backward compatibility)
  - Only require STRIPE_PRICE_TIERS when billing is enabled
  - Added requireBillingEnabled middleware that returns 503 with "billing_disabled" error
  - All three billing endpoints (/billing/checkout, /billing/portal, /billing/reconcile) now guarded
  - Updated all env examples with AUTH_BILLING_ENABLED=1 and documentation
  - Added new section ยง4.12 to RUNBOOK.md documenting billing configuration
- Tests: 20 unit tests covering isBillingEnabled, parseStripeTierMap, and validateBillingConfig
- Blockers: None. Backward compatible - existing deployments with billing continue to work unchanged.

### 2026-01-08 - US-252: Accept x-metrics-token for gateway metrics (parity with simulator/auth)
- Files: gateway/src/metrics/index.ts, gateway/tests/unit/metrics-auth.test.ts, docs/RUNBOOK.md
- Decisions:
  - Modified requireMetricsAuth() to check both Authorization: Bearer and x-metrics-token headers
  - Simplified auth logic: check both tokens first, then reject only if neither matches
  - Uses timing-safe comparison for both headers (consistent with US-139)
  - Error message updated to mention both auth methods
- Tests: 18 unit tests covering Bearer auth, x-metrics-token auth, parity scenarios, dev/production modes
- Docs: Updated RUNBOOK.md ยง5.2 (added gateway metrics + header comment) and ยง7.6 (added x-metrics-token example)
- Blockers: None. Pre-existing mobile lint/test issues unrelated.

### 2026-01-08 - US-249: Fix Caddy CORS headers for auth cookie flows
- Files: infrastructure/staging/Caddyfile, docs/RUNBOOK.md
- Decisions:
  - Removed Access-Control-Allow-Origin: "*" from Caddy for auth, gateway, and indexer services
  - Each upstream service handles its own CORS with specific origin allowlists:
    - Auth: AUTH_ALLOWED_ORIGINS with credentials: true
    - Gateway: GATEWAY_ALLOWED_ORIGINS
    - Simulator: ALLOWED_HTTP_ORIGINS
  - Wildcard origin was breaking credentialed cookie requests (browsers reject credentials with "*")
  - Added detailed comments in Caddyfile explaining why CORS headers must not be overridden
- Docs: Updated RUNBOOK.md ยง4.2 with reverse proxy CORS guidance
- Blockers: None. Browser auth flow should now work correctly on staging.

