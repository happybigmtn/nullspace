{
  "auditName": "testnet-readiness-audit",
  "generatedAt": "2026-01-08",
  "source": [
    "docs/masterreview.md",
    "review.md",
    "docs/testnet-readiness-runbook.md",
    "docs/testnet-runbook.md",
    "docs/SERVERS.md",
    "infrastructure/staging/Caddyfile",
    "infrastructure/staging/docker-compose.yml",
    "configs/staging/gateway.env.example",
    "configs/staging/simulator.env.example",
    "configs/testnet/peers.yaml",
    "scripts/preflight-management.mjs",
    "docs/observability.md",
    "docs/RUNBOOK.md"
  ],
  "userStories": [
    {
      "id": "TN-001",
      "title": "Fix simulator update indexing failures and missing tx_count",
      "acceptanceCriteria": [
        "Root-cause and resolve update indexing failures reported in docs/masterreview.md",
        "After /submit, explorer shows tx_count > 0 for recent blocks",
        "nullspace_simulator_update_index_failures_total stays at 0 during 10+ min local run",
        "Add a regression test or diagnostic runbook step to catch this failure"
      ],
      "priority": 1,
      "severity": "P0",
      "passes": false,
      "notes": "Masterreview logs show update_index_failures_total=268 and explorer tx_count=0; treat as a consensus/explorer correctness blocker."
    },
    {
      "id": "TN-002",
      "title": "Unblock global table rounds (roundId stuck at 0)",
      "acceptanceCriteria": [
        "Fix gateway live-table so rounds advance when GATEWAY_LIVE_TABLE_CRAPS=1",
        "Load-test script shows >0 rounds and bets settle",
        "Update review.md to mark the issue resolved"
      ],
      "priority": 2,
      "severity": "P0",
      "passes": false,
      "notes": "review.md lists global table rounds never opened during load/soak; this blocks craps global table on testnet."
    },
    {
      "id": "TN-003",
      "title": "Align validator count and peer config with staging/testnet infrastructure",
      "acceptanceCriteria": [
        "Decide on N=3 or N=4 validators for testnet",
        "Update configs/testnet/peers.yaml (and hosts.yaml if used) to real IPs/ports",
        "Update infrastructure/staging/docker-compose.yml to match chosen N",
        "Update docs/SERVERS.md and docs/testnet-runbook.md to reflect the final validator count"
      ],
      "priority": 3,
      "severity": "P0",
      "passes": false,
      "notes": "Runbook uses NODES=4, but staging compose and server inventory list only 3 validators."
    },
    {
      "id": "TN-004",
      "title": "Remove wildcard CORS headers in staging Caddyfile",
      "acceptanceCriteria": [
        "Replace Access-Control-Allow-Origin '*' in infrastructure/staging/Caddyfile",
        "Ensure CORS/origin allowlists are enforced by gateway/simulator/auth",
        "Confirm native client behavior preserved via ALLOW_NO_ORIGIN flags"
      ],
      "priority": 4,
      "severity": "P0",
      "passes": false,
      "notes": "Caddyfile currently sets '*' for auth/gateway/indexer; conflicts with runbook allowlist requirements."
    },
    {
      "id": "TN-005",
      "title": "Enforce metrics auth on all public endpoints",
      "acceptanceCriteria": [
        "Set METRICS_AUTH_TOKEN for simulator, auth, validators, and gateway if exposed",
        "Prometheus config uses x-metrics-token or Authorization header",
        "Verify /metrics endpoints return 401/403 without token"
      ],
      "priority": 5,
      "severity": "P0",
      "passes": false,
      "notes": "docs/observability.md and testnet-readiness-runbook require metrics auth; staging examples are missing tokens."
    },
    {
      "id": "TN-006",
      "title": "Verify nonce persistence and replay protection",
      "acceptanceCriteria": [
        "Gateway uses persistent GATEWAY_DATA_DIR on disk",
        "Convex nonce store is reachable and survives restart",
        "Restart gateway and auth and confirm no replay of previous sessions"
      ],
      "priority": 6,
      "severity": "P0",
      "passes": false,
      "notes": "Runbook calls out nonce persistence; fallback to in-memory nonces is unsafe for testnet."
    },
    {
      "id": "TN-007",
      "title": "Update staging gateway env example with required production keys",
      "acceptanceCriteria": [
        "configs/staging/gateway.env.example includes GATEWAY_ORIGIN",
        "configs/staging/gateway.env.example includes GATEWAY_ALLOWED_ORIGINS",
        "Document GATEWAY_ALLOW_NO_ORIGIN for native clients",
        "preflight-management.mjs passes for gateway in production mode"
      ],
      "priority": 10,
      "severity": "P1",
      "passes": false
    },
    {
      "id": "TN-008",
      "title": "Update staging simulator env example with metrics auth + NODE_ENV",
      "acceptanceCriteria": [
        "configs/staging/simulator.env.example includes METRICS_AUTH_TOKEN",
        "configs/staging/simulator.env.example sets NODE_ENV=production",
        "Document WS_SEND_TIMEOUT_MS and rate limit expectations"
      ],
      "priority": 11,
      "severity": "P1",
      "passes": false
    },
    {
      "id": "TN-009",
      "title": "Make testnet peer config safe-by-default",
      "acceptanceCriteria": [
        "configs/testnet/peers.yaml is clearly marked as a template or replaced by peers.yaml.example",
        "Prevent shipping 127.0.0.1 addresses in testnet configs",
        "Runbook includes a check that peers are public IPs before launch"
      ],
      "priority": 12,
      "severity": "P1",
      "passes": false
    },
    {
      "id": "TN-010",
      "title": "Run the full testnet readiness checklist and record results",
      "acceptanceCriteria": [
        "Execute bet coverage test (87/87) against staging gateway",
        "Run soak, bot load, and global table fanout tests",
        "Run scripts/check-slo.mjs and meet baseline SLOs",
        "Attach results to a dated report or update docs/testnet-readiness-runbook.md"
      ],
      "priority": 13,
      "severity": "P1",
      "passes": false
    },
    {
      "id": "TN-011",
      "title": "Backups and restore drills for Convex and explorer persistence",
      "acceptanceCriteria": [
        "Document backup procedure for Convex and explorer summaries",
        "Run at least one restore drill in staging",
        "Define and record RPO/RTO targets"
      ],
      "priority": 14,
      "severity": "P1",
      "passes": false
    },
    {
      "id": "TN-012",
      "title": "Harden security headers at the edge",
      "acceptanceCriteria": [
        "Add CSP, Referrer-Policy, Permissions-Policy where appropriate",
        "Ensure headers are consistent across website/auth/gateway/indexer",
        "Verify no conflicts with WASM/WebSocket usage"
      ],
      "priority": 15,
      "severity": "P2",
      "passes": false
    },
    {
      "id": "TN-013",
      "title": "Preflight env checks required in deploy workflows",
      "acceptanceCriteria": [
        "Run scripts/preflight-management.mjs in CI or deploy pipeline",
        "Block deployment on missing critical envs",
        "Store preflight output alongside deployment artifacts"
      ],
      "priority": 16,
      "severity": "P2",
      "passes": false
    },
    {
      "id": "TN-014",
      "title": "Finalize auth/Stripe/AI config for testnet",
      "acceptanceCriteria": [
        "Set STRIPE_PRICE_TIERS and STRIPE_PRICE_ID for testnet",
        "Set AI_STRATEGY_DISABLED=1 unless Gemini keys are provisioned",
        "Verify Auth service health and billing endpoints with test credentials"
      ],
      "priority": 17,
      "severity": "P2",
      "passes": false
    },
    {
      "id": "TN-015",
      "title": "Mobile vault-only login validation on iOS + Android",
      "acceptanceCriteria": [
        "Run vault-only signup and recovery key export/import on iOS",
        "Run vault-only signup and recovery key export/import on Android",
        "Confirm VITE_ALLOW_LEGACY_KEYS=0 and VITE_ENABLE_SIMULATOR_PASSKEYS=0"
      ],
      "priority": 18,
      "severity": "P2",
      "passes": false
    },
    {
      "id": "TN-016",
      "title": "Alerting configuration validated end-to-end",
      "acceptanceCriteria": [
        "Alertmanager configured with real Slack/PagerDuty endpoints",
        "Send a test alert and verify routing",
        "Document on-call escalation path in docs/RUNBOOK.md"
      ],
      "priority": 19,
      "severity": "P2",
      "passes": false
    }
  ]
}
