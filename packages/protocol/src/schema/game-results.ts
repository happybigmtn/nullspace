/**
 * Game result message format validation schemas.
 *
 * These schemas define the structure of game result data sent from the gateway
 * to mobile clients. The gateway parses JSON logs generated by the Rust execution
 * layer and merges them into the game_result response.
 *
 * Key insight: The Rust execution layer (execution/src/casino/*.rs) generates
 * detailed JSON logs for each game completion. The gateway (gateway/src/handlers/base.ts)
 * parses these logs via parseGameLog() and includes them in the response.
 */

import { z } from 'zod';

// =============================================================================
// COMMON SCHEMAS
// =============================================================================

/**
 * Resolved bet entry - shows P&L breakdown for each bet type
 */
export const ResolvedBetSchema = z.object({
  label: z.string(),
  pnl: z.number(),
});

export type ResolvedBet = z.infer<typeof ResolvedBetSchema>;

// =============================================================================
// BLACKJACK GAME RESULT
// =============================================================================

/**
 * Hand status values from Rust (execution/src/casino/blackjack.rs:1393-1399)
 *
 * BLACKJACK status indicates a natural 21 (two cards totaling 21), which pays 3:2.
 * This is different from a regular win with 21 points after hitting, which pays 1:1.
 */
export const BlackjackHandStatusSchema = z.enum([
  'PLAYING',      // Hand still in progress
  'STANDING',     // Player chose to stand
  'BUSTED',       // Hand value exceeded 21
  'BLACKJACK',    // Natural 21 (A + 10-value card in initial deal)
  'SURRENDERED',  // Player surrendered
]);

export type BlackjackHandStatus = z.infer<typeof BlackjackHandStatusSchema>;

/**
 * Player hand data from blackjack game result
 */
export const BlackjackHandSchema = z.object({
  cards: z.array(z.number()),  // Card indices (0-51)
  value: z.number(),           // Hand value (1-21)
  soft: z.boolean(),           // True if ace counts as 11
  status: BlackjackHandStatusSchema,
  bet: z.number(),             // Bet amount for this hand
  return: z.number(),          // Total return (0 = loss, bet = push, >bet = win)
});

export type BlackjackHand = z.infer<typeof BlackjackHandSchema>;

/**
 * Dealer hand data from blackjack game result
 *
 * The `blackjack` field is critical for:
 * 1. Displaying correct outcome UI (natural blackjack vs regular win)
 * 2. Lucky Ladies side bet (200:1 payout requires dealer blackjack)
 * 3. Push determination (player BJ vs dealer BJ = push)
 */
export const BlackjackDealerSchema = z.object({
  cards: z.array(z.number()),  // Card indices (0-51)
  value: z.number(),           // Hand value (1-21)
  blackjack: z.boolean(),      // True if dealer has natural 21 (A + 10-value)
});

export type BlackjackDealer = z.infer<typeof BlackjackDealerSchema>;

/**
 * Complete blackjack game result data from parsed JSON log
 *
 * Generated by: execution/src/casino/blackjack.rs:1486 (generate_blackjack_logs)
 * Parsed by: gateway/src/codec/events.ts (parseGameLog)
 */
export const BlackjackGameResultDataSchema = z.object({
  summary: z.string(),                      // e.g., "P: 21, D: 19"
  netPnl: z.number(),                       // Net profit/loss
  resolvedBets: z.array(ResolvedBetSchema), // Breakdown by bet type
  hands: z.array(BlackjackHandSchema),      // Player hands (1-4 if split)
  dealer: BlackjackDealerSchema,            // Dealer's final hand
  // Side bet fields
  sideBet21Plus3: z.number(),
  sideBet21Plus3Return: z.number(),
  sideBetReturn: z.number(),                // Alias for 21+3 return
  sideBetLuckyLadies: z.number(),
  sideBetLuckyLadiesReturn: z.number(),
  sideBetPerfectPairs: z.number(),
  sideBetPerfectPairsReturn: z.number(),
  sideBetRoyalMatch: z.number(),
  sideBetRoyalMatchReturn: z.number(),
  sideBetBustIt: z.number(),
  sideBetBustItReturn: z.number(),
  totalReturn: z.number(),                  // Total chips returned
});

export type BlackjackGameResultData = z.infer<typeof BlackjackGameResultDataSchema>;

/**
 * Full blackjack game result message (base fields + game-specific data)
 */
export const BlackjackGameResultMessageSchema = z.object({
  type: z.literal('game_result'),
  sessionId: z.string(),
  gameType: z.number(),
  won: z.boolean(),
  push: z.boolean().optional(),
  payout: z.string(),                       // BigInt as string
  finalChips: z.string().optional(),
  balance: z.string().optional(),
  balanceSeq: z.string().optional(),
  message: z.string().optional(),
  // Merged from parseGameLog
  summary: z.string().optional(),
  netPnl: z.number().optional(),
  resolvedBets: z.array(ResolvedBetSchema).optional(),
  hands: z.array(BlackjackHandSchema).optional(),
  dealer: BlackjackDealerSchema.optional(),
  // Side bets
  sideBet21Plus3: z.number().optional(),
  sideBet21Plus3Return: z.number().optional(),
  sideBetReturn: z.number().optional(),
  sideBetLuckyLadies: z.number().optional(),
  sideBetLuckyLadiesReturn: z.number().optional(),
  sideBetPerfectPairs: z.number().optional(),
  sideBetPerfectPairsReturn: z.number().optional(),
  sideBetRoyalMatch: z.number().optional(),
  sideBetRoyalMatchReturn: z.number().optional(),
  sideBetBustIt: z.number().optional(),
  sideBetBustItReturn: z.number().optional(),
  totalReturn: z.number().optional(),
});

export type BlackjackGameResultMessage = z.infer<typeof BlackjackGameResultMessageSchema>;

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

/**
 * Check if any player hand has a natural blackjack (21 with initial 2 cards)
 *
 * Natural blackjack pays 3:2 (or 6:5 at some tables), while regular 21 pays 1:1.
 * This is the key distinction for proper win animation and celebration logic.
 */
export function hasPlayerNaturalBlackjack(result: BlackjackGameResultMessage): boolean {
  if (!result.hands || result.hands.length === 0) return false;
  return result.hands.some(hand => hand.status === 'BLACKJACK');
}

/**
 * Check if dealer has a natural blackjack
 *
 * Dealer blackjack affects:
 * - Main bet outcome (player non-BJ loses, player BJ pushes)
 * - Lucky Ladies side bet (Queen of Hearts pair + dealer BJ pays 200:1)
 */
export function hasDealerNaturalBlackjack(result: BlackjackGameResultMessage): boolean {
  return result.dealer?.blackjack === true;
}

/**
 * Determine the overall outcome for display purposes
 */
export function getBlackjackOutcome(result: BlackjackGameResultMessage): 'blackjack_win' | 'win' | 'push' | 'loss' {
  if (result.push) {
    return 'push';
  }
  if (result.won) {
    // Check if it's a natural blackjack win (better payout, bigger celebration)
    if (hasPlayerNaturalBlackjack(result)) {
      return 'blackjack_win';
    }
    return 'win';
  }
  return 'loss';
}

// =============================================================================
// GENERIC GAME RESULT (base type)
// =============================================================================

/**
 * Base game result message schema - all games share these fields
 */
export const BaseGameResultMessageSchema = z.object({
  type: z.literal('game_result'),
  sessionId: z.string(),
  gameType: z.number(),
  won: z.boolean(),
  push: z.boolean().optional(),
  payout: z.string(),
  finalChips: z.string().optional(),
  balance: z.string().optional(),
  balanceSeq: z.string().optional(),
  message: z.string().optional(),
}).passthrough();  // Allow additional game-specific fields

export type BaseGameResultMessage = z.infer<typeof BaseGameResultMessageSchema>;

// =============================================================================
// GAME MESSAGE UNION TYPE
// =============================================================================

/**
 * Union of all game-specific result message types.
 *
 * Use this type when you need type-safe access to game-specific fields
 * after determining the game type from `gameType` field.
 *
 * Example:
 * ```typescript
 * const msg: GameResultMessage = parseMessage(raw);
 * if (msg.gameType === GameType.Blackjack) {
 *   // TypeScript knows this has blackjack-specific fields
 *   const bjMsg = msg as BlackjackGameResultMessage;
 *   if (hasPlayerNaturalBlackjack(bjMsg)) {
 *     showBigCelebration();
 *   }
 * }
 * ```
 */
export type GameResultMessage =
  | BlackjackGameResultMessage
  | BaseGameResultMessage;

/**
 * Parse and validate a raw game result message.
 * Returns the parsed message with proper typing, or null if invalid.
 */
export function parseGameResultMessage(raw: unknown): GameResultMessage | null {
  const result = BaseGameResultMessageSchema.safeParse(raw);
  if (!result.success) {
    return null;
  }
  return result.data;
}

/**
 * Type guard for blackjack game result messages
 */
export function isBlackjackGameResult(msg: GameResultMessage): msg is BlackjackGameResultMessage {
  // GameType.Blackjack = 2
  return msg.gameType === 2 && 'dealer' in msg;
}
