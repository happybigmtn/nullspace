//! CLI tool to export protocol constants to JSON for JS/TS codegen.
//!
//! This binary is the Rust-side of the protocol export tooling described
//! in AC-1.1: "Protocol tags, wire formats, and version constants are
//! defined in Rust and exported to JS/TS."
//!
//! # Usage
//!
//! ```bash
//! # Export to stdout (default)
//! cargo run --bin export_protocol
//!
//! # Export to a file
//! cargo run --bin export_protocol -- --output protocol.json
//!
//! # Compact output (no whitespace)
//! cargo run --bin export_protocol -- --compact
//!
//! # Generate TypeScript types
//! cargo run --bin export_protocol -- --typescript
//! ```
//!
//! # Output
//!
//! By default, outputs pretty-printed JSON containing all protocol constants.
//! With `--typescript`, outputs TypeScript type definitions.
//!
//! # Integration with JS/TS
//!
//! Add this to your JS/TS build pipeline:
//!
//! ```bash
//! cargo run -p protocol-messages --bin export_protocol -- \
//!     --output packages/protocol/generated/protocol.json
//! ```
//!
//! Then import the generated file in your TypeScript:
//!
//! ```typescript
//! import protocol from './generated/protocol.json';
//! const currentVersion = protocol.versions.current;
//! ```

use protocol_messages::exports::{export_json, export_json_compact, ProtocolExports};
use protocol_messages::golden_vectors::{export_golden_vectors_json, export_golden_vectors_json_compact};
use std::env;
use std::fs;
use std::io::{self, Write};

fn main() {
    let args: Vec<String> = env::args().collect();

    let mut output_path: Option<String> = None;
    let mut compact = false;
    let mut typescript = false;
    let mut golden_vectors = false;

    // Parse arguments
    let mut i = 1;
    while i < args.len() {
        match args[i].as_str() {
            "--output" | "-o" => {
                if i + 1 < args.len() {
                    output_path = Some(args[i + 1].clone());
                    i += 2;
                } else {
                    eprintln!("Error: --output requires a path argument");
                    std::process::exit(1);
                }
            }
            "--compact" | "-c" => {
                compact = true;
                i += 1;
            }
            "--typescript" | "-t" => {
                typescript = true;
                i += 1;
            }
            "--golden-vectors" | "-g" => {
                golden_vectors = true;
                i += 1;
            }
            "--help" | "-h" => {
                print_help();
                return;
            }
            arg => {
                eprintln!("Error: Unknown argument: {}", arg);
                print_help();
                std::process::exit(1);
            }
        }
    }

    // Generate output
    let output = if golden_vectors {
        if compact {
            export_golden_vectors_json_compact()
        } else {
            export_golden_vectors_json()
        }
    } else if typescript {
        generate_typescript()
    } else if compact {
        export_json_compact()
    } else {
        export_json()
    };

    // Write output
    match output_path {
        Some(path) => {
            if let Err(e) = fs::write(&path, &output) {
                eprintln!("Error writing to {}: {}", path, e);
                std::process::exit(1);
            }
            eprintln!("Exported protocol constants to {}", path);
        }
        None => {
            if let Err(e) = io::stdout().write_all(output.as_bytes()) {
                eprintln!("Error writing to stdout: {}", e);
                std::process::exit(1);
            }
        }
    }
}

fn print_help() {
    eprintln!(
        r#"export_protocol - Export protocol constants for JS/TS codegen

Usage: export_protocol [OPTIONS]

Options:
  -o, --output <PATH>  Write output to file instead of stdout
  -c, --compact        Output compact JSON (no whitespace)
  -t, --typescript     Output TypeScript type definitions
  -g, --golden-vectors Output golden vectors for encode/decode parity testing (AC-3.2, AC-4.2)
  -h, --help           Show this help message

Examples:
  export_protocol                           # Print JSON to stdout
  export_protocol --compact                 # Print compact JSON
  export_protocol -o protocol.json          # Write to file
  export_protocol --typescript -o types.ts  # Generate TypeScript
  export_protocol --golden-vectors          # Print golden vectors JSON
  export_protocol -g -o vectors.json        # Save golden vectors to file
"#
    );
}

/// Generate TypeScript type definitions from the protocol exports.
fn generate_typescript() -> String {
    let exports = ProtocolExports::canonical();

    format!(
        r#"// Auto-generated by `cargo run -p protocol-messages --bin export_protocol -- --typescript`
// DO NOT EDIT - regenerate from Rust source

/**
 * Schema version for the export format.
 * Bump this when the export structure changes in a breaking way.
 */
export const EXPORT_SCHEMA_VERSION = {schema_version};

/**
 * Protocol version constants.
 */
export const PROTOCOL_VERSIONS = {{
  /** Current protocol version for new messages. */
  CURRENT: {current},
  /** Minimum supported protocol version (inclusive). */
  MINIMUM: {minimum},
  /** Maximum supported protocol version (inclusive). */
  MAXIMUM: {maximum},
}} as const;

/**
 * Size bounds for protocol fields (DoS protection).
 */
export const SIZE_BOUNDS = {{
  MAX_SEATS: {max_seats},
  MAX_ARTIFACT_HASHES: {max_artifact_hashes},
  MAX_REVEAL_CARDS: {max_reveal_cards},
  MAX_REVEAL_DATA_SIZE: {max_reveal_data_size},
  MAX_TIMELOCK_PROOF_SIZE: {max_timelock_proof_size},
  MAX_SIGNATURE_SIZE: {max_signature_size},
  MAX_ARTIFACT_SIZE: {max_artifact_size},
}} as const;

/**
 * Domain separation prefixes for message hashing.
 */
export const DOMAIN_PREFIXES = {{
  DEAL_COMMITMENT: "{deal_commitment}",
  DEAL_COMMITMENT_ACK: "{deal_commitment_ack}",
  REVEAL_SHARE: "{reveal_share}",
  TIMELOCK_REVEAL: "{timelock_reveal}",
  ARTIFACT_REQUEST: "{artifact_request}",
  ARTIFACT_RESPONSE: "{artifact_response}",
  SHUFFLE_CONTEXT: "{shuffle_context}",
}} as const;

/**
 * Reveal phase enum values.
 */
export enum RevealPhase {{
  Preflop = {preflop},
  Flop = {flop},
  Turn = {turn},
  River = {river},
  Showdown = {showdown},
}}

/**
 * Fixed-size field specifications in bytes.
 */
export const FIXED_SIZES = {{
  HASH: {hash_size},
  TABLE_ID: {table_id_size},
  HAND_ID: {hand_id_size},
  TIMESTAMP: {timestamp_size},
  VERSION: {version_size},
  SEAT_INDEX: {seat_index_size},
  DECK_LENGTH: {deck_length_size},
}} as const;

/**
 * Integer encoding rules.
 */
export const INTEGER_ENCODING = {{
  BYTE_ORDER: "{byte_order}",
  U64_SIZE: {u64_size},
  U32_SIZE: {u32_size},
  U16_SIZE: {u16_size},
}} as const;

/**
 * Consensus payload type tags.
 * These identify the type of each message in the consensus-ordered action log.
 */
export const CONSENSUS_PAYLOAD_TAGS = {{
  /** Tag for DealCommitment payloads. */
  DEAL_COMMITMENT: {tag_deal_commitment},
  /** Tag for DealCommitmentAck payloads. */
  DEAL_COMMITMENT_ACK: {tag_deal_commitment_ack},
  /** Tag for GameAction payloads. */
  GAME_ACTION: {tag_game_action},
  /** Tag for RevealShare payloads. */
  REVEAL_SHARE: {tag_reveal_share},
  /** Tag for TimelockReveal payloads. */
  TIMELOCK_REVEAL: {tag_timelock_reveal},
}} as const;

/**
 * Game action type codes.
 * These identify the type of action a player takes during a hand.
 */
export const GAME_ACTION_CODES = {{
  /** Player folds their hand. */
  FOLD: {action_fold},
  /** Player checks (no bet, passes action). */
  CHECK: {action_check},
  /** Player calls the current bet. */
  CALL: {action_call},
  /** Player makes an initial bet. */
  BET: {action_bet},
  /** Player raises the current bet. */
  RAISE: {action_raise},
  /** Player goes all-in. */
  ALL_IN: {action_all_in},
}} as const;

/**
 * Disabled feature tags.
 * These instruction tags are disabled in the current protocol version.
 */
export const DISABLED_FEATURES = {{
  /** Bridge functionality is disabled. */
  BRIDGE_DISABLED: {bridge_disabled},
  /** Liquidity/AMM functionality is disabled. */
  LIQUIDITY_DISABLED: {liquidity_disabled},
  /** Staking functionality is disabled. */
  STAKING_DISABLED: {staking_disabled},
  /** Tag for BridgeWithdraw instruction (DISABLED). */
  TAG_BRIDGE_WITHDRAW: {tag_bridge_withdraw},
  /** Tag for BridgeDeposit instruction (DISABLED). */
  TAG_BRIDGE_DEPOSIT: {tag_bridge_deposit},
  /** Tag for FinalizeBridgeWithdrawal instruction (DISABLED). */
  TAG_FINALIZE_BRIDGE_WITHDRAWAL: {tag_finalize_bridge_withdrawal},
}} as const;

/**
 * Type definitions for protocol structures.
 */
export interface ProtocolVersion {{
  readonly current: number;
  readonly minimum: number;
  readonly maximum: number;
}}

export interface ScopedBinding {{
  tableId: Uint8Array;  // 32 bytes
  handId: bigint;       // u64
  seatOrder: number[];  // u8[]
  deckLength: number;   // u8
}}
"#,
        schema_version = exports.schema_version,
        current = exports.versions.current,
        minimum = exports.versions.minimum,
        maximum = exports.versions.maximum,
        max_seats = exports.size_bounds.max_seats,
        max_artifact_hashes = exports.size_bounds.max_artifact_hashes,
        max_reveal_cards = exports.size_bounds.max_reveal_cards,
        max_reveal_data_size = exports.size_bounds.max_reveal_data_size,
        max_timelock_proof_size = exports.size_bounds.max_timelock_proof_size,
        max_signature_size = exports.size_bounds.max_signature_size,
        max_artifact_size = exports.size_bounds.max_artifact_size,
        deal_commitment = exports.domain_prefixes.deal_commitment,
        deal_commitment_ack = exports.domain_prefixes.deal_commitment_ack,
        reveal_share = exports.domain_prefixes.reveal_share,
        timelock_reveal = exports.domain_prefixes.timelock_reveal,
        artifact_request = exports.domain_prefixes.artifact_request,
        artifact_response = exports.domain_prefixes.artifact_response,
        shuffle_context = exports.domain_prefixes.shuffle_context,
        preflop = exports.reveal_phases.preflop,
        flop = exports.reveal_phases.flop,
        turn = exports.reveal_phases.turn,
        river = exports.reveal_phases.river,
        showdown = exports.reveal_phases.showdown,
        hash_size = exports.wire_formats.fixed_sizes.hash_size,
        table_id_size = exports.wire_formats.fixed_sizes.table_id_size,
        hand_id_size = exports.wire_formats.fixed_sizes.hand_id_size,
        timestamp_size = exports.wire_formats.fixed_sizes.timestamp_size,
        version_size = exports.wire_formats.fixed_sizes.version_size,
        seat_index_size = exports.wire_formats.fixed_sizes.seat_index_size,
        deck_length_size = exports.wire_formats.fixed_sizes.deck_length_size,
        byte_order = exports.wire_formats.integers.byte_order,
        u64_size = exports.wire_formats.integers.u64_size,
        u32_size = exports.wire_formats.integers.u32_size,
        u16_size = exports.wire_formats.integers.u16_size,
        // Consensus payload tags
        tag_deal_commitment = exports.consensus_payload_tags.deal_commitment,
        tag_deal_commitment_ack = exports.consensus_payload_tags.deal_commitment_ack,
        tag_game_action = exports.consensus_payload_tags.game_action,
        tag_reveal_share = exports.consensus_payload_tags.reveal_share,
        tag_timelock_reveal = exports.consensus_payload_tags.timelock_reveal,
        // Game action codes
        action_fold = exports.game_action_codes.fold,
        action_check = exports.game_action_codes.check,
        action_call = exports.game_action_codes.call,
        action_bet = exports.game_action_codes.bet,
        action_raise = exports.game_action_codes.raise_action,
        action_all_in = exports.game_action_codes.all_in,
        // Disabled features
        bridge_disabled = exports.disabled_features.bridge_disabled,
        liquidity_disabled = exports.disabled_features.liquidity_disabled,
        staking_disabled = exports.disabled_features.staking_disabled,
        tag_bridge_withdraw = exports.disabled_features.tag_bridge_withdraw,
        tag_bridge_deposit = exports.disabled_features.tag_bridge_deposit,
        tag_finalize_bridge_withdrawal = exports.disabled_features.tag_finalize_bridge_withdrawal,
    )
}
