# Implementation Plan

**Phase**: Planning
**Date**: 2026-01-19
**Scope**: Sprint breakdown for full Nullspace platform delivery.

## Sprint 01 - Foundations and Local Dev

## Sprint 02 - Core Table Engine and RNG (Single Game)
- [x] Add append-only event log writer and snapshot loader
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.4
  - Tests/backpressure:
    - Programmatic: replay tests in `cargo test -p execution`
  - Perceptual: None
  - **Completed**: Added `round_replay` module with `RoundSnapshot`, `replay_round_from_events`, and 9 unit tests validating deterministic replay at round boundaries
- [x] Expose round/totals/player history query interfaces
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.5
  - Tests/backpressure:
    - Programmatic: integration tests for query API
  - Perceptual: None
  - **Completed**: Added `round_query` module with `RoundStatus`, `RoundTotals`, `PlayerHistory`, `PlayerBetRecord` types and query functions (`query_round_status`, `query_round_totals`, `query_player_history`, `query_player_history_range`, `query_player_rounds`, `query_round`). Integration test validates query API after full round settlement lifecycle (15 total tests).
- [x] Add end-to-end simulator scenario for bet placement and payouts
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.6
  - Tests/backpressure:
    - Programmatic: `cargo test -p nullspace-simulator`
  - Perceptual: None
  - **Completed**: Added `test_e2e_bet_placement_and_payout` test in `nullspace-simulator` crate. Test validates the full global table lifecycle: player registration, deposit, table initialization, round opening, bet submission (Field bets), round lock, reveal, settlement, and finalization. Verifies both players receive proportional payouts matching the deterministic RNG outcome.

## Sprint 03 - Gateway, WebSocket Fanout, and Auth
- [x] Implement WebSocket auth handshake and origin validation
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
  - **Completed**: Added `tests/unit/websocket-auth.test.ts` with 26 tests validating:
    - Origin validation (allowed/disallowed origins, missing origin handling)
    - CORS configuration and headers
    - Crypto-native session auth (secure ID generation, timing-safe comparison)
    - Error response format (RFC 7807 Problem Details)
    - Edge cases (case sensitivity, ports, trailing slashes)
    - Existing implementation in `middleware/security.ts` and `src/index.ts` validated
- [x] Add schema validation for all inbound messages
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.2
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
  - **Completed**: Added `InboundMessageSchema` covering all client-to-server message types (ping, get_balance, submit_raw, faucet_claim, plus all game messages). Updated `handleMessage` to validate ALL inbound messages upfront. Added 58 unit tests for schema validation covering valid messages, invalid payloads, malformed data, and security edge cases (SQL injection attempts, XSS, prototype pollution).
- [x] Implement fanout with backpressure controls
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.3
  - Tests/backpressure:
    - Programmatic: load test harness for simulated clients
  - Perceptual: None
  - **Completed**: Added `BroadcastManager` class (`src/broadcast/manager.ts`) with:
    - Per-client bounded send queues (default 100 messages, configurable)
    - Tail-drop backpressure policy (drops oldest when queue full)
    - Topic-based pub/sub for efficient routing
    - Concurrent flush with configurable parallelism
    - Metrics for queue depth, dropped messages, and delivery rates
    - Load test validates 1,000 clients with 100% delivery rate (97,561 msg/sec)
    - Tests: `pnpm -C gateway test:fanout:1k` (11 tests passing)
- [x] Add per-wallet/IP rate limiting with explicit error responses
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.4
  - Tests/backpressure:
    - Programmatic: gateway integration tests
  - Perceptual: None
  - **Completed**: Added `MessageRateLimiter` class with:
    - Per-session message rate limiting (configurable via GATEWAY_SESSION_RATE_LIMIT_POINTS, GATEWAY_SESSION_RATE_LIMIT_WINDOW_MS, GATEWAY_SESSION_RATE_LIMIT_BLOCK_MS)
    - Explicit `RATE_LIMITED` error code with retryAfter seconds in response
    - Ping messages exempt from rate limiting (keepalive)
    - Session cleanup on disconnect
    - Added 16 unit tests + integration test for rate limit exceed behavior
    - Tests: `pnpm -C gateway test` (142 tests passing)
- [x] Implement engine forwarding with retries and idempotency keys
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.5
  - Tests/backpressure:
    - Programmatic: integration tests for duplicate bet intents
  - Perceptual: None
  - **Completed**: Added `EngineForwarder` class (`src/backend/engine-forwarder.ts`) with:
    - Idempotency key generation and tracking (per-session scoped)
    - Retry logic with exponential backoff (configurable max retries, backoff delays)
    - Duplicate bet intent detection via request hashing
    - Automatic TTL-based cleanup of idempotency entries
    - Session cleanup on disconnect
    - Tests: 38 unit tests + 7 integration tests for duplicate bet intent handling
    - Tests: `pnpm -C gateway test` (187 tests passing)
- [x] Add presence and clock sync broadcasting
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.6
  - Tests/backpressure:
    - Programmatic: end-to-end gateway sync test
  - Perceptual: None
  - **Completed**: Added `PresenceManager` class (`gateway/src/presence/index.ts`) with:
    - Clock sync messages delivered on connect and periodically (configurable via GATEWAY_CLOCK_SYNC_INTERVAL_MS)
    - Presence messages delivered on connect and when users join/leave (configurable via GATEWAY_PRESENCE_INTERVAL_MS)
    - Added `ClockSyncMessageSchema` and `PresenceMessageSchema` to protocol package
    - Integrated presence tracking into gateway connection handler
    - Tests: 23 unit tests + 12 integration tests for sync message validation
    - Tests: `pnpm -C gateway test` (210 tests passing)

## Sprint 04 - Simulator/Indexer and Explorer APIs
- [x] Implement event ingestion pipeline and persistence schema
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.1
  - Tests/backpressure:
    - Programmatic: integration tests for stored rounds
  - Perceptual: None
  - **Completed**: Added `IndexedRound`, `IndexedBet`, and `IndexedPayout` types to `explorer.rs`. Updated `record_event` to track `GlobalTableRoundOpened`, `GlobalTableLocked`, `GlobalTableOutcome`, `GlobalTableFinalized`, `GlobalTableBetAccepted`, and `GlobalTablePlayerSettled` events. Added round/bet/payout maps to `ExplorerState` with LRU retention. Added `ExplorerMetrics` counters for round lifecycle. Integration test (`test_explorer_round_indexing`) validates full round lifecycle indexing.
- [x] Add snapshot replay and log catch-up on indexer startup
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.2
  - Tests/backpressure:
    - Programmatic: restart integration test
  - Perceptual: None
  - **Completed**: Core functionality already existed in `explorer_persistence.rs` with `load_into_sqlite` and `load_into_postgres` functions that load persisted blocks in height order via `apply_block_indexing`. Added `test_indexer_restart_recovery` integration test that validates: (1) blocks are persisted during indexing, (2) on restart the indexer reloads all persisted blocks, (3) state totals match pre-restart values (blocks, transactions, accounts). Test exercises full lifecycle with 3 accounts and 3 blocks.
- [x] Implement explorer HTTP endpoints for rounds, bets, leaderboards
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.3
  - Tests/backpressure:
    - Programmatic: API tests with pagination/filters
  - Perceptual: None
  - **Completed**: Added 5 HTTP endpoints in `explorer.rs`:
    - `GET /explorer/rounds` - List recent rounds with pagination and filters (game_type, phase, player)
    - `GET /explorer/rounds/:game_type/:round_id` - Get specific round with bets and payouts
    - `GET /explorer/rounds/:game_type/:round_id/bets` - Get bets for a round with pagination
    - `GET /explorer/rounds/:game_type/:round_id/payouts` - Get payouts for a round with pagination
    - `GET /explorer/leaderboard` - Player stats with sorting (net_profit, total_wagered, bet_count)
  - All endpoints support caching, pagination (offset/limit), and case-insensitive game_type matching
  - Added `test_explorer_round_endpoints` test with 11 test cases covering pagination, filters, and edge cases
- [x] Add aggregation jobs for volume, house edge, and payouts
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.4
  - Tests/backpressure:
    - Programmatic: unit tests with fixture data
  - Perceptual: None
  - **Completed**: Added aggregation functionality in `explorer.rs`:
    - `AggregatedStats` struct with volume, house edge, house profit, bet/round/player counts, averages, and player win rate
    - `GameStats` struct for per-game breakdown
    - `compute_aggregated_stats()` function for computing metrics from indexed rounds
    - `get_unique_game_types()` helper for listing available games
    - `GET /explorer/stats` HTTP endpoint with query params: game_type, from_height, to_height, breakdown
    - Filters only include finalized rounds for accurate stats
    - 8 unit tests with fixture data validating:
      - Overall stats computation
      - Game type filtering (case-insensitive)
      - Height range filtering
      - Combined filters
      - Empty result handling
      - Non-finalized round exclusion
      - Unique game type extraction
      - Average calculations (bet size, payout per round)
- [ ] Add backfill process for empty storage
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.5
  - Tests/backpressure:
    - Programmatic: integration test on empty DB
  - Perceptual: None
- [ ] Expose health and metrics endpoints
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.6
  - Tests/backpressure:
    - Programmatic: `./scripts/health-check.sh`
  - Perceptual: None

## Sprint 05 - Web Client MVP
- [ ] Implement wallet connect and network status indicators
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
- [ ] Build table view with countdown and phase labels from gateway updates
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.2, AC-PQ.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: AC-PQ.1
- [ ] Implement bet slip, validation, and confirmation flow
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.3
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
- [ ] Render real-time outcomes and totals from WebSocket updates
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.4
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
- [ ] Add fairness verification panel for commit/reveal values
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
- [ ] Ensure keyboard accessibility and visible focus states on bet controls
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.6
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None

## Sprint 06 - Multi-Game Expansion and Compact Encoding v2
- [ ] Implement compact v2 encoding for additional games
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.1
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None
- [ ] Add game registry and per-game configuration loading
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.2
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None
- [ ] Update gateway routing to include game id in subscriptions and bet intents
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.3
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
- [ ] Update indexer schema and APIs to include game identifiers
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.4
  - Tests/backpressure:
    - Programmatic: API tests for per-game queries
  - Perceptual: None
- [ ] Update web client for multi-game UI and routing
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
- [ ] Add regression tests for flagship game outcomes and encoding
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.6
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None

## Sprint 07 - Payments, Treasury, and Admin Ops
- [ ] Implement deposit/withdraw ledger reconciliation against chain state
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.1
  - Tests/backpressure:
    - Programmatic: integration tests for ledger updates
  - Perceptual: None
- [ ] Add house bankroll/exposure tracking and limit checks
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.2
  - Tests/backpressure:
    - Programmatic: unit tests for limit enforcement
  - Perceptual: None
- [ ] Build admin ops endpoints for config updates and audit log entries
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.3
  - Tests/backpressure:
    - Programmatic: API tests for admin auth and audit logging
  - Perceptual: None
- [ ] Implement responsible gaming caps in bet validation
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.4
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None
- [ ] Update web client to show limit errors and exposure warnings
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None

## Sprint 08 - Mobile Client
- [ ] Implement wallet connection and session persistence on mobile
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.1
  - Tests/backpressure:
    - Programmatic: mobile unit tests
  - Perceptual: None
- [ ] Build table view and bet controls optimized for touch
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.2, AC-PQ.2
  - Tests/backpressure:
    - Programmatic: mobile UI tests
  - Perceptual: AC-PQ.2
- [ ] Add WebSocket reconnect strategy and offline detection
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.3
  - Tests/backpressure:
    - Programmatic: integration tests simulating network drop
  - Perceptual: None
- [ ] Add read-only mode with banner messaging
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.4
  - Tests/backpressure:
    - Programmatic: mobile UI tests for offline state
  - Perceptual: None

## Sprint 09 - Production Readiness
- [ ] Add load test harness for gateway and engine
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.1
  - Tests/backpressure:
    - Programmatic: load test report with pass/fail thresholds
  - Perceptual: None
- [ ] Define dashboards and alert thresholds for critical services
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.2
  - Tests/backpressure:
    - Programmatic: dashboard config validation or lint
  - Perceptual: None
- [ ] Write and test disaster recovery runbook using snapshots
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.3
  - Tests/backpressure:
    - Programmatic: recovery drill logs from `scripts/health-check.sh` or runbook script
  - Perceptual: None
- [ ] Add fuzz/property tests for gateway parsing and execution rules
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.4
  - Tests/backpressure:
    - Programmatic: `cargo test` / `pnpm test` includes fuzz targets
  - Perceptual: None
- [ ] Add staging pipeline smoke tests and regression gates
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.5
  - Tests/backpressure:
    - Programmatic: `scripts/agent-review.sh`
  - Perceptual: None

## Missing/Unknown
- None
