# Implementation Plan

**Phase**: Planning
**Date**: 2026-01-19
**Scope**: Sprint breakdown for full Nullspace platform delivery.

## Sprint 01 - Foundations and Local Dev

## Sprint 02 - Core Table Engine and RNG (Single Game)
- [x] Add append-only event log writer and snapshot loader
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.4
  - Tests/backpressure:
    - Programmatic: replay tests in `cargo test -p execution`
  - Perceptual: None
  - **Completed**: Added `round_replay` module with `RoundSnapshot`, `replay_round_from_events`, and 9 unit tests validating deterministic replay at round boundaries
- [x] Expose round/totals/player history query interfaces
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.5
  - Tests/backpressure:
    - Programmatic: integration tests for query API
  - Perceptual: None
  - **Completed**: Added `round_query` module with `RoundStatus`, `RoundTotals`, `PlayerHistory`, `PlayerBetRecord` types and query functions (`query_round_status`, `query_round_totals`, `query_player_history`, `query_player_history_range`, `query_player_rounds`, `query_round`). Integration test validates query API after full round settlement lifecycle (15 total tests).
- [x] Add end-to-end simulator scenario for bet placement and payouts
  - Specs: `specs/sprint-02-core-table-engine.md` AC-2.6
  - Tests/backpressure:
    - Programmatic: `cargo test -p nullspace-simulator`
  - Perceptual: None
  - **Completed**: Added `test_e2e_bet_placement_and_payout` test in `nullspace-simulator` crate. Test validates the full global table lifecycle: player registration, deposit, table initialization, round opening, bet submission (Field bets), round lock, reveal, settlement, and finalization. Verifies both players receive proportional payouts matching the deterministic RNG outcome.

## Sprint 03 - Gateway, WebSocket Fanout, and Auth
- [x] Implement WebSocket auth handshake and origin validation
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
  - **Completed**: Added `tests/unit/websocket-auth.test.ts` with 26 tests validating:
    - Origin validation (allowed/disallowed origins, missing origin handling)
    - CORS configuration and headers
    - Crypto-native session auth (secure ID generation, timing-safe comparison)
    - Error response format (RFC 7807 Problem Details)
    - Edge cases (case sensitivity, ports, trailing slashes)
    - Existing implementation in `middleware/security.ts` and `src/index.ts` validated
- [x] Add schema validation for all inbound messages
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.2
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
  - **Completed**: Added `InboundMessageSchema` covering all client-to-server message types (ping, get_balance, submit_raw, faucet_claim, plus all game messages). Updated `handleMessage` to validate ALL inbound messages upfront. Added 58 unit tests for schema validation covering valid messages, invalid payloads, malformed data, and security edge cases (SQL injection attempts, XSS, prototype pollution).
- [x] Implement fanout with backpressure controls
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.3
  - Tests/backpressure:
    - Programmatic: load test harness for simulated clients
  - Perceptual: None
  - **Completed**: Added `BroadcastManager` class (`src/broadcast/manager.ts`) with:
    - Per-client bounded send queues (default 100 messages, configurable)
    - Tail-drop backpressure policy (drops oldest when queue full)
    - Topic-based pub/sub for efficient routing
    - Concurrent flush with configurable parallelism
    - Metrics for queue depth, dropped messages, and delivery rates
    - Load test validates 1,000 clients with 100% delivery rate (97,561 msg/sec)
    - Tests: `pnpm -C gateway test:fanout:1k` (11 tests passing)
- [x] Add per-wallet/IP rate limiting with explicit error responses
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.4
  - Tests/backpressure:
    - Programmatic: gateway integration tests
  - Perceptual: None
  - **Completed**: Added `MessageRateLimiter` class with:
    - Per-session message rate limiting (configurable via GATEWAY_SESSION_RATE_LIMIT_POINTS, GATEWAY_SESSION_RATE_LIMIT_WINDOW_MS, GATEWAY_SESSION_RATE_LIMIT_BLOCK_MS)
    - Explicit `RATE_LIMITED` error code with retryAfter seconds in response
    - Ping messages exempt from rate limiting (keepalive)
    - Session cleanup on disconnect
    - Added 16 unit tests + integration test for rate limit exceed behavior
    - Tests: `pnpm -C gateway test` (142 tests passing)
- [x] Implement engine forwarding with retries and idempotency keys
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.5
  - Tests/backpressure:
    - Programmatic: integration tests for duplicate bet intents
  - Perceptual: None
  - **Completed**: Added `EngineForwarder` class (`src/backend/engine-forwarder.ts`) with:
    - Idempotency key generation and tracking (per-session scoped)
    - Retry logic with exponential backoff (configurable max retries, backoff delays)
    - Duplicate bet intent detection via request hashing
    - Automatic TTL-based cleanup of idempotency entries
    - Session cleanup on disconnect
    - Tests: 38 unit tests + 7 integration tests for duplicate bet intent handling
    - Tests: `pnpm -C gateway test` (187 tests passing)
- [x] Add presence and clock sync broadcasting
  - Specs: `specs/sprint-03-gateway-fanout.md` AC-3.6
  - Tests/backpressure:
    - Programmatic: end-to-end gateway sync test
  - Perceptual: None
  - **Completed**: Added `PresenceManager` class (`gateway/src/presence/index.ts`) with:
    - Clock sync messages delivered on connect and periodically (configurable via GATEWAY_CLOCK_SYNC_INTERVAL_MS)
    - Presence messages delivered on connect and when users join/leave (configurable via GATEWAY_PRESENCE_INTERVAL_MS)
    - Added `ClockSyncMessageSchema` and `PresenceMessageSchema` to protocol package
    - Integrated presence tracking into gateway connection handler
    - Tests: 23 unit tests + 12 integration tests for sync message validation
    - Tests: `pnpm -C gateway test` (210 tests passing)

## Sprint 04 - Simulator/Indexer and Explorer APIs
- [x] Implement event ingestion pipeline and persistence schema
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.1
  - Tests/backpressure:
    - Programmatic: integration tests for stored rounds
  - Perceptual: None
  - **Completed**: Added `IndexedRound`, `IndexedBet`, and `IndexedPayout` types to `explorer.rs`. Updated `record_event` to track `GlobalTableRoundOpened`, `GlobalTableLocked`, `GlobalTableOutcome`, `GlobalTableFinalized`, `GlobalTableBetAccepted`, and `GlobalTablePlayerSettled` events. Added round/bet/payout maps to `ExplorerState` with LRU retention. Added `ExplorerMetrics` counters for round lifecycle. Integration test (`test_explorer_round_indexing`) validates full round lifecycle indexing.
- [x] Add snapshot replay and log catch-up on indexer startup
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.2
  - Tests/backpressure:
    - Programmatic: restart integration test
  - Perceptual: None
  - **Completed**: Core functionality already existed in `explorer_persistence.rs` with `load_into_sqlite` and `load_into_postgres` functions that load persisted blocks in height order via `apply_block_indexing`. Added `test_indexer_restart_recovery` integration test that validates: (1) blocks are persisted during indexing, (2) on restart the indexer reloads all persisted blocks, (3) state totals match pre-restart values (blocks, transactions, accounts). Test exercises full lifecycle with 3 accounts and 3 blocks.
- [x] Implement explorer HTTP endpoints for rounds, bets, leaderboards
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.3
  - Tests/backpressure:
    - Programmatic: API tests with pagination/filters
  - Perceptual: None
  - **Completed**: Added 5 HTTP endpoints in `explorer.rs`:
    - `GET /explorer/rounds` - List recent rounds with pagination and filters (game_type, phase, player)
    - `GET /explorer/rounds/:game_type/:round_id` - Get specific round with bets and payouts
    - `GET /explorer/rounds/:game_type/:round_id/bets` - Get bets for a round with pagination
    - `GET /explorer/rounds/:game_type/:round_id/payouts` - Get payouts for a round with pagination
    - `GET /explorer/leaderboard` - Player stats with sorting (net_profit, total_wagered, bet_count)
  - All endpoints support caching, pagination (offset/limit), and case-insensitive game_type matching
  - Added `test_explorer_round_endpoints` test with 11 test cases covering pagination, filters, and edge cases
- [x] Add aggregation jobs for volume, house edge, and payouts
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.4
  - Tests/backpressure:
    - Programmatic: unit tests with fixture data
  - Perceptual: None
  - **Completed**: Added aggregation functionality in `explorer.rs`:
    - `AggregatedStats` struct with volume, house edge, house profit, bet/round/player counts, averages, and player win rate
    - `GameStats` struct for per-game breakdown
    - `compute_aggregated_stats()` function for computing metrics from indexed rounds
    - `get_unique_game_types()` helper for listing available games
    - `GET /explorer/stats` HTTP endpoint with query params: game_type, from_height, to_height, breakdown
    - Filters only include finalized rounds for accurate stats
    - 8 unit tests with fixture data validating:
      - Overall stats computation
      - Game type filtering (case-insensitive)
      - Height range filtering
      - Combined filters
      - Empty result handling
      - Non-finalized round exclusion
      - Unique game type extraction
      - Average calculations (bet size, payout per round)
- [x] Add backfill process for empty storage
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.5
  - Tests/backpressure:
    - Programmatic: integration test on empty DB
  - Perceptual: None
  - **Completed**: Added backfill infrastructure in `simulator`:
    - Added `backfill_source_url` and `backfill_max_blocks` config options to `SimulatorConfig`
    - Added `/backfill/blocks` HTTP endpoint in `explorer.rs` returning block metadata for backfill
    - Added `backfill_from_source()` async function in `explorer_persistence.rs` to fetch blocks from remote source
    - Added `is_storage_empty_sqlite()` and `is_storage_empty_postgres()` functions for empty storage detection
    - Added `BackfillResponse` and `BackfillBlock` types for API response format
    - Added `test_backfill_on_empty_storage` integration test validating:
      - Empty storage detection (SQLite)
      - Source simulator indexes blocks correctly
      - Source database persistence works
      - Backfill function handles unreachable source gracefully
      - Backfill endpoint data format is correct
- [x] Expose health and metrics endpoints
  - Specs: `specs/sprint-04-indexer-explorer.md` AC-4.6
  - Tests/backpressure:
    - Programmatic: `./scripts/health-check.sh`
  - Perceptual: None
  - **Completed**: Added comprehensive health endpoints in `simulator/src/api/http.rs`:
    - `GET /healthz` - Basic liveness check (returns `{"ok": true}`)
    - `GET /livez` - Kubernetes liveness probe
    - `GET /readyz` - Kubernetes readiness probe (checks if service is initialized)
    - `GET /health` - Detailed health status with indexed blocks/rounds/accounts, persistence status, fanout/cache enabled, WS connections, and version
    - Existing metrics endpoints preserved: `/metrics/ws`, `/metrics/http`, `/metrics/system`, `/metrics/explorer`, `/metrics/updates`, `/metrics/prometheus`
  - Added `HealthStatus` struct in `lib.rs` with health_status() method on Simulator
  - Updated `scripts/health-check.sh` to test all new health endpoints
  - Added 2 unit tests: `test_health_status` and `test_health_status_with_indexed_data`

## Sprint 05 - Web Client MVP
- [x] Implement wallet connect and network status indicators
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Existing `WalletPill.tsx` and `ConnectionStatus.tsx` components already implement wallet connect and network status with real-time updates:
    - `WalletPill.tsx`: Shows balance (RNG, vUSDT, Credits), connection indicator, vault status, offline detection
    - `ConnectionStatus.tsx`: Real-time status (connected/connecting/offline/error/vault_locked/missing_identity), retry mechanism, vault unlock modal, animated state transitions
    - `useCasinoConnection.ts`: Browser online/offline events, WebSocket state management, vault subscriptions
    - Added 40 unit tests (17 WalletPill + 23 ConnectionStatus) covering all status states, accessibility, and real-time update behavior
    - Updated `vitest.config.ts` to include `src/components/__tests__/**/*.test.{ts,tsx}` pattern
- [x] Build table view with countdown and phase labels from gateway updates
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.2, AC-PQ.1
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: AC-PQ.1
  - **Completed**: Added `useRoundPhase` hook (`website/src/hooks/useRoundPhase.ts`) and `RoundPhaseDisplay` component (`website/src/components/casino/RoundPhaseDisplay.tsx`):
    - `useRoundPhase` hook: Subscribes to gateway round events (`round_opened`, `locked`, `outcome`, `finalized`), tracks phase (BETTING, LOCKED, REVEALING, SETTLING, FINALIZED, IDLE) and countdown, includes server time sync for 250ms accuracy
    - `useServerTimeSync` hook: Calculates server time offset from clock_sync messages
    - `RoundPhaseDisplay` component: Inline phase indicator with countdown timer, urgency styling below threshold, compact mode
    - `TablePhaseHeader` component: Full-width header variant with round ID and larger countdown
    - `formatCountdown` utility: Formats milliseconds to M:SS with ceiling rounding
    - 47 unit tests covering phase labels, countdown display, loading state, accessibility, urgency, compact mode, AC-PQ.1 compliance
- [x] Implement bet slip, validation, and confirmation flow
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.3
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added `BetSlipWithConfirmation` component (`website/src/components/casino/shared/BetSlipWithConfirmation.tsx`) with:
    - Pre-submission validation (balance check, bet amount, game phase, connection status)
    - Confirmation step with countdown timer before submission
    - Clear error state display with retry capability for retryable errors
    - Loading states during validation and submission
    - Typed error codes: INSUFFICIENT_FUNDS, INVALID_AMOUNT, PHASE_LOCKED, CONNECTION_ERROR, SUBMISSION_FAILED, VALIDATION_FAILED
    - Accessibility: ARIA roles, live regions, keyboard navigation
  - Added `useBetSubmission` hook (`website/src/hooks/useBetSubmission.ts`) for submission state management
  - Added `validateBetSlip` pure function for reusable validation logic
  - Tests: 45 BetSlipWithConfirmation tests + 26 validation logic tests (205 total tests passing)
- [x] Render real-time outcomes and totals from WebSocket updates
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.4
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added real-time outcome and settlement display infrastructure:
    - `useRoundOutcome` hook (`website/src/hooks/useRoundOutcome.ts`): Subscribes to `outcome`, `player_settled`, `bet_accepted`, and `finalized` events. Tracks round outcome (dice, totals, RNG data), player settlement (payout, result), pending bets, and recent outcome history. Includes helper functions for bet type labels, amount formatting, and top totals calculation.
    - `RoundOutcomeDisplay` component (`website/src/components/casino/RoundOutcomeDisplay.tsx`): Renders dice faces with dots, dice total, point display (with "Just set" badge), bet totals breakdown (top N by amount), and round info with RNG commit hash.
    - `SettlementResultDisplay` component: Shows win/loss/push result with payout amount, bet count, wagered amount, and updated balance. Uses emerald (win), amber (push), and mono (loss) color schemes.
    - `RoundResultPanel` component: Combined panel showing both outcome and settlement.
    - `useRoundResultDisplay` hook (`website/src/hooks/useRoundResultDisplay.ts`): Integrates `useRoundOutcome` with existing `ResultDisplay` for animated reveals. Auto-shows result on settlement, calculates celebration intensity.
    - Updated `vitest.config.ts` to include `src/hooks/__tests__/**/*.test.{ts,tsx,js,jsx}`
    - 96 new unit tests (54 component + 42 hook) covering dice display, point display, totals breakdown, settlement results, accessibility (role, aria-live, aria-label), helper functions, and AC-5.4 compliance.
- [x] Add fairness verification panel for commit/reveal values
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added `FairnessVerificationPanel` component (`website/src/components/casino/FairnessVerificationPanel.tsx`) with:
    - Collapsible panel showing RNG commit/reveal values with copy buttons
    - Client-side SHA256 verification using WebCrypto API (`website/src/utils/fairnessVerification.ts`)
    - Timing-safe comparison for security
    - Visual verification status (idle/verifying/verified/failed)
    - Explanation text describing commit-reveal scheme
    - Accessibility: aria-labels, aria-expanded, role="region"
    - Tests: 43 unit tests covering component rendering, utility functions, and AC-5.5 compliance
- [x] Ensure keyboard accessibility and visible focus states on bet controls
  - Specs: `specs/sprint-05-web-client-mvp.md` AC-5.6
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added consistent `focus-visible` ring styles to all bet control components:
    - `BetSlipWithConfirmation.tsx`: Added focus-visible:ring-2 + focus-visible:outline-none to Place Bet, Cancel, Confirm, Clear, Remove, Retry, and Dismiss buttons. Primary buttons use ring-offset-2 for visibility.
    - `InlineBetSelector.tsx`: Already had proper focus-visible:ring-2 styles on stepper (+/-) and preset (MIN/1/4/1/2/MAX) buttons.
    - `GameControlBar.tsx`: Added focus-visible:ring-4 to FAB button (primary action), focus-visible:ring-2 to menu toggle, close button, and secondary action buttons. Added role="group" with aria-label to non-classic UI path.
    - Added `KeyboardAccessibility.test.tsx` with 32 tests validating focus-visible patterns, keyboard navigation attributes, and screen reader support across all bet control components.

## Sprint 06 - Multi-Game Expansion and Compact Encoding v2
- [x] Implement compact v2 encoding for additional games
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.1
  - Tests/backpressure:
    - Programmatic: `cargo test -p nullspace-execution`
  - Perceptual: None
  - **Completed**: Added compact v2 encoding for roulette and sic_bo:
    - Core codec framework in `types/src/casino/codec.rs`: `BitWriter`, `BitReader` for LSB-first bitwise I/O, ULEB128 encoding for variable-length amounts, `BetDescriptorV2` with game-specific encode/decode methods
    - Roulette v2 (`execution/src/casino/roulette.rs`): Added `is_v2_payload`, `parse_v2_atomic_batch`, `process_v2_move`. Envelope: version=2, opcode=4. Bet descriptor: 4-bit type + 6-bit value + ULEB128 amount. Achieves 40%+ size reduction.
    - Sic Bo v2 (`execution/src/casino/sic_bo.rs`): Added `is_v2_payload`, `parse_v2_atomic_batch`, `process_v2_move`, `sic_bo_bet_needs_target`. Envelope: version=2, opcode=3. Bet descriptor: 4-bit type + optional 6-bit target + ULEB128 amount. Achieves 40%+ size reduction.
    - Golden vector tests validate exact byte encoding
    - v1/v2 parity tests verify identical outcomes
    - All 480 execution tests pass (including 11 new v2 tests)
- [x] Add game registry and per-game configuration loading
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.2
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None
  - **Completed**: Added `registry` module (`execution/src/casino/registry.rs`) with:
    - `GameRegistry` struct for centralized game management
    - `GameConfig` enum with per-game configuration (10 variants)
    - `GameInfo` struct with display metadata (name, description, category, house edge)
    - `GameCategory` enum (Cards, Table, Poker) for UI grouping
    - Per-game config structs: `BlackjackConfig`, `RouletteConfig`, `SicBoConfig`, `BaccaratConfig`, `CrapsConfig`, `HiLoConfig`, `CasinoWarConfig`, `ThreeCardConfig`, `UltimateHoldemConfig`, `VideoPokerConfig`
    - Variant enums: `RouletteVariant` (European, LaPartage, EnPrison, EnPrisonDouble, American), `SicBoPaytable`, `VideoPokerVariant`
    - Config serialization/deserialization with `to_bytes()`/`from_bytes()` for persistence
    - Active/inactive game filtering
    - 14 unit tests covering registry operations, config roundtrips, and variant handling
    - Tests: `cargo test -p nullspace-execution registry::` (14 tests passing)
- [x] Update gateway routing to include game id in subscriptions and bet intents
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.3
  - Tests/backpressure:
    - Programmatic: `pnpm -C gateway test`
  - Perceptual: None
  - **Completed**: Added game subscription protocol to gateway:
    - Protocol schemas (`packages/protocol/src/schema/mobile.ts`): Added `GameIdSchema` (accepts 0-9 or game names), `SubscribeGameRequestSchema`, `UnsubscribeGameRequestSchema`, `ListSubscriptionsRequestSchema`, and response schemas. Added `gameIdToGameType`, `gameTypeToName`, `getGameSubscriptionTopic` helper functions.
    - BroadcastManager (`gateway/src/broadcast/manager.ts`): Added `getSubscriptions(ws)` method for tracking client subscriptions.
    - Gateway handlers (`gateway/src/index.ts`): Added handlers for `subscribe_game`, `unsubscribe_game`, `list_subscriptions` messages with game-specific topic routing. Integrated cleanup on disconnect and shutdown.
    - Tests: 25 unit tests in `gateway/tests/unit/game-subscriptions.test.ts` covering schema validation, ID conversion, topic generation, topic subscription/unsubscription, topic-based publishing, and game ID routing integration.
    - Tests: `pnpm -C gateway test` (235 tests passing)
- [x] Update indexer schema and APIs to include game identifiers
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.4
  - Tests/backpressure:
    - Programmatic: API tests for per-game queries
  - Perceptual: None
  - **Completed**: Added `game_type` field to `IndexedBet` and `IndexedPayout` structs in `simulator/src/explorer.rs`:
    - Updated event recording for `GlobalTableBetAccepted` and `GlobalTablePlayerSettled` to populate `game_type`
    - Updated test fixture data in `simulator/src/lib.rs` to include `game_type` for all test bets and payouts
    - Added Test 12 to `test_explorer_round_endpoints` verifying `game_type` is correctly set on all indexed bets and payouts
    - All 9 explorer/aggregation tests passing including per-game query filtering
- [x] Update web client for multi-game UI and routing
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added `GameSwitch.test.tsx` with 53 tests validating AC-6.5 compliance:
    - All 10 game types (+ NONE) properly defined in GameType enum
    - CommandPalette displays, filters, and searches all games correctly
    - Mock game state factory covers all game-specific fields (blackjackStack, rouletteZeroRule, crapsBets, etc.)
    - Game-specific view components exist for all 10 games (BlackjackView, RouletteView, CrapsView, etc.)
    - ActiveGame.tsx conditionally renders game-specific layouts based on gameState.type
    - Tests: `pnpm -C website test` (429 tests passing)
- [x] Add regression tests for flagship game outcomes and encoding
  - Specs: `specs/sprint-06-multi-game-encoding.md` AC-6.6
  - Tests/backpressure:
    - Programmatic: `cargo test -p execution`
  - Perceptual: None
  - **Completed**: Added 17 regression tests to `baccarat.rs` covering:
    - Golden encoding vectors for v1 atomic batch (single bet, multi-bet)
    - State blob encoding stability (roundtrip verification)
    - Deterministic outcome verification (seed/session consistency)
    - Payout regression tests (Player win, Banker 6, Tie, Player Pair, Dragon Bonus natural/margin, Panda 8, Perfect Pair)
    - Bet type encoding stability (enum values)
    - Payout multiplier stability (all 16 payout constants)
    - Max bet amount stability (overflow prevention)
    - Full game flow consistency (identical results across multiple runs)
    - Tests: `cargo test -p nullspace-execution regression` (17 tests), all baccarat tests (75 tests), full suite (511 tests)

## Sprint 07 - Payments, Treasury, and Admin Ops
- [x] Implement deposit/withdraw ledger reconciliation against chain state
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.1
  - Tests/backpressure:
    - Programmatic: integration tests for ledger updates
  - Perceptual: None
  - **Completed**: Added ledger reconciliation types and logic:
    - `LedgerEntryType` enum (Deposit, WithdrawalRequest, WithdrawalFulfilled)
    - `ReconciliationStatus` enum (Pending, Verified, Failed)
    - `LedgerEntry` struct with full audit trail (player, amount, chain_ref, timestamps, balance_after, withdrawal_id)
    - `LedgerState` struct for aggregate tracking (total deposits, withdrawal requests, fulfilled, pending count)
    - New Key/Value variants: `LedgerState`, `LedgerEntry(u64)`
    - Updated bridge handlers: `handle_bridge_withdraw`, `handle_bridge_deposit`, `handle_finalize_bridge_withdrawal` to create ledger entries
    - Withdrawal fulfillment transitions entry status from Pending to Verified
    - 5 integration tests in `ledger_integration_tests.rs` validating ledger updates for deposits, withdrawals, and fulfillments
- [x] Add house bankroll/exposure tracking and limit checks
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.2
  - Tests/backpressure:
    - Programmatic: unit tests for limit enforcement
  - Perceptual: None
  - **Completed**: Added house bankroll/exposure tracking with limit enforcement:
    - `HouseBankroll` type (`types/src/casino/economy.rs`): Tracks bankroll, current_exposure, max_exposure_bps, max_single_bet, max_player_exposure, metrics (total_bets_placed, total_amount_wagered, total_payouts)
    - `PlayerExposure` type: Per-player tracking of current_exposure, pending_bet_count, last_bet_ts
    - `ExposureLimitError` enum: SingleBetExceeded, PlayerExposureExceeded, HouseExposureExceeded
    - Key/Value variants: HouseBankroll, PlayerExposure(PublicKey)
    - `check_exposure_limits()`: Validates bet against 3 limits (single bet, player exposure, house exposure)
    - `add_bet_exposure()`, `release_bet_exposure()`: Track exposure lifecycle
    - Integrated into `handle_global_table_submit_bets` and `handle_global_table_settle`
    - 17 unit tests for HouseBankroll and PlayerExposure types
    - Tests: `cargo test -p nullspace-types house_bankroll` (14 tests) + `cargo test -p nullspace-types player_exposure` (3 tests)
- [x] Build admin ops endpoints for config updates and audit log entries
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.3
  - Tests/backpressure:
    - Programmatic: API tests for admin auth and audit logging
  - Perceptual: None
  - **Completed**: Added admin operations infrastructure:
    - `AuditLogEntry` type (`types/src/casino/economy.rs`): Full audit trail with id, action_type, admin pubkey, timestamp, ip_hash (SHA256), before/after state blobs, reason, block_height, request_id
    - `AuditLogState` type: Aggregate tracking (next_entry_id, total_entries, entries_by_type[8])
    - `AdminActionType` enum: UpdateBankrollLimits, UpdateGameConfig, UpdatePolicy, UpdateResponsibleGamingLimits, ToggleBridge, ToggleOracle, EmergencyAction
    - Key/Value variants: AuditLogState (tag 36), AuditLogEntry(u64) (tag 37)
    - `AdminState` struct in Simulator for in-memory admin state caching
    - Admin auth via `ADMIN_AUTH_TOKEN` env var with `admin_auth_error()` helper
    - HTTP endpoints (`simulator/src/api/http.rs`):
      - `GET /admin/state` - Get current admin state (bankroll + policy)
      - `GET /admin/audit-logs` - List audit log entries with pagination (offset/limit)
      - `GET /admin/audit-logs/:id` - Get specific audit log entry
      - `POST /admin/limits/bankroll` - Update house bankroll limits (creates audit entry)
      - `POST /admin/config/policy` - Update policy config (creates audit entry)
    - IP hash extraction from X-Forwarded-For for privacy-preserving audit trail
    - Tests: 4 admin tests (load/save bankroll, load/save policy, audit log creation, multiple entries)
- [x] Implement responsible gaming caps in bet validation
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.4
  - Tests/backpressure:
    - Programmatic: `cargo test -p nullspace-execution`
  - Perceptual: None
  - **Completed**: Added responsible gaming limit enforcement:
    - `ResponsibleGamingConfig` type (`types/src/casino/economy.rs`): System-wide defaults for daily/weekly/monthly wager caps (100K/500K/1.5M), loss caps (50K/200K/500K), self-exclusion periods (1 day min, 1 year max), and cooldown after exclusion
    - `PlayerGamingLimits` type: Per-player caps (can only be stricter than system), rolling period tracking (day/week/month start timestamps and totals), self-exclusion/cooldown timestamps
    - `ResponsibleGamingError` enum: 8 variants (SelfExcluded, InCooldown, DailyWagerCapExceeded, WeeklyWagerCapExceeded, MonthlyWagerCapExceeded, DailyLossCapReached, WeeklyLossCapReached, MonthlyLossCapReached)
    - Key/Value variants: ResponsibleGamingConfig (tag 38), PlayerGamingLimits(PublicKey) (tag 39)
    - Helper methods: `effective_*_cap()` (returns min of player/system cap), `maybe_reset_periods()` (auto-reset on period rollover), `check_limits()` (validates bet against all caps), `record_wager()`, `record_settlement()`
    - Integration: `check_exposure_limits()` now checks responsible gaming limits FIRST; `add_bet_exposure()` records wagers; `release_bet_exposure()` records settlements with net_result
    - 27 unit tests in `types/src/casino/tests.rs` covering defaults, roundtrip encoding, effective caps, period resets, wager/loss cap enforcement, self-exclusion, cooldown, and error variants
    - Tests: `cargo test -p nullspace-types casino::tests` (57 tests), `cargo test -p nullspace-execution` (511 tests)
- [x] Update web client to show limit errors and exposure warnings
  - Specs: `specs/sprint-07-payments-admin.md` AC-7.5
  - Tests/backpressure:
    - Programmatic: `pnpm -C website test`
  - Perceptual: None
  - **Completed**: Added comprehensive limit error and exposure warning display:
    - `limitTypes.ts`: TypeScript types mirroring Rust backend (`ExposureLimitError`, `ResponsibleGamingError`, `ExtendedBetValidationError`), warning level calculation, format helpers, error message generation
    - `LimitErrorDisplay.tsx`: Component for rendering limit errors with color-coded severity (amber for exposure limits, red for severe/exclusion), structured data display (amounts, caps, percentages), progress bars for wager/loss caps, appropriate retry/dismiss actions
    - `ExposureWarningBanner.tsx`: Proactive warning display showing exposure, wager caps, loss caps approaching limits with progress bars, condensed mode for inline display, self-exclusion/cooldown status
    - Updated `index.ts` exports for all new types and components
    - Added Value variant handlers in `website/wasm/src/lib.rs` for LedgerState, LedgerEntry, HouseBankroll, PlayerExposure, AuditLogState, AuditLogEntry, ResponsibleGamingConfig, PlayerGamingLimits
    - Tests: 96 new tests (57 LimitErrorDisplay + 39 ExposureWarningBanner) covering all error types, color schemes, accessibility, condensed mode, AC-7.5 compliance
    - Tests: `npx vitest run` (525 tests passing)

## Sprint 08 - Mobile Client
- [x] Implement wallet connection and session persistence on mobile
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.1
  - Tests/backpressure:
    - Programmatic: mobile unit tests
  - Perceptual: None
  - **Completed**: Added `useWalletConnection` hook (`mobile/src/hooks/useWalletConnection.ts`) providing unified wallet connection interface:
    - Combines vault status, gateway session, and WebSocket connection into single state machine
    - Session persistence via MMKV/SecureStore with `WALLET_PUBLIC_KEY` storage key
    - Status states: disconnected, vault_missing, vault_locked, vault_corrupted, connecting, connected, offline, error
    - Actions: unlockAndConnect, disconnectAndLock, reconnect, refreshBalance
    - Session restoration detection on app restart
  - Added `WalletStatusDisplay` component (`mobile/src/components/ui/WalletStatusDisplay.tsx`):
    - Visual status indicators with color coding (green=connected, yellow=connecting, red=error, gray=offline, purple=vault_locked)
    - Balance display when connected and ready
    - Public key truncation for display
    - Compact mode for inline use
    - Accessibility: button role, labels, hints
    - "Restored" badge for session restoration
  - Added 47 unit tests covering status derivation, persistence logic, unlock/disconnect flows, and AC-8.1 compliance
- [x] Build table view and bet controls optimized for touch
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.2, AC-PQ.2
  - Tests/backpressure:
    - Programmatic: mobile UI tests
  - Perceptual: AC-PQ.2
  - **Completed**: Added `TouchBetControls` component (`mobile/src/components/casino/TouchBetControls.tsx`) with:
    - Explicit touch target constants: MIN=44pt, BUTTON=48pt, CHIP=56pt, FAB=56pt
    - Bottom-aligned layout for one-hand thumb reachability (67% easy reach zone)
    - Responsive scaling for small/medium/large screen breakpoints (320/375/428px)
    - Integration with ChipSelector and ChipPile for complete betting UX
    - Accessibility: roles, labels, hints, state announcements
    - iOS/Android safe area insets for gesture navigation compatibility
    - Added `vitest` test runner to mobile package with 48 tests (45 TouchBetControls + 3 index)
    - Tests validate touch target sizes, accessibility requirements, and AC-PQ.2 compliance
- [x] Add WebSocket reconnect strategy and offline detection
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.3
  - Tests/backpressure:
    - Programmatic: integration tests simulating network drop
  - Perceptual: None
  - **Completed**: Added network-aware WebSocket reconnection infrastructure:
    - `useNetworkStatus` hook (`mobile/src/hooks/useNetworkStatus.ts`): Health check polling (10s interval), threshold-based status transitions (online/unstable/offline at 0/2/5 failures), AppState integration for battery-efficient background handling, debouncing for stable status
    - `useWebSocketReconnect` hook (`mobile/src/hooks/useWebSocketReconnect.ts`): Coordinates WebSocket reconnection with network state, triggers immediate reconnect when network returns, provides countdown timer for next attempt, tracks disconnected duration, exposes reconnectNow/resetAndReconnect actions
    - Combined status states: connected, connecting, reconnecting, offline, failed, disconnected
    - Exponential backoff (1sâ†’30s max) inherited from useWebSocket, network-aware to avoid wasteful retries during outages
    - Tests: 43 integration tests covering network drop scenarios, status derivation, exponential backoff, countdown timer, AC-8.3 compliance
- [x] Add read-only mode with banner messaging
  - Specs: `specs/sprint-08-mobile-client.md` AC-8.4
  - Tests/backpressure:
    - Programmatic: mobile UI tests for offline state
  - Perceptual: None
  - **Completed**: Added read-only mode infrastructure for limited connectivity:
    - `useReadOnlyMode` hook (`mobile/src/hooks/useReadOnlyMode.ts`): Derives read-only state from `useWebSocketReconnect`, provides `isReadOnly`, `canSubmit`, `reason`, human-readable messages, transition tracking for animations, and reconnect actions
    - `ReadOnlyBanner` component (`mobile/src/components/ui/ReadOnlyBanner.tsx`): Persistent banner with color-coded status indicators, pulse ring animation during reconnecting, shake animation on failure, retry/reconnect action buttons, accessibility (alert role, live region, labels)
    - Read-only reasons: 'offline', 'reconnecting', 'failed', 'connecting' (null when connected)
    - Short messages for banner: "Offline - Read Only", "Reconnecting...", "Connection Failed", "Connecting..."
    - Tests: 78 unit tests (41 useReadOnlyMode + 37 ReadOnlyBanner) covering state derivation, message generation, transition tracking, action handlers, accessibility, animation states, and AC-8.4 compliance

## Sprint 09 - Production Readiness
- [x] Add load test harness for gateway and engine
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.1
  - Tests/backpressure:
    - Programmatic: load test report with pass/fail thresholds
  - Perceptual: None
  - **Completed**: Added comprehensive load test harness (`scripts/load-test.sh`) with:
    - Gateway WebSocket stress test (configurable connections, P99 latency targets, success rate thresholds)
    - Engine HTTP API load test (configurable RPS, P99 latency, error rate thresholds)
    - JSON report artifact output (`load-test-report.json`) with pass/fail status
    - CLI options: `--gateway-only`, `--engine-only`, `--quick`, `--report FILE`, `--verbose`
    - Environment variable configuration for all thresholds
    - Graceful handling of unavailable services
    - Added npm scripts: `pnpm load-test`, `pnpm load-test:quick`, `pnpm load-test:gateway`, `pnpm load-test:engine`
    - Gateway-specific scripts: `pnpm -C gateway load-test`, `pnpm -C gateway load-test:1k`
- [x] Define dashboards and alert thresholds for critical services
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.2
  - Tests/backpressure:
    - Programmatic: dashboard config validation or lint
  - Perceptual: None
  - **Completed**: Added observability configuration infrastructure:
    - Copied 3 critical Grafana dashboards from archive: `nullspace-slo.json` (14 panels), `nullspace-simulator.json` (20 panels), `nullspace-gateway.json` (16 panels)
    - Added queue depth panels to simulator dashboard (WebSocket Queue Depth, Queue Full Events)
    - Copied alert rules (16 alerts: 2 critical, 14 warning) covering latency SLOs, error rates, queue backpressure
    - Copied Prometheus config (scrape jobs: simulator, auth, gateway, node) and Alertmanager config (Slack + PagerDuty receivers)
    - Created `scripts/validate-observability.sh` validation script that verifies:
      - JSON syntax for all dashboards
      - Required fields (uid, title, panels) in dashboards
      - AC-9.2 metrics coverage (latency, error rates, queue depth)
      - YAML syntax and structure for alerts (groups, rules, severity labels, annotations)
      - Alert threshold coverage for critical metrics
      - Prometheus scrape config and Alertmanager receivers
    - Tests: `./scripts/validate-observability.sh` (all validations passing)
- [ ] Write and test disaster recovery runbook using snapshots
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.3
  - Tests/backpressure:
    - Programmatic: recovery drill logs from `scripts/health-check.sh` or runbook script
  - Perceptual: None
- [ ] Add fuzz/property tests for gateway parsing and execution rules
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.4
  - Tests/backpressure:
    - Programmatic: `cargo test` / `pnpm test` includes fuzz targets
  - Perceptual: None
- [ ] Add staging pipeline smoke tests and regression gates
  - Specs: `specs/sprint-09-production-readiness.md` AC-9.5
  - Tests/backpressure:
    - Programmatic: `scripts/agent-review.sh`
  - Perceptual: None

## Missing/Unknown
- None
